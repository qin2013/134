<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœ«æ—¥æ±‚ç”Ÿï¼šæ˜Ÿçƒæ¸¸æˆ</title>
    <style>
        :root {
            --danger-color: #c33;
            --warning-color: #cc3;
            --safe-color: #3c3;
            --primary-color: #55f;
            --star-color: #ff0;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background-color: #111;
            color: #eee;
            max-width: 600px;
            margin: 0 auto;
            padding: 10px;
            touch-action: manipulation;
            background-image: radial-gradient(#222 1px, transparent 1px);
            background-size: 15px 15px;
        }
        
        .container {
            display: grid;
            grid-template-areas:
                "header header"
                "stats stats"
                "main main"
                "map actions"
                "inventory inventory"
                "log log";
            gap: 10px;
        }
        
        .header {
            grid-area: header;
            text-align: center;
            border-bottom: 2px solid var(--danger-color);
            padding-bottom: 5px;
            position: relative;
        }
        
        .weather-icon {
            position: absolute;
            right: 10px;
            top: 10px;
            font-size: 24px;
        }
        
        .stats {
            grid-area: stats;
            display: grid;
            grid-template-columns: 1fr 1fr;
            background-color: #222;
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #333;
        }
        
        .stat {
            margin: 5px;
        }
        
        .stat-name {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
        }
        
        .stat-value {
            font-weight: bold;
        }
        
        .health { color: var(--danger-color); }
        .hunger { color: var(--warning-color); }
        .energy { color: var(--safe-color); }
        .infection { color: #c3c; }
        .temperature { color: #3cf; }
        .san { color: #99f; }
        
        .progress-bar {
            height: 8px;
            background-color: #333;
            border-radius: 4px;
            margin-top: 3px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            border-radius: 4px;
        }
        
        .main-area {
            grid-area: main;
            background-color: #222;
            padding: 15px;
            border-radius: 5px;
            min-height: 100px;
            border: 1px solid #333;
            position: relative;
        }
        
        .location-tag {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: #333;
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 12px;
        }
        
        .action-buttons {
            grid-area: actions;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }
        
        .map-container {
            grid-area: map;
            background-color: #222;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #333;
        }
        
        .map-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 5px;
        }
        
        .map-tile {
            aspect-ratio: 1;
            background-color: #333;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .map-tile:active {
            transform: scale(0.95);
        }
        
        .map-tile.current {
            box-shadow: 0 0 0 2px var(--danger-color);
        }
        
        .map-tile.discovered {
            background-color: #444;
        }
        
        .map-tile.undiscovered {
            background-color: #222;
            color: #666;
        }
        
        .btn {
            background-color: #333;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 5px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
            border: 1px solid #444;
        }
        
        .btn:active {
            transform: scale(0.95);
            background-color: var(--primary-color);
        }
        
        .btn-primary {
            background-color: var(--primary-color);
        }
        
        .btn-star {
            background-color: var(--star-color);
            color: #333;
        }
        
        .btn-danger {
            background-color: var(--danger-color);
        }
        
        .btn-warning {
            background-color: var(--warning-color);
            color: #333;
        }
        
        .btn-disabled {
            opacity: 0.5;
            pointer-events: none;
        }
        
        .inventory {
            grid-area: inventory;
            background-color: #222;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #333;
        }
        
        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 8px;
            margin-top: 10px;
        }
        
        .item {
            background-color: #333;
            padding: 8px;
            border-radius: 3px;
            border: 1px solid #444;
            font-size: 13px;
            text-align: center;
        }
        
        .item-count {
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .event-log {
            grid-area: log;
            height: 150px;
            overflow-y: auto;
            background-color: #222;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #333;
            font-size: 13px;
        }
        
        .log-entry {
            margin: 5px 0;
            padding-bottom: 5px;
            border-bottom: 1px solid #333;
            line-height: 1.4;
        }
        
        .log-entry.warning {
            color: var(--warning-color);
        }
        
        .log-entry.danger {
            color: var(--danger-color);
            font-weight: bold;
        }
        
        .log-entry.positive {
            color: var(--safe-color);
        }
        
        .log-entry.info {
            color: #99f;
        }
        
        .log-entry.star {
            color: var(--star-color);
            text-shadow: 0 0 5px var(--star-color);
        }
        
        /* æ ‡ç­¾é¡µæ ·å¼ */
        .tabs {
            display: flex;
            margin-bottom: 10px;
            border-bottom: 1px solid #333;
        }
        
        .tab {
            padding: 5px 10px;
            cursor: pointer;
            margin-right: 5px;
            border-radius: 3px 3px 0 0;
        }
        
        .tab.active {
            background-color: #333;
            border: 1px solid #444;
            border-bottom: none;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* æŠ€èƒ½æ ‘æ ·å¼ */
        .skill-tree {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 10px;
        }
        
        .skill {
            background-color: #333;
            padding: 8px;
            border-radius: 5px;
            text-align: center;
            font-size: 12px;
            border: 1px solid #444;
            cursor: pointer;
        }
        
        .skill.learned {
            border-color: var(--safe-color);
            background-color: #334;
        }
        
        .skill.available {
            border-color: var(--star-color);
        }
        
        .skill.unavailable {
            opacity: 0.5;
        }
        
        /* åŸºåœ°å»ºè®¾æ ·å¼ */
        .facilities {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        .facility {
            background-color: #333;
            padding: 8px;
            border-radius: 5px;
            font-size: 12px;
            border: 1px solid #444;
        }
        
        .facility-level {
            color: var(--warning-color);
            font-weight: bold;
        }
        
        /* åˆ¶ä½œé¢æ¿æ ·å¼ */
        .recipes {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        .recipe {
            background-color: #333;
            padding: 8px;
            border-radius: 5px;
            font-size: 12px;
            border: 1px solid #444;
        }
        
        .recipe-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .recipe-materials {
            font-size: 11px;
            color: #999;
            margin-bottom: 5px;
        }
        
        /* çŠ¶æ€æ•ˆæœæ ·å¼ */
        .status-effects {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 10px;
        }
        
        .status-effect {
            background-color: #333;
            padding: 3px 6px;
            border-radius: 3px;
            font-size: 11px;
            border: 1px solid #444;
        }
        
        .effect-buff {
            border-color: var(--safe-color);
        }
        
        .effect-debuff {
            border-color: var(--danger-color);
        }
        
        .effect-star {
            border-color: var(--star-color);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 255, 0, 0.4); }
            70% { box-shadow: 0 0 0 5px rgba(255, 255, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 255, 0, 0); }
        }
        
        /* æ­»äº¡æ¨¡æ€æ¡† */
        .death-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            z-index: 200;
            color: white;
            text-align: center;
            padding-top: 100px;
        }
        
        .death-content {
            background-color: #300;
            max-width: 500px;
            margin: 0 auto;
            padding: 30px;
            border-radius: 10px;
            border: 3px solid var(--danger-color);
        }
        
        .death-title {
            font-size: 32px;
            color: var(--danger-color);
            margin-bottom: 20px;
        }
        
        .death-reason {
            font-size: 18px;
            margin-bottom: 30px;
        }
        
        .death-stats {
            text-align: left;
            margin: 20px 0;
            padding: 10px;
            background-color: #222;
            border-radius: 5px;
        }
        
        .death-button {
            background-color: var(--danger-color);
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 16px;
            margin: 10px;
            border-radius: 5px;
            cursor: pointer;
        }
        
        /* ç ”ç©¶é¢æ¿æ ·å¼ */
        .research-options {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        .research {
            background-color: #333;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #444;
        }
        
        .research-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .research-desc {
            font-size: 12px;
            margin-bottom: 10px;
        }
        
        /* äº¤æ˜“é¢æ¿æ ·å¼ */
        .trader-items {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        .trader-item {
            background-color: #333;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #444;
        }
        
        .trader-item-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .trader-item-price {
            font-size: 12px;
            color: var(--star-color);
            margin-bottom: 5px;
        }
        
        /* æ–°æ‰‹å¼•å¯¼æ ·å¼ */
        .tutorial-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            z-index: 200;
            color: white;
            text-align: center;
            padding-top: 50px;
        }
        
        .tutorial-content {
            background-color: #222;
            max-width: 500px;
            margin: 0 auto;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid var(--primary-color);
        }
        
        .tutorial-title {
            font-size: 24px;
            color: var(--primary-color);
            margin-bottom: 20px;
        }
        
        .tutorial-text {
            text-align: left;
            margin-bottom: 20px;
            line-height: 1.5;
        }
        
        .tutorial-button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 16px;
            margin: 10px;
            border-radius: 5px;
            cursor: pointer;
        }
        
        /* éŸ³æ•ˆæ§åˆ¶ */
        .sound-control {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background-color: #333;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            z-index: 100;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>æœ«æ—¥æ±‚ç”Ÿï¼šæ˜Ÿçƒæ¸¸æˆ </h1>
            <div>ç¬¬ <span id="day">1</span> å¤© <span id="time">æ—©æ™¨</span> <span id="weather">â˜€ï¸</span></div>
            <div class="weather-icon" id="temperature">ğŸŒ¡ï¸ 22Â°C</div>
        </div>
        
        <div class="stats">
            <div class="stat">
                <div class="stat-name">
                    <span>â¤ï¸ ç”Ÿå‘½å€¼</span>
                    <span class="stat-value health" id="health">100/100</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill health" id="health-bar"></div>
                </div>
            </div>
            <div class="stat">
                <div class="stat-name">
                    <span>ğŸ– é¥¥é¥¿åº¦</span>
                    <span class="stat-value hunger" id="hunger">80/100</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill hunger" id="hunger-bar"></div>
                </div>
            </div>
            <div class="stat">
                <div class="stat-name">
                    <span>âš¡ ç²¾åŠ›</span>
                    <span class="stat-value energy" id="energy">100/100</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill energy" id="energy-bar"></div>
                </div>
            </div>
            <div class="stat">
                <div class="stat-name">
                    <span>â˜£ï¸ æ„ŸæŸ“åº¦</span>
                    <span class="stat-value infection" id="infection">0/100</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill infection" id="infection-bar"></div>
                </div>
            </div>
            <div class="stat">
                <div class="stat-name">
                    <span>ğŸ§  SANå€¼</span>
                    <span class="stat-value san" id="san">80/100</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill san" id="san-bar"></div>
                </div>
            </div>
            <div class="stat">
                <div class="stat-name">
                    <span>ğŸ›¡ï¸ é˜²å¾¡</span>
                    <span class="stat-value" id="defense">5</span>
                </div>
            </div>
        </div>
        
        <div class="main-area">
            <div class="location-tag" id="location-tag">é¿éš¾æ‰€</div>
            <div id="location-description">ä½ åœ¨ä¸€é—´ç ´æ—§çš„é¿éš¾æ‰€ä¸­é†’æ¥ï¼Œçª—å¤–ä¼ æ¥ä½æ²‰çš„å˜¶å¼å£°...ç©ºæ°”ä¸­å¼¥æ¼«ç€æ­»äº¡çš„æ°”æ¯ã€‚</div>
            <div id="event-display"></div>
            
            <div class="status-effects" id="status-effects">
                <div class="status-effect effect-buff">åº‡æŠ¤æ‰€ +5é˜²å¾¡</div>
            </div>
        </div>
        
        <div class="map-container">
            <h3>åŒºåŸŸåœ°å›¾</h3>
            <div class="map-grid" id="map-grid">
                <!-- åœ°å›¾æ ¼å­å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
        
        <div class="action-buttons">
            <button class="btn" id="btn-explore">ğŸ” æ¢ç´¢</button>
            <button class="btn" id="btn-scavenge">ğŸ§º æœåˆ®</button>
            <button class="btn" id="btn-rest">ğŸ’¤ ä¼‘æ¯</button>
            <button class="btn" id="btn-eat">ğŸ½ï¸ è¿›é£Ÿ</button>
            <button class="btn btn-danger" id="btn-fight">âš”ï¸ æˆ˜æ–—</button>
            <button class="btn" id="btn-craft">ğŸ› ï¸ åˆ¶ä½œ</button>
            <button class="btn" id="btn-build">ğŸ—ï¸ å»ºé€ </button>
            <button class="btn" id="btn-skills">ğŸ“š æŠ€èƒ½</button>
            <button class="btn" id="btn-research">ğŸ”¬ ç ”ç©¶</button>
            <button class="btn" id="btn-trade">ğŸ’° äº¤æ˜“</button>
            <button class="btn btn-danger" id="btn-next">â­ï¸ ä¸‹ä¸€æ—¶æ®µ</button>
            <button class="btn" id="btn-treat">ğŸ’‰ æ²»ç–—</button>
            <button class="btn" id="btn-save">ğŸ’¾ ä¿å­˜</button>
            <button class="btn" id="btn-load">ğŸ”ƒ åŠ è½½</button>
        </div>
        
        <div class="inventory">
            <div class="tabs">
                <div class="tab active" data-tab="items">ç‰©å“</div>
                <div class="tab" data-tab="weapons">æ­¦å™¨</div>
                <div class="tab" data-tab="armor">æŠ¤ç”²</div>
                <div class="tab" data-tab="resources">èµ„æº</div>
            </div>
            
            <div class="tab-content active" id="tab-items">
                <div class="inventory-grid" id="inventory-items">
                    <!-- ç‰©å“å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
            
            <div class="tab-content" id="tab-weapons">
                <div class="inventory-grid" id="inventory-weapons">
                    <!-- æ­¦å™¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
            
            <div class="tab-content" id="tab-armor">
                <div class="inventory-grid" id="inventory-armor">
                    <!-- æŠ¤ç”²å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
            
            <div class="tab-content" id="tab-resources">
                <div class="inventory-grid" id="inventory-resources">
                    <!-- èµ„æºå°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
        </div>
        
        <div class="event-log">
            <h3>äº‹ä»¶æ—¥å¿—</h3>
            <div id="log-entries">
                <div class="log-entry">[æ—©æ™¨] ä½ ä»ä¸å®‰çš„ç¡çœ ä¸­é†’æ¥</div>
                <div class="log-entry danger">[æ—©æ™¨] ä¸§å°¸çš„å˜¶å¼å£°ä»è¿œå¤„ä¼ æ¥...</div>
            </div>
        </div>
    </div>

    <!-- æ­»äº¡æ¨¡æ€æ¡† -->
    <div id="death-modal" class="death-modal">
        <div class="death-content">
            <div class="death-title">ä½ æ­»äº†</div>
            <div class="death-reason" id="death-reason">æ„ŸæŸ“å·²ç»æ‰©æ•£åˆ°å…¨èº«...</div>
            <div class="death-stats">
                <div>ç”Ÿå­˜å¤©æ•°: <span id="death-days">1</span></div>
                <div>å‘ç°åœ°ç‚¹: <span id="death-locations">1</span></div>
                <div>å‡»æ€ä¸§å°¸: <span id="death-kills">0</span></div>
                <div>æœ€é«˜è®¾æ–½ç­‰çº§: <span id="death-facilities">1</span></div>
                <div>å­¦ä¹ æŠ€èƒ½: <span id="death-skills">0</span></div>
                <div>ç ”ç©¶å®Œæˆ: <span id="death-researches">0</span></div>
            </div>
            <button class="death-button" onclick="restartGame()">é‡æ–°å¼€å§‹</button>
            <button class="death-button" onclick="location.reload()">è¿”å›æ ‡é¢˜</button>
        </div>
    </div>

    <!-- åˆ¶ä½œæ¨¡æ€æ¡† -->
    <div id="craft-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); z-index: 100; padding: 20px; box-sizing: border-box; overflow-y: auto;">
        <div style="background-color: #222; max-width: 500px; margin: 20px auto; padding: 20px; border-radius: 5px; border: 1px solid #333;">
            <h2 style="margin-top: 0;">åˆ¶ä½œç‰©å“</h2>
            <div id="craft-recipes" style="display: grid; gap: 10px;">
                <!-- é…æ–¹å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
            </div>
            <button id="btn-close-craft" style="margin-top: 20px; padding: 10px 20px; background-color: var(--danger-color); color: white; border: none; border-radius: 5px; cursor: pointer;">å…³é—­</button>
        </div>
    </div>

    <!-- å»ºé€ æ¨¡æ€æ¡† -->
    <div id="build-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); z-index: 100; padding: 20px; box-sizing: border-box; overflow-y: auto;">
        <div style="background-color: #222; max-width: 500px; margin: 20px auto; padding: 20px; border-radius: 5px; border: 1px solid #333;">
            <h2 style="margin-top: 0;">å»ºé€ è®¾æ–½</h2>
            <div id="build-options" style="display: grid; gap: 10px;">
                <!-- å»ºé€ é€‰é¡¹å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
            </div>
            <button id="btn-close-build" style="margin-top: 20px; padding: 10px 20px; background-color: var(--danger-color); color: white; border: none; border-radius: 5px; cursor: pointer;">å…³é—­</button>
        </div>
    </div>

    <!-- æŠ€èƒ½æ¨¡æ€æ¡† -->
    <div id="skills-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); z-index: 100; padding: 20px; box-sizing: border-box; overflow-y: auto;">
        <div style="background-color: #222; max-width: 500px; margin: 20px auto; padding: 20px; border-radius: 5px; border: 1px solid #333;">
            <h2 style="margin-top: 0;">æŠ€èƒ½æ ‘</h2>
            <div style="margin-bottom: 15px;">
                <span>æŠ€èƒ½ç‚¹: </span>
                <span id="skill-points" style="font-weight: bold; color: var(--star-color);">0</span>
            </div>
            <div id="skill-trees" style="display: grid; gap: 20px;">
                <!-- æŠ€èƒ½æ ‘å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
            </div>
            <button id="btn-close-skills" style="margin-top: 20px; padding: 10px 20px; background-color: var(--danger-color); color: white; border: none; border-radius: 5px; cursor: pointer;">å…³é—­</button>
        </div>
    </div>

    <!-- ç ”ç©¶æ¨¡æ€æ¡† -->
    <div id="research-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); z-index: 100; padding: 20px; box-sizing: border-box; overflow-y: auto;">
        <div style="background-color: #222; max-width: 500px; margin: 20px auto; padding: 20px; border-radius: 5px; border: 1px solid #333;">
            <h2 style="margin-top: 0;">ç ”ç©¶</h2>
            <div style="margin-bottom: 15px;">
                <span>ç ”ç©¶ç‚¹æ•°: </span>
                <span id="research-points" style="font-weight: bold; color: var(--star-color);">0</span>
            </div>
            <div id="research-options" class="research-options">
                <!-- ç ”ç©¶é€‰é¡¹å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
            </div>
            <button id="btn-close-research" style="margin-top: 20px; padding: 10px 20px; background-color: var(--danger-color); color: white; border: none; border-radius: 5px; cursor: pointer;">å…³é—­</button>
        </div>
    </div>

    <!-- äº¤æ˜“æ¨¡æ€æ¡† -->
    <div id="trade-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); z-index: 100; padding: 20px; box-sizing: border-box; overflow-y: auto;">
        <div style="background-color: #222; max-width: 500px; margin: 20px auto; padding: 20px; border-radius: 5px; border: 1px solid #333;">
            <h2 style="margin-top: 0;">æµæµªå•†äºº</h2>
            <div style="margin-bottom: 15px;">
                <span>ä½ çš„ç‰©èµ„: </span>
                <span id="trade-resources" style="font-weight: bold;"></span>
            </div>
            <div id="trader-items" class="trader-items">
                <!-- äº¤æ˜“ç‰©å“å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
            </div>
            <button id="btn-close-trade" style="margin-top: 20px; padding: 10px 20px; background-color: var(--danger-color); color: white; border: none; border-radius: 5px; cursor: pointer;">å…³é—­</button>
        </div>
    </div>

    <!-- åŠ è½½æ¨¡æ€æ¡† -->
    <div id="load-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); z-index: 100; padding: 20px; box-sizing: border-box; overflow-y: auto;">
        <div style="background-color: #222; max-width: 500px; margin: 20px auto; padding: 20px; border-radius: 5px; border: 1px solid #333;">
            <h2 style="margin-top: 0;">åŠ è½½å­˜æ¡£</h2>
            <div id="save-slots" style="display: grid; gap: 10px;">
                <button class="btn" onclick="loadGame(1)">å­˜æ¡£ 1</button>
                <button class="btn" onclick="loadGame(2)">å­˜æ¡£ 2</button>
                <button class="btn" onclick="loadGame(3)">å­˜æ¡£ 3</button>
            </div>
            <button id="btn-close-load" style="margin-top: 20px; padding: 10px 20px; background-color: var(--danger-color); color: white; border: none; border-radius: 5px; cursor: pointer;">å…³é—­</button>
        </div>
    </div>

    <!-- æ–°æ‰‹å¼•å¯¼æ¨¡æ€æ¡† -->
    <div id="tutorial-modal" class="tutorial-modal">
        <div class="tutorial-content">
            <div class="tutorial-title">æœ«æ—¥æ±‚ç”ŸæŒ‡å—</div>
            <div class="tutorial-text">
                <p><strong>æ¬¢è¿æ¥åˆ°æœ«æ—¥æ±‚ç”Ÿï¼šæ˜Ÿçƒæ¸¸æˆï¼</strong></p>
                <p>åœ¨è¿™ä¸ªä¸§å°¸æ¨ªè¡Œçš„ä¸–ç•Œé‡Œï¼Œä½ éœ€è¦ç®¡ç†èµ„æºã€å»ºé€ è®¾æ–½ã€ç ”ç©¶ç§‘æŠ€ï¼ŒåŠªåŠ›ç”Ÿå­˜ä¸‹å»ã€‚</p>
                <p><strong>æ¸¸æˆç‰¹ç‚¹ï¼š</strong></p>
                <ul>
                    <li>é«˜éš¾åº¦ç”Ÿå­˜æŒ‘æˆ˜ - ç”Ÿå‘½å€¼å’Œæ„ŸæŸ“åº¦å½’é›¶éƒ½ä¼šå¯¼è‡´æ­»äº¡</li>
                    <li>å¤æ‚çš„èµ„æºç®¡ç†ç³»ç»Ÿ - é£Ÿç‰©ã€æ°´ã€åŒ»ç–—ç”¨å“éƒ½è‡³å…³é‡è¦</li>
                    <li>æ·±åº¦åˆ¶ä½œå’Œå»ºé€ ç³»ç»Ÿ - åˆ¶ä½œæ­¦å™¨ã€å»ºé€ é˜²å¾¡è®¾æ–½</li>
                    <li>æŠ€èƒ½å’Œç ”ç©¶ç³»ç»Ÿ - è§£é”æ–°èƒ½åŠ›æå‡ç”Ÿå­˜å‡ ç‡</li>
                    <li>éšæœºäº‹ä»¶ - æ¯å¤©éƒ½ä¼šé¢ä¸´æ–°çš„æŒ‘æˆ˜å’Œæœºé‡</li>
                </ul>
                <p><strong>ç”Ÿå­˜æŠ€å·§ï¼š</strong></p>
                <ul>
                    <li>ä¼˜å…ˆç¡®ä¿é£Ÿç‰©å’Œæ°´æºä¾›åº”</li>
                    <li>å°½å¿«å»ºé€ é˜²å¾¡è®¾æ–½é˜²æ­¢ä¸§å°¸è¢­å‡»</li>
                    <li>æ³¨æ„æ²»ç–—æ„ŸæŸ“ï¼Œå¦åˆ™ä¼šå¿«é€Ÿæ­»äº¡</li>
                    <li>åˆç†åˆ†é…æŠ€èƒ½ç‚¹ï¼Œé€‰æ‹©é€‚åˆä½ çš„ç”Ÿå­˜ç­–ç•¥</li>
                </ul>
            </div>
            <button class="tutorial-button" onclick="closeTutorial()">å¼€å§‹æ¸¸æˆ</button>
        </div>
    </div>

    <!-- éŸ³æ•ˆæ§åˆ¶ -->
    <div class="sound-control" id="sound-control">ğŸ”Š éŸ³æ•ˆ</div>

    <script>
        // ======================
        // æ¸¸æˆçŠ¶æ€å’Œæ•°æ®
        // ======================
        const gameState = {
            version: "3.0",
            day: 1,
            time: 0, // 0-æ—©æ™¨, 1-ä¸­åˆ, 2-å‚æ™š, 3-å¤œæ™š
            times: ["æ—©æ™¨", "ä¸­åˆ", "å‚æ™š", "å¤œæ™š"],
            health: 100,
            maxHealth: 100,
            hunger: 80,
            maxHunger: 100,
            energy: 100,
            maxEnergy: 100,
            infection: 0,
            maxInfection: 100,
            san: 80,
            maxSan: 100,
            defense: 5,
            skillPoints: 0,
            researchPoints: 0,
            temperature: 22,
            weather: "æ™´å¤©",
            weathers: ["æ™´å¤©", "é›¨å¤©", "é›¾å¤©", "æš´é£é›¨", "æå¯’"],
            weatherIcons: ["â˜€ï¸", "ğŸŒ§ï¸", "ğŸŒ«ï¸", "â›ˆï¸", "â„ï¸"],
            location: "é¿éš¾æ‰€",
            locations: {
                "é¿éš¾æ‰€": { description: "ä½ çš„ä¸´æ—¶åº‡æŠ¤æ‰€ï¼Œç›¸å¯¹å®‰å…¨", danger: 1, resources: [] },
                "åºŸå¼ƒè¶…å¸‚": { description: "è´§æ¶ä¸Šå¯èƒ½è¿˜æœ‰å‰©ä½™çš„é£Ÿç‰©", danger: 4, resources: ["é£Ÿç‰©", "æ—¥ç”¨å“"] },
                "åŠ æ²¹ç«™": { description: "å¯èƒ½æœ‰ç‡ƒæ–™å’Œå·¥å…·", danger: 5, resources: ["ç‡ƒæ–™", "å·¥å…·"] },
                "åŒ»é™¢": { description: "åŒ»ç–—ç‰©èµ„ä¸°å¯Œä½†æå…¶å±é™©", danger: 7, resources: ["åŒ»ç–—"] },
                "è­¦å¯Ÿå±€": { description: "æ­¦å™¨å’Œé˜²å…·çš„æ¥æº", danger: 6, resources: ["æ­¦å™¨"] },
                "å±…æ°‘åŒº": { description: "æ™®é€šä½å®…ï¼Œå¯èƒ½æœ‰åŸºæœ¬ç‰©èµ„", danger: 3, resources: ["é£Ÿç‰©", "æ—¥ç”¨å“"] },
                "å­¦æ ¡": { description: "å¯èƒ½æœ‰ä¹¦ç±å’Œç®€å•å·¥å…·", danger: 4, resources: ["çŸ¥è¯†"] },
                "å»ºç­‘å·¥åœ°": { description: "å»ºç­‘ææ–™ä¸°å¯Œ", danger: 5, resources: ["å»ºæ"] },
                "å†›äº‹å“¨æ‰€": { description: "é«˜çº§æ­¦å™¨ä½†å±é™©æé«˜", danger: 8, resources: ["æ­¦å™¨", "å¼¹è¯"] },
                "å®éªŒå®¤": { description: "å±é™©ä½†å¯èƒ½æœ‰çè´µçš„ç ”ç©¶èµ„æ–™", danger: 9, resources: ["ç ”ç©¶æ•°æ®"] },
                "æµæµªå•†äººè¥åœ°": { description: "å¯ä»¥äº¤æ˜“ç‰©èµ„çš„å®‰å…¨åœ°ç‚¹", danger: 2, resources: ["äº¤æ˜“"] }
            },
            currentPosition: { x: 2, y: 2 }, // åœ°å›¾ä¸­å¿ƒä½ç½®
            discoveredLocations: ["é¿éš¾æ‰€"],
            map: Array(5).fill().map(() => Array(5).fill(null)),
            inventory: {
                // æ¶ˆè€—å“
                "ç½å¤´": { type: "food", count: 2, effect: { hunger: 30 } },
                "ç“¶è£…æ°´": { type: "food", count: 1, effect: { hunger: 10 } },
                "ç»·å¸¦": { type: "medical", count: 1, effect: { health: 15 } },
                "æŠ—ç”Ÿç´ ": { type: "medical", count: 0, effect: { infection: -20 } },
                "é•‡é™å‰‚": { type: "medical", count: 0, effect: { san: 15 } },
                "æŠ—ç—…æ¯’è¡€æ¸…": { type: "medical", count: 0, effect: { infection: -50 } },
                
                // æ­¦å™¨
                "å°åˆ€": { type: "weapon", count: 1, damage: 8, durability: 40 },
                "æ£’çƒæ£": { type: "weapon", count: 0, damage: 12, durability: 25 },
                "æ‰‹æª": { type: "weapon", count: 0, damage: 20, ammo: 0, maxAmmo: 12, durability: 80 },
                "çŒæª": { type: "weapon", count: 0, damage: 35, ammo: 0, maxAmmo: 6, durability: 70 },
                "ç«ç„°å–·å°„å™¨": { type: "weapon", count: 0, damage: 50, ammo: 0, maxAmmo: 20, durability: 100 },
                
                // æŠ¤ç”²
                "çš®å¤¹å…‹": { type: "armor", count: 0, defense: 2, durability: 30 },
                "è­¦ç”¨é˜²å¼¹è¡£": { type: "armor", count: 0, defense: 6, durability: 50 },
                "å†›ç”¨æŠ¤ç”²": { type: "armor", count: 0, defense: 10, durability: 70 },
                "é˜²æ„ŸæŸ“å¥—è£…": { type: "armor", count: 0, defense: 4, durability: 40, effect: { infectionResist: 40 } },
                
                // èµ„æº
                "æœ¨æ": { type: "resource", count: 3 },
                "é‡‘å±": { type: "resource", count: 1 },
                "å¸ƒæ–™": { type: "resource", count: 2 },
                "ç”µå­é›¶ä»¶": { type: "resource", count: 0 },
                "å¼¹è¯": { type: "resource", count: 0 },
                "ç‡ƒæ–™": { type: "resource", count: 0 },
                "ç ”ç©¶æ•°æ®": { type: "resource", count: 0 },
                "åŒ»ç–—ç”¨å“": { type: "resource", count: 0 },
                "é£Ÿç‰©è¡¥ç»™": { type: "resource", count: 0 },
                
                // ç‰¹æ®Šç‰©å“
                "ç ”ç©¶ç¬”è®°": { type: "research", count: 0 }
            },
            equippedWeapon: null,
            equippedArmor: null,
            statusEffects: [
                { name: "åº‡æŠ¤æ‰€", type: "buff", description: "åŸºç¡€é˜²å¾¡+5", duration: Infinity }
            ],
            facilities: {
                "å·¥ä½œå°": { level: 1, maxLevel: 3, description: "è§£é”æ›´å¤šåˆ¶ä½œé…æ–¹", requirements: { "æœ¨æ": 10, "é‡‘å±": 5 } },
                "é›¨æ°´æ”¶é›†å™¨": { level: 0, maxLevel: 2, description: "æ¯å¤©æä¾›å‡€æ°´", requirements: { "æœ¨æ": 5, "å¸ƒæ–™": 3 } },
                "èœå›­": { level: 0, maxLevel: 3, description: "æ¯å¤©æä¾›é£Ÿç‰©", requirements: { "æœ¨æ": 8 } },
                "é˜²å¾¡å·¥äº‹": { level: 0, maxLevel: 3, description: "å‡å°‘è¢«è¢­å‡»å‡ ç‡", requirements: { "æœ¨æ": 15, "é‡‘å±": 10 } },
                "åŒ»ç–—ç«™": { level: 0, maxLevel: 2, description: "ç¼“æ…¢æ¢å¤å¥åº·", requirements: { "ç”µå­é›¶ä»¶": 2, "å¸ƒæ–™": 5 } },
                "ç ”ç©¶å®éªŒå®¤": { level: 0, maxLevel: 2, description: "è§£é”é«˜çº§ç§‘æŠ€", requirements: { "ç”µå­é›¶ä»¶": 8, "ç ”ç©¶æ•°æ®": 3 } },
                "äº¤æ˜“ç«™": { level: 0, maxLevel: 1, description: "å¸å¼•æµæµªå•†äººæ¥è®¿", requirements: { "æœ¨æ": 20, "é‡‘å±": 10 } }
            },
            recipes: {
                "ç®€æ˜“ç»·å¸¦": { type: "medical", materials: { "å¸ƒæ–™": 2 }, result: { "ç»·å¸¦": 1 } },
                "æœ¨åˆ¶é•¿çŸ›": { type: "weapon", materials: { "æœ¨æ": 3 }, result: { "æœ¨åˆ¶é•¿çŸ›": 1 }, requires: { "å·¥ä½œå°": 1 } },
                "ç®€æ˜“é™·é˜±": { type: "tool", materials: { "æœ¨æ": 2, "é‡‘å±": 1 }, result: { "ç®€æ˜“é™·é˜±": 1 }, requires: { "å·¥ä½œå°": 1 } },
                "å­å¼¹": { type: "ammo", materials: { "é‡‘å±": 1 }, result: { "å¼¹è¯": 5 }, requires: { "å·¥ä½œå°": 2 } },
                "é“åˆ¶æŠ¤ç”²": { type: "armor", materials: { "é‡‘å±": 5, "å¸ƒæ–™": 3 }, result: { "é“åˆ¶æŠ¤ç”²": 1 }, requires: { "å·¥ä½œå°": 2 } },
                "çŒæªå­å¼¹": { type: "ammo", materials: { "é‡‘å±": 2, "ç‡ƒæ–™": 1 }, result: { "çŒæªå­å¼¹": 5 }, requires: { "å·¥ä½œå°": 3 } },
                "ç«ç„°ç‡ƒæ–™": { type: "ammo", materials: { "ç‡ƒæ–™": 3 }, result: { "ç«ç„°ç‡ƒæ–™": 10 }, requires: { "å·¥ä½œå°": 3 } },
                "é˜²æ„ŸæŸ“å¥—è£…": { type: "armor", materials: { "å¸ƒæ–™": 5, "åŒ»ç–—ç”¨å“": 3 }, result: { "é˜²æ„ŸæŸ“å¥—è£…": 1 }, requires: { "ç ”ç©¶å®éªŒå®¤": 1 } },
                "æŠ—ç—…æ¯’è¡€æ¸…": { type: "medical", materials: { "åŒ»ç–—ç”¨å“": 5, "ç ”ç©¶æ•°æ®": 2 }, result: { "æŠ—ç—…æ¯’è¡€æ¸…": 1 }, requires: { "ç ”ç©¶å®éªŒå®¤": 2 } }
            },
            researches: {
                "åŸºç¡€åŒ»ç–—": { 
                    description: "è§£é”æ›´é«˜æ•ˆçš„åŒ»ç–—é…æ–¹", 
                    cost: 3, 
                    learned: false,
                    requirements: [],
                    unlocks: ["é«˜çº§ç»·å¸¦"]
                },
                "æ­¦å™¨æ”¹è‰¯": { 
                    description: "æé«˜æ­¦å™¨ä¼¤å®³å’Œè€ä¹…åº¦", 
                    cost: 4, 
                    learned: false,
                    requirements: [],
                    unlocks: ["æ”¹è‰¯æ­¦å™¨"]
                },
                "é˜²å¾¡å·¥äº‹": { 
                    description: "æå‡é˜²å¾¡è®¾æ–½æ•ˆæœ", 
                    cost: 5, 
                    learned: false,
                    requirements: [],
                    unlocks: ["å¼ºåŒ–é˜²å¾¡"]
                },
                "æŠ—ç—…æ¯’ç ”ç©¶": { 
                    description: "å¼€å‘æ›´æœ‰æ•ˆçš„æŠ—æ„ŸæŸ“æ²»ç–—", 
                    cost: 6, 
                    learned: false,
                    requirements: ["åŸºç¡€åŒ»ç–—"],
                    unlocks: ["æŠ—ç—…æ¯’è¡€æ¸…"]
                },
                "é«˜çº§å·¥ç¨‹": { 
                    description: "è§£é”é«˜çº§åˆ¶ä½œé…æ–¹", 
                    cost: 7, 
                    learned: false,
                    requirements: ["æ­¦å™¨æ”¹è‰¯"],
                    unlocks: ["é«˜çº§æ­¦å™¨"]
                }
            },
            skills: {
                "ç”Ÿå­˜ä¸“å®¶": { 
                    description: "å‡å°‘25%é£Ÿç‰©å’Œæ°´æ¶ˆè€—", 
                    cost: 1, 
                    learned: false, 
                    requirements: [], 
                    effect: () => { gameState.foodConsumptionRate = 0.75; } 
                },
                "ç†Ÿç»ƒæˆ˜å£«": { 
                    description: "è¿‘æˆ˜ä¼¤å®³+25%", 
                    cost: 1, 
                    learned: false, 
                    requirements: [], 
                    effect: () => { gameState.meleeDamageBonus = 1.25; } 
                },
                "ç¥å°„æ‰‹": { 
                    description: "è¿œç¨‹æ­¦å™¨ä¼¤å®³+20%", 
                    cost: 1, 
                    learned: false, 
                    requirements: [], 
                    effect: () => { gameState.rangedDamageBonus = 1.2; } 
                },
                "åŒ»ç–—çŸ¥è¯†": { 
                    description: "æ²»ç–—æ•ˆæœ+30%", 
                    cost: 1, 
                    learned: false, 
                    requirements: [], 
                    effect: () => { gameState.healingBonus = 1.3; } 
                },
                "å·¥ç¨‹å¸ˆ": { 
                    description: "è§£é”é«˜çº§åˆ¶ä½œé…æ–¹", 
                    cost: 2, 
                    learned: false, 
                    requirements: [], 
                    effect: () => { gameState.engineerUnlocked = true; } 
                },
                "é’¢ç­‹é“éª¨": { 
                    description: "æœ€å¤§ç”Ÿå‘½å€¼+15", 
                    cost: 2, 
                    learned: false, 
                    requirements: ["ç†Ÿç»ƒæˆ˜å£«"], 
                    effect: () => { gameState.maxHealth += 15; gameState.health += 15; } 
                },
                "å¿«é€Ÿå­¦ä¹ è€…": {
                    description: "è·å¾—æŠ€èƒ½ç‚¹çš„é€Ÿåº¦åŠ å¿«",
                    cost: 3,
                    learned: false,
                    requirements: [],
                    effect: () => { gameState.skillPointRate = 0.75; }
                },
                "è°ˆåˆ¤ä¸“å®¶": {
                    description: "äº¤æ˜“æ—¶è·å¾—æ›´å¥½ä»·æ ¼",
                    cost: 2,
                    learned: false,
                    requirements: [],
                    effect: () => { gameState.tradeBonus = 1.15; }
                }
            },
            traderInventory: {
                "ç½å¤´": { price: { "æœ¨æ": 3 }, stock: 5 },
                "ç“¶è£…æ°´": { price: { "å¸ƒæ–™": 2 }, stock: 5 },
                "ç»·å¸¦": { price: { "é‡‘å±": 2 }, stock: 3 },
                "æŠ—ç”Ÿç´ ": { price: { "åŒ»ç–—ç”¨å“": 3 }, stock: 2 },
                "å¼¹è¯": { price: { "é‡‘å±": 4 }, stock: 10 },
                "ç‡ƒæ–™": { price: { "ç”µå­é›¶ä»¶": 2 }, stock: 5 },
                "ç ”ç©¶æ•°æ®": { price: { "é£Ÿç‰©è¡¥ç»™": 4 }, stock: 2 },
                "å†›ç”¨æŠ¤ç”²": { price: { "åŒ»ç–—ç”¨å“": 5, "ç”µå­é›¶ä»¶": 3 }, stock: 1 },
                "ç«ç„°å–·å°„å™¨": { price: { "ç‡ƒæ–™": 12, "ç”µå­é›¶ä»¶": 6 }, stock: 1 }
            },
            events: [],
            lastAttackDay: 0,
            zombieHordeSize: 0,
            zombiesKilled: 0,
            foodConsumptionRate: 1.0,
            meleeDamageBonus: 1.0,
            rangedDamageBonus: 1.0,
            healingBonus: 1.0,
            engineerUnlocked: false,
            tradeBonus: 1.0,
            skillPointRate: 1.0,
            traderVisits: 0,
            lastTraderVisit: 0,
            deathReason: "",
            showTutorial: true,
            soundEnabled: true
        };

        // ç¼“å­˜DOMå…ƒç´ 
        const elements = {
            day: document.getElementById("day"),
            time: document.getElementById("time"),
            weather: document.getElementById("weather"),
            temperature: document.getElementById("temperature"),
            "location-tag": document.getElementById("location-tag"),
            "location-description": document.getElementById("location-description"),
            health: document.getElementById("health"),
            hunger: document.getElementById("hunger"),
            energy: document.getElementById("energy"),
            infection: document.getElementById("infection"),
            san: document.getElementById("san"),
            defense: document.getElementById("defense"),
            "health-bar": document.getElementById("health-bar"),
            "hunger-bar": document.getElementById("hunger-bar"),
            "energy-bar": document.getElementById("energy-bar"),
            "infection-bar": document.getElementById("infection-bar"),
            "san-bar": document.getElementById("san-bar"),
            "log-entries": document.getElementById("log-entries"),
            "map-grid": document.getElementById("map-grid"),
            "inventory-items": document.getElementById("inventory-items"),
            "inventory-weapons": document.getElementById("inventory-weapons"),
            "inventory-armor": document.getElementById("inventory-armor"),
            "inventory-resources": document.getElementById("inventory-resources"),
            "status-effects": document.getElementById("status-effects"),
            "death-reason": document.getElementById("death-reason"),
            "death-days": document.getElementById("death-days"),
            "death-locations": document.getElementById("death-locations"),
            "death-kills": document.getElementById("death-kills"),
            "death-facilities": document.getElementById("death-facilities"),
            "death-skills": document.getElementById("death-skills"),
            "death-researches": document.getElementById("death-researches"),
            "research-points": document.getElementById("research-points"),
            "sound-control": document.getElementById("sound-control")
        };

        // éŸ³æ•ˆ
        const sounds = {
            click: new Audio('data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU...'),
            craft: new Audio('data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU...'),
            fight: new Audio('data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU...'),
            eat: new Audio('data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU...'),
            death: new Audio('data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU...'),
            success: new Audio('data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU...')
        };

        // æ’­æ”¾éŸ³æ•ˆ
        function playSound(soundName) {
            if (!gameState.soundEnabled) return;
            
            try {
                sounds[soundName].currentTime = 0;
                sounds[soundName].play();
            } catch (e) {
                console.error("æ’­æ”¾éŸ³æ•ˆå¤±è´¥:", e);
            }
        }

        // åˆå§‹åŒ–åœ°å›¾
        function initializeMap() {
            const locationNames = Object.keys(gameState.locations).filter(name => name !== "é¿éš¾æ‰€");
            
            // ç¡®ä¿é¿éš¾æ‰€åœ¨ä¸­å¿ƒ
            gameState.map[2][2] = "é¿éš¾æ‰€";
            
            // éšæœºæ”¾ç½®å…¶ä»–åœ°ç‚¹
            const positions = [];
            for (let y = 0; y < 5; y++) {
                for (let x = 0; x < 5; x++) {
                    if (x !== 2 || y !== 2) {
                        positions.push({ x, y });
                    }
                }
            }
            
            // éšæœºæ‰“ä¹±ä½ç½®
            positions.sort(() => Math.random() - 0.5);
            
            // æ”¾ç½®åœ°ç‚¹
            for (let i = 0; i < Math.min(locationNames.length, positions.length); i++) {
                const pos = positions[i];
                gameState.map[pos.y][pos.x] = locationNames[i];
            }
        }

        // ======================
        // æ¸¸æˆæ ¸å¿ƒåŠŸèƒ½
        // ======================
        function nextTime() {
            if (gameState.health <= 0) return; // å¦‚æœå·²ç»æ­»äº¡ï¼Œä¸æ‰§è¡Œä»»ä½•æ“ä½œ
            
            playSound("click");
            gameState.time = (gameState.time + 1) % 4;
            if (gameState.time === 0) {
                gameState.day++;
                
                // æ¯å¤©å¼€å§‹æ—¶è·å¾—æŠ€èƒ½ç‚¹
                if (gameState.day % Math.floor(4 / gameState.skillPointRate) === 0) {
                    gameState.skillPoints++;
                    addLog("è·å¾—1ç‚¹æŠ€èƒ½ç‚¹", "positive");
                    playSound("success");
                }
                
                // éšæœºå¤©æ°”å˜åŒ–
                changeWeather();
                
                // æ¯æ—¥çŠ¶æ€æ›´æ–°
                dailyUpdate();
            }
            
            updateTimeEffects();
            processStatusEffects();
            triggerRandomEvent();
            updateUI();
            
            // æ£€æŸ¥æ­»äº¡æ¡ä»¶
            checkDeathCondition();
        }

        function checkDeathCondition() {
            if (gameState.health <= 0) {
                showDeathScreen("ä½ çš„ç”Ÿå‘½å€¼å·²ç»è€—å°½...");
                playSound("death");
                return;
            }
            
            if (gameState.infection >= 100) {
                showDeathScreen("æ„ŸæŸ“å·²ç»æ‰©æ•£åˆ°å…¨èº«...");
                playSound("death");
                return;
            }
            
            if (gameState.hunger <= 0) {
                gameState.health = Math.max(0, gameState.health - 15);
                addLog("é¥¥é¥¿ä½¿ä½ å˜å¾—æåº¦è™šå¼±", "danger");
                if (gameState.health <= 0) {
                    showDeathScreen("é¥¥é¥¿å’Œè™šå¼±æœ€ç»ˆå‡»è´¥äº†ä½ ...");
                    playSound("death");
                }
                return;
            }
            
            if (gameState.san <= 0) {
                showDeathScreen("ä½ å¤±å»äº†ç†æ™ºï¼Œé™·å…¥äº†ç–¯ç‹‚...");
                playSound("death");
                return;
            }
        }

        function showDeathScreen(reason) {
            gameState.deathReason = reason;
            elements["death-reason"].textContent = reason;
            elements["death-days"].textContent = gameState.day;
            elements["death-locations"].textContent = gameState.discoveredLocations.length;
            elements["death-kills"].textContent = gameState.zombiesKilled;
            
            // è®¡ç®—æœ€é«˜è®¾æ–½ç­‰çº§
            let maxFacilityLevel = 0;
            for (const facility of Object.values(gameState.facilities)) {
                if (facility.level > maxFacilityLevel) {
                    maxFacilityLevel = facility.level;
                }
            }
            elements["death-facilities"].textContent = maxFacilityLevel;
            
            // è®¡ç®—å·²å­¦æŠ€èƒ½æ•°é‡
            let learnedSkills = 0;
            for (const skill of Object.values(gameState.skills)) {
                if (skill.learned) learnedSkills++;
            }
            elements["death-skills"].textContent = learnedSkills;
            
            // è®¡ç®—å·²å®Œæˆç ”ç©¶æ•°é‡
            let learnedResearches = 0;
            for (const research of Object.values(gameState.researches)) {
                if (research.learned) learnedResearches++;
            }
            elements["death-researches"].textContent = learnedResearches;
            
            document.getElementById("death-modal").style.display = "block";
        }

        function restartGame() {
            playSound("click");
            // é‡ç½®æ¸¸æˆçŠ¶æ€
            const defaultState = {
                version: "3.0",
                day: 1,
                time: 0,
                health: 100,
                maxHealth: 100,
                hunger: 80,
                maxHunger: 100,
                energy: 100,
                maxEnergy: 100,
                infection: 0,
                maxInfection: 100,
                san: 80,
                maxSan: 100,
                defense: 5,
                skillPoints: 0,
                researchPoints: 0,
                temperature: 22,
                weather: "æ™´å¤©",
                location: "é¿éš¾æ‰€",
                currentPosition: { x: 2, y: 2 },
                discoveredLocations: ["é¿éš¾æ‰€"],
                inventory: {
                    "ç½å¤´": { type: "food", count: 2, effect: { hunger: 30 } },
                    "ç“¶è£…æ°´": { type: "food", count: 1, effect: { hunger: 10 } },
                    "ç»·å¸¦": { type: "medical", count: 1, effect: { health: 15 } },
                    "å°åˆ€": { type: "weapon", count: 1, damage: 8, durability: 40 },
                    "æœ¨æ": { type: "resource", count: 3 },
                    "é‡‘å±": { type: "resource", count: 1 },
                    "å¸ƒæ–™": { type: "resource", count: 2 }
                },
                equippedWeapon: null,
                equippedArmor: null,
                statusEffects: [
                    { name: "åº‡æŠ¤æ‰€", type: "buff", description: "åŸºç¡€é˜²å¾¡+5", duration: Infinity }
                ],
                zombiesKilled: 0,
                foodConsumptionRate: 1.0,
                meleeDamageBonus: 1.0,
                rangedDamageBonus: 1.0,
                healingBonus: 1.0,
                engineerUnlocked: false,
                tradeBonus: 1.0,
                skillPointRate: 1.0,
                traderVisits: 0,
                lastTraderVisit: 0,
                deathReason: "",
                showTutorial: false,
                soundEnabled: gameState.soundEnabled
            };
            
            // ä¿ç•™è®¾æ–½å’ŒæŠ€èƒ½çš„åŸå§‹å®šä¹‰
            const facilities = gameState.facilities;
            const skills = gameState.skills;
            const researches = gameState.researches;
            const recipes = gameState.recipes;
            const locations = gameState.locations;
            const traderInventory = gameState.traderInventory;
            
            // é‡ç½®æ¸¸æˆçŠ¶æ€
            Object.assign(gameState, defaultState);
            gameState.facilities = facilities;
            gameState.skills = skills;
            gameState.researches = researches;
            gameState.recipes = recipes;
            gameState.locations = locations;
            gameState.traderInventory = traderInventory;
            
            // é‡ç½®è®¾æ–½ç­‰çº§å’ŒæŠ€èƒ½å­¦ä¹ çŠ¶æ€
            for (const facility of Object.values(gameState.facilities)) {
                facility.level = facility.name === "å·¥ä½œå°" ? 1 : 0;
            }
            
            for (const skill of Object.values(gameState.skills)) {
                skill.learned = false;
            }
            
            for (const research of Object.values(gameState.researches)) {
                research.learned = false;
            }
            
            // é‡æ–°åˆå§‹åŒ–åœ°å›¾
            initializeMap();
            
            // å…³é—­æ­»äº¡æ¨¡æ€æ¡†
            document.getElementById("death-modal").style.display = "none";
            
            // æ›´æ–°UI
            updateUI();
            
            // æ·»åŠ åˆå§‹æ—¥å¿—
            addLog("æ¸¸æˆé‡æ–°å¼€å§‹ï¼ŒåŠªåŠ›åœ¨ä¸§å°¸æœ«æ—¥ä¸­ç”Ÿå­˜ä¸‹å»ï¼", "info");
            addLog("ä¸§å°¸çš„å˜¶å¼å£°ä»è¿œå¤„ä¼ æ¥...", "danger");
        }

        function changeWeather() {
            const weatherIndex = Math.floor(Math.random() * gameState.weathers.length);
            gameState.weather = gameState.weathers[weatherIndex];
            
            // å¤©æ°”æ•ˆæœ
            switch (gameState.weather) {
                case "é›¨å¤©":
                    gameState.temperature = 15 + Math.floor(Math.random() * 5);
                    addLog("å¼€å§‹ä¸‹é›¨äº†ï¼Œæ¸©åº¦ä¸‹é™", "info");
                    break;
                case "é›¾å¤©":
                    gameState.temperature = 18 + Math.floor(Math.random() * 5);
                    addLog("æµ“é›¾ç¬¼ç½©ï¼Œèƒ½è§åº¦é™ä½", "warning");
                    break;
                case "æš´é£é›¨":
                    gameState.temperature = 12 + Math.floor(Math.random() * 5);
                    addLog("æš´é£é›¨æ¥è¢­ï¼Œå¤–å‡ºæ›´åŠ å±é™©", "danger");
                    break;
                case "æå¯’":
                    gameState.temperature = -10 + Math.floor(Math.random() * 5);
                    addLog("æå¯’å¤©æ°”ï¼Œæ³¨æ„ä¿æš–", "danger");
                    break;
                default: // æ™´å¤©
                    gameState.temperature = 22 + Math.floor(Math.random() * 10);
            }
        }

        function dailyUpdate() {
            // é¥¥é¥¿å’Œå£æ¸´
            const hungerLoss = Math.floor(20 * gameState.foodConsumptionRate);
            gameState.hunger = Math.max(0, gameState.hunger - hungerLoss);
            
            if (gameState.hunger <= 0) {
                gameState.health = Math.max(0, gameState.health - 15);
                addLog("é¥¥é¥¿ä½¿ä½ å˜å¾—æåº¦è™šå¼±", "danger");
            }
            
            // æ„ŸæŸ“è¿›å±•
            if (gameState.infection > 0) {
                let infectionIncrease = 10;
                
                // é˜²æ„ŸæŸ“å¥—è£…å‡å°‘æ„ŸæŸ“é€Ÿåº¦
                if (gameState.equippedArmor === "é˜²æ„ŸæŸ“å¥—è£…") {
                    infectionIncrease = Math.floor(infectionIncrease * 0.6);
                }
                
                gameState.infection = Math.min(100, gameState.infection + infectionIncrease);
                
                if (gameState.infection >= 50) {
                    gameState.health = Math.max(0, gameState.health - 10);
                    addLog("æ„ŸæŸ“æ­£åœ¨æ¶åŒ–ï¼Œä½ æ„Ÿåˆ°éå¸¸ä¸é€‚", "danger");
                }
                
                // æ„ŸæŸ“åº¦è­¦å‘Š
                if (gameState.infection >= 80) {
                    addLog("æ„ŸæŸ“å·²ç»éå¸¸ä¸¥é‡ï¼Œæ€¥éœ€æ²»ç–—ï¼", "danger");
                }
            }
            
            // SANå€¼æ¢å¤
            if (gameState.location === "é¿éš¾æ‰€") {
                gameState.san = Math.min(gameState.maxSan, gameState.san + 5);
            }
            
            // è®¾æ–½æ•ˆæœ
            if (gameState.facilities["é›¨æ°´æ”¶é›†å™¨"].level > 0) {
                addItem("ç“¶è£…æ°´", gameState.facilities["é›¨æ°´æ”¶é›†å™¨"].level);
                addLog(`é›¨æ°´æ”¶é›†å™¨æä¾›äº†${gameState.facilities["é›¨æ°´æ”¶é›†å™¨"].level}ç“¶æ°´`, "positive");
            }
            
            if (gameState.facilities["èœå›­"].level > 0) {
                addItem("ç½å¤´", gameState.facilities["èœå›­"].level);
                addLog(`èœå›­æ”¶è·äº†${gameState.facilities["èœå›­"].level}ä¸ªç½å¤´`, "positive");
            }
            
            if (gameState.facilities["åŒ»ç–—ç«™"].level > 0) {
                const healingAmount = 5 * gameState.facilities["åŒ»ç–—ç«™"].level;
                gameState.health = Math.min(gameState.maxHealth, gameState.health + healingAmount);
                
                if (gameState.infection > 0) {
                    const infectionReduction = 2 * gameState.facilities["åŒ»ç–—ç«™"].level;
                    gameState.infection = Math.max(0, gameState.infection - infectionReduction);
                }
                addLog(`åŒ»ç–—ç«™æ¢å¤äº†${healingAmount}ç‚¹ç”Ÿå‘½å€¼`, "positive");
            }
            
            // ç ”ç©¶å®éªŒå®¤æä¾›ç ”ç©¶ç‚¹æ•°
            if (gameState.facilities["ç ”ç©¶å®éªŒå®¤"].level > 0) {
                gameState.researchPoints += gameState.facilities["ç ”ç©¶å®éªŒå®¤"].level;
                addLog(`ç ”ç©¶å®éªŒå®¤æä¾›äº†${gameState.facilities["ç ”ç©¶å®éªŒå®¤"].level}ç‚¹ç ”ç©¶ç‚¹æ•°`, "info");
            }
            
            // äº¤æ˜“ç«™å¸å¼•å•†äºº
            if (gameState.facilities["äº¤æ˜“ç«™"].level > 0 && 
                gameState.day - gameState.lastTraderVisit > 5 && 
                Math.random() < 0.5) {
                // åœ¨åœ°å›¾ä¸Šéšæœºæ”¾ç½®å•†äººè¥åœ°
                const positions = [];
                for (let y = 0; y < 5; y++) {
                    for (let x = 0; x < 5; x++) {
                        if (!gameState.map[y][x]) {
                            positions.push({ x, y });
                        }
                    }
                }
                
                if (positions.length > 0) {
                    const pos = positions[Math.floor(Math.random() * positions.length)];
                    gameState.map[pos.y][pos.x] = "æµæµªå•†äººè¥åœ°";
                    gameState.lastTraderVisit = gameState.day;
                    addLog("æµæµªå•†äººåœ¨é™„è¿‘å»ºç«‹äº†ä¸´æ—¶è¥åœ°", "positive");
                }
            }
            
            // éšæœºä¸§å°¸è¢­å‡»
            if (Math.random() < 0.4 - (0.05 * gameState.facilities["é˜²å¾¡å·¥äº‹"].level) && 
                gameState.day - gameState.lastAttackDay > 2) {
                triggerZombieAttack();
            }
        }

        function updateTimeEffects() {
            // å¤œæ™šæ¢å¤æ›´å¤šç²¾åŠ›ä½†SANå€¼ä¸‹é™
            if (gameState.time === 3) {
                gameState.energy = Math.min(gameState.maxEnergy, gameState.energy + 30);
                gameState.san = Math.max(0, gameState.san - 10);
            } else {
                gameState.energy = Math.max(0, gameState.energy - 15);
            }
            
            // ä¸­åˆæ¸©åº¦æœ€é«˜
            if (gameState.time === 1) {
                if (gameState.weather === "æ™´å¤©") {
                    gameState.temperature += 5;
                }
            }
            
            // å¤œæ™šæ¸©åº¦æœ€ä½
            if (gameState.time === 3) {
                if (gameState.weather !== "æå¯’") {
                    gameState.temperature -= 5;
                }
            }
            
            // æå¯’å¤©æ°”ä¼¤å®³
            if (gameState.weather === "æå¯’" && gameState.temperature < -5) {
                if (!hasStatusEffect("ä¿æš–è¡£ç‰©")) {
                    const damage = Math.floor(Math.random() * 5) + 1;
                    gameState.health = Math.max(0, gameState.health - damage);
                    addLog(`æå¯’å¤©æ°”ä½¿ä½ å¤±å»äº†${damage}ç‚¹ç”Ÿå‘½å€¼`, "danger");
                }
            }
        }

        function processStatusEffects() {
            // å¤„ç†æœ‰é™æŒç»­æ—¶é—´çš„çŠ¶æ€æ•ˆæœ
            gameState.statusEffects = gameState.statusEffects.filter(effect => {
                if (effect.duration !== Infinity) {
                    effect.duration--;
                    return effect.duration > 0;
                }
                return true;
            });
        }

        function triggerRandomEvent() {
            const events = [
                { 
                    msg: "ä½ å¬åˆ°è¿œå¤„æœ‰å°–å«å£°", 
                    type: "info",
                    action: () => {} 
                },
                { 
                    msg: "ä¸€ç¾¤ä¸§å°¸ä»é™„è¿‘ç»è¿‡", 
                    type: "warning",
                    action: () => {
                        if (Math.random() < 0.4) {
                            addLog("ä¸§å°¸å‘ç°äº†ä½ ï¼", "danger");
                            fight();
                        }
                    } 
                },
                { 
                    msg: "æ‰¾åˆ°äº†ä¸€äº›ç‰©èµ„", 
                    type: "positive",
                    action: () => {
                        const resources = gameState.locations[gameState.location].resources;
                        if (resources.length > 0) {
                            const resourceType = resources[Math.floor(Math.random() * resources.length)];
                            
                            switch (resourceType) {
                                case "é£Ÿç‰©":
                                    addItem(Math.random() < 0.7 ? "ç½å¤´" : "ç“¶è£…æ°´", 1);
                                    playSound("success");
                                    break;
                                case "åŒ»ç–—":
                                    addItem(Math.random() < 0.5 ? "ç»·å¸¦" : "æŠ—ç”Ÿç´ ", 1);
                                    playSound("success");
                                    break;
                                case "æ­¦å™¨":
                                    if (Math.random() < 0.2) {
                                        addItem("æ‰‹æª", 1);
                                        playSound("success");
                                    } else {
                                        addItem("æ£’çƒæ£", 1);
                                        playSound("success");
                                    }
                                    break;
                                case "å»ºæ":
                                    addItem(Math.random() < 0.5 ? "æœ¨æ" : "é‡‘å±", 1 + Math.floor(Math.random() * 2));
                                    playSound("success");
                                    break;
                                case "ç ”ç©¶æ•°æ®":
                                    addItem("ç ”ç©¶æ•°æ®", 1);
                                    playSound("success");
                                    break;
                                default:
                                    addItem("å¸ƒæ–™", 1);
                                    playSound("success");
                            }
                        } else {
                            addItem(["æœ¨æ", "é‡‘å±", "å¸ƒæ–™"][Math.floor(Math.random() * 3)], 1);
                            playSound("success");
                        }
                    }
                },
                { 
                    msg: "è¢«ä¸§å°¸æŠ“ä¼¤äº†ï¼", 
                    type: "danger",
                    action: () => {
                        const damage = 20 + Math.floor(Math.random() * 15);
                        gameState.health -= damage;
                        
                        let infectionAmount = 30;
                        if (gameState.equippedArmor === "é˜²æ„ŸæŸ“å¥—è£…") {
                            infectionAmount = Math.floor(infectionAmount * 0.6);
                        }
                        
                        gameState.infection += infectionAmount;
                        gameState.san = Math.max(0, gameState.san - 15);
                        addLog(`å—åˆ°${damage}ç‚¹ä¼¤å®³å¹¶è¢«æ„ŸæŸ“(+${infectionAmount})`, "danger");
                        playSound("fight");
                    }
                },
                { 
                    msg: "å‘ç°ä¸€ä¸ªåºŸå¼ƒçš„èƒŒåŒ…", 
                    type: "positive",
                    action: () => {
                        addItem("ç»·å¸¦", 1);
                        addItem("ç½å¤´", 1);
                        if (Math.random() < 0.2) {
                            addItem("æ‰‹æª", 1);
                            addLog("èƒŒåŒ…é‡Œæœ‰ä¸€æŠŠæ‰‹æªï¼", "positive");
                        }
                        playSound("success");
                    }
                },
                { 
                    msg: "é­é‡äº†ç‰¹æ®Šæ„ŸæŸ“è€…ï¼", 
                    type: "danger",
                    chance: 0.15,
                    action: () => {
                        const specialZombies = ["å°–å«è€…", "è£…ç”²ä¸§å°¸", "å‘•åè€…", "å¿«é€Ÿæ„ŸæŸ“è€…"];
                        const zombie = specialZombies[Math.floor(Math.random() * specialZombies.length)];
                        
                        let damage = 30;
                        let infection = 40;
                        
                        switch (zombie) {
                            case "è£…ç”²ä¸§å°¸":
                                damage = 20;
                                infection = 15;
                                break;
                            case "å¿«é€Ÿæ„ŸæŸ“è€…":
                                damage = 25;
                                infection = 50;
                                break;
                        }
                        
                        // æŠ¤ç”²å‡ä¼¤
                        if (gameState.equippedArmor) {
                            damage = Math.max(0, damage - gameState.inventory[gameState.equippedArmor].defense);
                        }
                        
                        gameState.health -= damage;
                        
                        // é˜²æ„ŸæŸ“å¥—è£…å‡å°‘æ„ŸæŸ“å‡ ç‡
                        if (gameState.equippedArmor !== "é˜²æ„ŸæŸ“å¥—è£…" || Math.random() < 0.6) {
                            gameState.infection += infection;
                        }
                        
                        gameState.san = Math.max(0, gameState.san - 20);
                        
                        addLog(`é­é‡äº†${zombie}ï¼å—åˆ°${damage}ç‚¹ä¼¤å®³`, "danger");
                        playSound("fight");
                        
                        // ç‰¹æ®Šæ„ŸæŸ“è€…æœ‰é¢å¤–æ‰è½
                        if (Math.random() < 0.4) {
                            const rareItems = ["æŠ—ç”Ÿç´ ", "é•‡é™å‰‚", "ç”µå­é›¶ä»¶", "å¼¹è¯", "ç ”ç©¶æ•°æ®"];
                            const rareItem = rareItems[Math.floor(Math.random() * rareItems.length)];
                            addItem(rareItem, 1);
                            addLog(`å‡»è´¥${zombie}åå‘ç°äº†${rareItem}`, "positive");
                            playSound("success");
                        }
                    }
                },
                { 
                    msg: "å‘ç°äº†åºŸå¼ƒå®éªŒå®¤çš„å…¥å£", 
                    type: "info",
                    chance: 0.1,
                    condition: () => gameState.day > 10 && !gameState.discoveredLocations.includes("å®éªŒå®¤"),
                    action: () => {
                        // åœ¨åœ°å›¾ä¸Šéšæœºæ”¾ç½®å®éªŒå®¤
                        const positions = [];
                        for (let y = 0; y < 5; y++) {
                            for (let x = 0; x < 5; x++) {
                                if (!gameState.map[y][x]) {
                                    positions.push({ x, y });
                                }
                            }
                        }
                        
                        if (positions.length > 0) {
                            const pos = positions[Math.floor(Math.random() * positions.length)];
                            gameState.map[pos.y][pos.x] = "å®éªŒå®¤";
                            addLog("åœ°å›¾ä¸Šå‡ºç°äº†ä¸€ä¸ªæ–°çš„åœ°ç‚¹ï¼šå®éªŒå®¤", "info");
                        }
                    }
                }
            ];
            
            const roll = Math.random();
            for (const event of events) {
                // æ£€æŸ¥æ¡ä»¶
                if (event.condition && !event.condition()) continue;
                
                const chance = event.chance || 0.3;
                if (roll < chance) {
                    addLog(event.msg, event.type);
                    event.action();
                    break;
                }
            }
        }

        function triggerZombieAttack() {
            gameState.lastAttackDay = gameState.day;
            gameState.zombieHordeSize = 5 + Math.floor(Math.random() * 5) + Math.floor(gameState.day / 3);
            
            // é˜²å¾¡å·¥äº‹å‡å°‘ä¸§å°¸æ•°é‡
            gameState.zombieHordeSize = Math.max(2, gameState.zombieHordeSize - gameState.facilities["é˜²å¾¡å·¥äº‹"].level);
            
            addLog(`ä¸€ç¾¤ä¸§å°¸(${gameState.zombieHordeSize}åª)è¢­å‡»äº†ä½ çš„é¿éš¾æ‰€ï¼`, "danger");
            playSound("fight");
            
            let defenseBonus = gameState.defense;
            if (gameState.equippedArmor) {
                defenseBonus += gameState.inventory[gameState.equippedArmor].defense;
            }
            
            // æˆ˜æ–—è®¡ç®—
            let damageTaken = Math.max(0, Math.floor(gameState.zombieHordeSize * 8 / (1 + defenseBonus / 10)));
            gameState.health -= damageTaken;
            
            // å‡»æ€éƒ¨åˆ†ä¸§å°¸
            const zombiesKilled = Math.min(gameState.zombieHordeSize, Math.floor(Math.random() * 3) + 1);
            gameState.zombiesKilled += zombiesKilled;
            
            if (gameState.health <= 0) {
                gameState.deathReason = "ä¸§å°¸æ”»ç ´äº†ä½ çš„é˜²å¾¡...";
            } else {
                // å‡»é€€ä¸§å°¸å¯èƒ½è·å¾—èµ„æº
                if (Math.random() < 0.5) {
                    const loot = ["æœ¨æ", "é‡‘å±", "å¸ƒæ–™", "ç”µå­é›¶ä»¶"][Math.floor(Math.random() * 4)];
                    const amount = 1 + Math.floor(Math.random() * 2);
                    addItem(loot, amount);
                    addLog(`å‡»é€€ä¸§å°¸åæ‰¾åˆ°äº†${amount}ä¸ª${loot}`, "positive");
                    playSound("success");
                }
                
                addLog(`å‡»é€€äº†ä¸§å°¸ç¾¤ï¼Œå‡»æ€${zombiesKilled}åªï¼Œä½†å—åˆ°${damageTaken}ç‚¹ä¼¤å®³`, damageTaken > 15 ? "danger" : "warning");
            }
        }

        // ======================
        // ç©å®¶è¡ŒåŠ¨
        // ======================
        function explore() {
            if (gameState.health <= 0) return;
            if (gameState.energy < 25) {
                addLog("å¤ªç´¯äº†ï¼Œæ— æ³•æ¢ç´¢", "warning");
                return;
            }
            
            playSound("click");
            gameState.energy -= 25;
            
            const outcomes = [
                { 
                    msg: "æ¢ç´¢äº†å‘¨å›´åŒºåŸŸï¼Œä½†ä»€ä¹ˆä¹Ÿæ²¡æ‰¾åˆ°", 
                    chance: 0.4 
                },
                { 
                    msg: "å‘ç°äº†ä¸€äº›æœ‰ç”¨çš„ç‰©èµ„", 
                    chance: 0.3, 
                    action: () => {
                        const resources = gameState.locations[gameState.location].resources;
                        if (resources.length > 0) {
                            const resourceType = resources[Math.floor(Math.random() * resources.length)];
                            
                            switch (resourceType) {
                                case "é£Ÿç‰©":
                                    addItem(Math.random() < 0.7 ? "ç½å¤´" : "ç“¶è£…æ°´", 1);
                                    playSound("success");
                                    break;
                                case "åŒ»ç–—":
                                    addItem(Math.random() < 0.5 ? "ç»·å¸¦" : "æŠ—ç”Ÿç´ ", 1);
                                    playSound("success");
                                    break;
                                case "æ­¦å™¨":
                                    if (Math.random() < 0.2) {
                                        addItem("æ‰‹æª", 1);
                                        playSound("success");
                                    } else {
                                        addItem("æ£’çƒæ£", 1);
                                        playSound("success");
                                    }
                                    break;
                                case "å»ºæ":
                                    addItem(Math.random() < 0.5 ? "æœ¨æ" : "é‡‘å±", 1);
                                    playSound("success");
                                    break;
                                case "ç ”ç©¶æ•°æ®":
                                    addItem("ç ”ç©¶æ•°æ®", 1);
                                    playSound("success");
                                    break;
                                default:
                                    addItem("å¸ƒæ–™", 1);
                                    playSound("success");
                            }
                        } else {
                            addItem(["æœ¨æ", "é‡‘å±", "å¸ƒæ–™"][Math.floor(Math.random() * 3)], 1);
                            playSound("success");
                        }
                    }
                },
                { 
                    msg: "é­é‡äº†ä¸§å°¸ï¼", 
                    chance: 0.3, 
                    action: () => {
                        playSound("fight");
                        fight();
                    }
                }
            ];
            
            const roll = Math.random();
            let cumulativeChance = 0;
            for (const outcome of outcomes) {
                cumulativeChance += outcome.chance;
                if (roll <= cumulativeChance) {
                    addLog(outcome.msg, outcome.type || "info");
                    if (outcome.action) outcome.action();
                    break;
                }
            }
            
            // æ¢ç´¢é™ä½SANå€¼
            if (gameState.location !== "é¿éš¾æ‰€") {
                gameState.san = Math.max(0, gameState.san - 10);
            }
            
            updateUI();
        }

        function scavenge() {
            if (gameState.health <= 0) return;
            if (gameState.energy < 20) {
                addLog("å¤ªç´¯äº†ï¼Œæ— æ³•æœåˆ®", "warning");
                return;
            }
            
            if (gameState.location === "é¿éš¾æ‰€") {
                addLog("è¿™é‡Œæ²¡æœ‰æ›´å¤šç‰©èµ„äº†", "info");
                return;
            }
            
            playSound("click");
            gameState.energy -= 20;
            
            // æœåˆ®æœ‰æ›´é«˜å‡ ç‡æ‰¾åˆ°ç‰©èµ„ä½†ä¹Ÿæ›´å±é™©
            const outcomes = [
                { 
                    msg: "ä»”ç»†æœåˆ®ä½†æ²¡æœ‰å‘ç°ä»»ä½•ä¸œè¥¿", 
                    chance: 0.3 
                },
                { 
                    msg: "æ‰¾åˆ°äº†ä¸€äº›ç‰©èµ„", 
                    chance: 0.4, 
                    action: () => {
                        const resources = gameState.locations[gameState.location].resources;
                        let itemCount = 0;
                        
                        for (let i = 0; i < 2; i++) {
                            if (resources.length > 0 && Math.random() < 0.7) {
                                const resourceType = resources[Math.floor(Math.random() * resources.length)];
                                
                                switch (resourceType) {
                                    case "é£Ÿç‰©":
                                        addItem(Math.random() < 0.7 ? "ç½å¤´" : "ç“¶è£…æ°´", 1);
                                        playSound("success");
                                        break;
                                    case "åŒ»ç–—":
                                        addItem(Math.random() < 0.5 ? "ç»·å¸¦" : "æŠ—ç”Ÿç´ ", 1);
                                        playSound("success");
                                        break;
                                    case "æ­¦å™¨":
                                        if (Math.random() < 0.1) {
                                            addItem("æ‰‹æª", 1);
                                            playSound("success");
                                        } else {
                                            addItem("æ£’çƒæ£", 1);
                                            playSound("success");
                                        }
                                        break;
                                    case "å»ºæ":
                                        addItem(Math.random() < 0.5 ? "æœ¨æ" : "é‡‘å±", 1);
                                        playSound("success");
                                        break;
                                    case "ç ”ç©¶æ•°æ®":
                                        addItem("ç ”ç©¶æ•°æ®", 1);
                                        playSound("success");
                                        break;
                                    default:
                                        addItem("å¸ƒæ–™", 1);
                                        playSound("success");
                                }
                                itemCount++;
                            }
                        }
                        
                        if (itemCount === 0) {
                            addItem(["æœ¨æ", "é‡‘å±", "å¸ƒæ–™"][Math.floor(Math.random() * 3)], 1);
                            playSound("success");
                        }
                    }
                },
                { 
                    msg: "æœåˆ®æ—¶æƒŠåŠ¨äº†ä¸§å°¸ï¼", 
                    chance: 0.3, 
                    action: () => {
                        // æœåˆ®é­é‡æˆ˜æ›´å±é™©
                        gameState.health -= 10;
                        addLog("æœåˆ®å£°éŸ³å¼•æ¥äº†æ›´å¤šä¸§å°¸", "danger");
                        playSound("fight");
                        fight();
                    }
                }
            ];
            
            const roll = Math.random();
            let cumulativeChance = 0;
            for (const outcome of outcomes) {
                cumulativeChance += outcome.chance;
                if (roll <= cumulativeChance) {
                    addLog(outcome.msg, outcome.type || "info");
                    if (outcome.action) outcome.action();
                    break;
                }
            }
            
            // æœåˆ®å¤§å¹…é™ä½SANå€¼
            gameState.san = Math.max(0, gameState.san - 15);
            updateUI();
        }

        function rest() {
            if (gameState.health <= 0) return;
            if (gameState.location !== "é¿éš¾æ‰€") {
                addLog("åªæœ‰é¿éš¾æ‰€æ‰èƒ½å®‰å…¨ä¼‘æ¯", "warning");
                return;
            }
            
            playSound("click");
            const healthRecovered = Math.min(15, gameState.maxHealth - gameState.health);
            gameState.health += healthRecovered;
            gameState.energy = Math.min(gameState.maxEnergy, gameState.energy + 25);
            gameState.san = Math.min(gameState.maxSan, gameState.san + 5);
            
            addLog(`ä¼‘æ¯æ¢å¤äº† ${healthRecovered} ç‚¹ç”Ÿå‘½å€¼å’Œ 25 ç‚¹ç²¾åŠ›`, "positive");
            updateUI();
        }

        function eat() {
            if (gameState.health <= 0) return;
            if (useItem("ç½å¤´", 1)) {
                playSound("eat");
                gameState.hunger = Math.min(gameState.maxHunger, gameState.hunger + 30);
                addLog("åƒäº†ä¸€ä¸ªç½å¤´ï¼Œä¸é‚£ä¹ˆé¥¿äº†", "positive");
            } else if (useItem("ç“¶è£…æ°´", 1)) {
                playSound("eat");
                gameState.hunger = Math.min(gameState.maxHunger, gameState.hunger + 10);
                addLog("å–äº†ä¸€ç“¶æ°´ï¼Œç¨å¾®ç¼“è§£äº†é¥¥æ¸´", "info");
            } else {
                addLog("æ²¡æœ‰é£Ÿç‰©å¯åƒ", "warning");
            }
            updateUI();
        }

        function fight() {
            if (gameState.health <= 0) return;
            if (gameState.energy < 20) {
                addLog("å¤ªç´¯äº†ï¼Œæ— æ³•æœ‰æ•ˆæˆ˜æ–—", "warning");
                return;
            }
            
            playSound("fight");
            gameState.energy -= 20;
            
            let baseDamage = 8;
            if (gameState.equippedWeapon) {
                const weapon = gameState.inventory[gameState.equippedWeapon];
                baseDamage = weapon.damage;
                
                // æ­¦å™¨è€ä¹…æŸè€—
                weapon.durability = Math.max(0, weapon.durability - 8);
                if (weapon.durability <= 0) {
                    addLog(`${gameState.equippedWeapon}æŸåäº†ï¼`, "danger");
                    weapon.count--;
                    if (weapon.count <= 0) {
                        delete gameState.inventory[gameState.equippedWeapon];
                        gameState.equippedWeapon = null;
                    }
                }
                
                // è¿œç¨‹æ­¦å™¨éœ€è¦å¼¹è¯
                if (gameState.equippedWeapon === "æ‰‹æª" || gameState.equippedWeapon === "çŒæª" || gameState.equippedWeapon === "ç«ç„°å–·å°„å™¨") {
                    if (weapon.ammo <= 0) {
                        addLog("æ²¡æœ‰å¼¹è¯äº†ï¼", "danger");
                        baseDamage = 5; // ä»ç„¶å¯ä»¥ç”¨æªæ‰˜æ”»å‡»
                    } else {
                        weapon.ammo--;
                    }
                }
            }
            
            // åº”ç”¨æŠ€èƒ½åŠ æˆ
            if (gameState.equippedWeapon && (gameState.equippedWeapon === "æ‰‹æª" || gameState.equippedWeapon === "çŒæª")) {
                baseDamage *= gameState.rangedDamageBonus;
            } else if (gameState.equippedWeapon) {
                baseDamage *= gameState.meleeDamageBonus;
            }
            
            const damage = Math.floor(baseDamage * (0.8 + Math.random() * 0.4));
            
            if (Math.random() < 0.6) { // 60% æˆåŠŸå‡ ç‡
                let damageTaken = Math.floor(Math.random() * 20) + 5 - Math.floor(gameState.defense / 3);
                
                if (gameState.equippedArmor) {
                    const armor = gameState.inventory[gameState.equippedArmor];
                    damageTaken = Math.max(0, damageTaken - armor.defense);
                    
                    // æŠ¤ç”²è€ä¹…æŸè€—
                    armor.durability = Math.max(0, armor.durability - 5);
                    if (armor.durability <= 0) {
                        addLog(`${gameState.equippedArmor}æŸåäº†ï¼`, "danger");
                        armor.count--;
                        if (armor.count <= 0) {
                            delete gameState.inventory[gameState.equippedArmor];
                            gameState.equippedArmor = null;
                        }
                    }
                }
                
                gameState.health -= Math.max(0, damageTaken);
                
                if (Math.random() < 0.5) { // 50% å‡ ç‡è¢«æ„ŸæŸ“
                    let infectionAmount = 15 + Math.floor(Math.random() * 10);
                    
                    // é˜²æ„ŸæŸ“å¥—è£…å‡å°‘æ„ŸæŸ“å‡ ç‡
                    if (gameState.equippedArmor === "é˜²æ„ŸæŸ“å¥—è£…") {
                        infectionAmount = Math.floor(infectionAmount * 0.6);
                    }
                    
                    gameState.infection += infectionAmount;
                    addLog(`å‡»é€€äº†ä¸§å°¸ä½†å—åˆ° ${damageTaken} ç‚¹ä¼¤å®³å¹¶è¢«æ„ŸæŸ“(+${infectionAmount})`, "danger");
                } else {
                    addLog(`å‡»é€€äº†ä¸§å°¸ä½†å—åˆ° ${damageTaken} ç‚¹ä¼¤å®³`, damageTaken > 15 ? "danger" : "warning");
                }
                
                // æˆ˜æ–—å¥–åŠ±
                if (Math.random() < 0.5) {
                    const loot = ["ç»·å¸¦", "ç½å¤´", "æœ¨æ", "é‡‘å±"][Math.floor(Math.random() * 4)];
                    addItem(loot, 1);
                    playSound("success");
                }
                
                // å‡»æ€ä¸§å°¸è®¡æ•°
                gameState.zombiesKilled++;
            } else {
                addLog("æˆåŠŸå‡»é€€ä¸§å°¸ä¸”æœªå—ä¼¤", "positive");
                if (Math.random() < 0.5) {
                    addItem("ç½å¤´", 1);
                    playSound("success");
                }
            }
            
            // æˆ˜æ–—é™ä½SANå€¼
            gameState.san = Math.max(0, gameState.san - 15);
            
            updateUI();
        }

        function craft() {
            if (gameState.health <= 0) return;
            playSound("click");
            openCraftModal();
        }

        function build() {
            if (gameState.health <= 0) return;
            playSound("click");
            openBuildModal();
        }

        function showSkills() {
            if (gameState.health <= 0) return;
            playSound("click");
            openSkillsModal();
        }

        function research() {
            if (gameState.health <= 0) return;
            if (gameState.facilities["ç ”ç©¶å®éªŒå®¤"].level === 0) {
                addLog("éœ€è¦å»ºé€ ç ”ç©¶å®éªŒå®¤æ‰èƒ½è¿›è¡Œç ”ç©¶", "warning");
                return;
            }
            playSound("click");
            openResearchModal();
        }

        function trade() {
            if (gameState.health <= 0) return;
            if (gameState.location !== "æµæµªå•†äººè¥åœ°") {
                addLog("åªæœ‰åœ¨æµæµªå•†äººè¥åœ°æ‰èƒ½äº¤æ˜“", "warning");
                return;
            }
            playSound("click");
            openTradeModal();
        }

        function treat() {
            if (gameState.health <= 0) return;
            if (useItem("ç»·å¸¦", 1)) {
                playSound("success");
                const healing = Math.floor(15 * gameState.healingBonus);
                gameState.health = Math.min(gameState.maxHealth, gameState.health + healing);
                addLog(`ä½¿ç”¨ç»·å¸¦æ¢å¤äº†${healing}ç‚¹ç”Ÿå‘½å€¼`, "positive");
            } else if (useItem("æŠ—ç”Ÿç´ ", 1)) {
                playSound("success");
                const infectionReduction = Math.floor(20 * gameState.healingBonus);
                gameState.infection = Math.max(0, gameState.infection - infectionReduction);
                addLog(`ä½¿ç”¨æŠ—ç”Ÿç´ é™ä½äº†${infectionReduction}ç‚¹æ„ŸæŸ“ç¨‹åº¦`, "positive");
            } else if (useItem("é•‡é™å‰‚", 1)) {
                playSound("success");
                gameState.san = Math.min(gameState.maxSan, gameState.san + 15);
                addLog("ä½¿ç”¨é•‡é™å‰‚ç¨³å®šäº†ç²¾ç¥çŠ¶æ€", "positive");
            } else if (useItem("æŠ—ç—…æ¯’è¡€æ¸…", 1)) {
                playSound("success");
                gameState.infection = Math.max(0, gameState.infection - 50);
                addLog("ä½¿ç”¨æŠ—ç—…æ¯’è¡€æ¸…å¤§å¹…é™ä½äº†æ„ŸæŸ“ç¨‹åº¦", "positive");
            } else {
                addLog("æ²¡æœ‰å¯ç”¨çš„åŒ»ç–—ç‰©å“", "warning");
            }
            updateUI();
        }

        function travel(x, y) {
            if (gameState.health <= 0) return;
            if (x < 0 || x >= 5 || y < 0 || y >= 5) {
                addLog("æ— æ³•å‘é‚£ä¸ªæ–¹å‘ç§»åŠ¨", "warning");
                return;
            }
            
            const destination = gameState.map[y][x];
            if (!destination) {
                addLog("é‚£é‡Œä»€ä¹ˆéƒ½æ²¡æœ‰", "info");
                return;
            }
            
            if (destination === gameState.location) {
                addLog("ä½ å·²ç»åœ¨è¿™é‡Œäº†", "info");
                return;
            }
            
            // æ—…è¡Œæ¶ˆè€—èƒ½é‡
            const distance = Math.abs(x - gameState.currentPosition.x) + Math.abs(y - gameState.currentPosition.y);
            const energyCost = distance * 15;
            
            if (gameState.energy < energyCost) {
                addLog("æ²¡æœ‰è¶³å¤Ÿçš„ç²¾åŠ›å‰å¾€é‚£é‡Œ", "warning");
                return;
            }
            
            playSound("click");
            gameState.energy -= energyCost;
            gameState.currentPosition = { x, y };
            gameState.location = destination;
            
            // å‘ç°æ–°åœ°ç‚¹
            if (!gameState.discoveredLocations.includes(destination)) {
                gameState.discoveredLocations.push(destination);
                addLog(`å‘ç°äº†æ–°çš„åœ°ç‚¹ï¼š${destination}`, "positive");
                playSound("success");
                
                // å‘ç°æ–°åœ°ç‚¹å¥–åŠ±
                gameState.skillPoints++;
                addLog("å› æ¢ç´¢è·å¾—1ç‚¹æŠ€èƒ½ç‚¹", "positive");
                playSound("success");
            }
            
            // æ›´æ–°ä½ç½®æè¿°
            elements["location-description"].textContent = gameState.locations[destination].description;
            
            // æ—…è¡Œå¯èƒ½é­é‡éšæœºäº‹ä»¶
            if (Math.random() < 0.5) {
                triggerRandomEvent();
            }
            
            addLog(`ç§»åŠ¨åˆ°äº†${destination}`, "info");
            updateUI();
        }

        // ======================
        // ä¿å­˜å’ŒåŠ è½½åŠŸèƒ½
        // ======================
        function saveGame(slot = 1) {
            try {
                playSound("click");
                const saveData = JSON.stringify(gameState);
                localStorage.setItem(`survival_hard_save_${slot}`, saveData);
                addLog(`æ¸¸æˆå·²ä¿å­˜åˆ°å­˜æ¡£ ${slot}`, "positive");
                return true;
            } catch (e) {
                addLog("ä¿å­˜æ¸¸æˆå¤±è´¥", "danger");
                console.error("ä¿å­˜é”™è¯¯:", e);
                return false;
            }
        }

        function loadGame(slot = 1) {
            try {
                playSound("click");
                const saveData = localStorage.getItem(`survival_hard_save_${slot}`);
                if (!saveData) {
                    addLog(`å­˜æ¡£ ${slot} ä¸å­˜åœ¨`, "warning");
                    return false;
                }
                
                const loadedState = JSON.parse(saveData);
                
                // ç®€å•éªŒè¯å­˜æ¡£æ•°æ®
                if (!loadedState.version || !loadedState.day || !loadedState.inventory) {
                    addLog("å­˜æ¡£æ•°æ®æŸå", "danger");
                    return false;
                }
                
                // åˆå¹¶åŠ è½½çš„çŠ¶æ€åˆ°å½“å‰æ¸¸æˆçŠ¶æ€
                Object.assign(gameState, loadedState);
                
                // å…³é—­åŠ è½½æ¨¡æ€æ¡†
                document.getElementById("load-modal").style.display = "none";
                
                addLog(`ä»å­˜æ¡£ ${slot} åŠ è½½æ¸¸æˆ`, "positive");
                updateUI();
                return true;
            } catch (e) {
                addLog("åŠ è½½æ¸¸æˆå¤±è´¥", "danger");
                console.error("åŠ è½½é”™è¯¯:", e);
                return false;
            }
        }

        function openLoadModal() {
            playSound("click");
            document.getElementById("load-modal").style.display = "block";
        }

        // ======================
        // ç‰©å“å’Œè£…å¤‡ç®¡ç†
        // ======================
        function addItem(item, quantity = 1) {
            if (!gameState.inventory[item]) {
                // å¦‚æœæ˜¯æ–°ç‰©å“ï¼Œåˆå§‹åŒ–å®ƒçš„å±æ€§
                switch (item) {
                    case "æœ¨åˆ¶é•¿çŸ›":
                        gameState.inventory[item] = { type: "weapon", count: 0, damage: 10, durability: 35 };
                        break;
                    case "ç®€æ˜“é™·é˜±":
                        gameState.inventory[item] = { type: "tool", count: 0, effect: "å¢åŠ æœåˆ®æˆåŠŸç‡" };
                        break;
                    case "é“åˆ¶æŠ¤ç”²":
                        gameState.inventory[item] = { type: "armor", count: 0, defense: 5, durability: 45 };
                        break;
                    case "çŒæª":
                        gameState.inventory[item] = { type: "weapon", count: 0, damage: 35, ammo: 0, maxAmmo: 6, durability: 70 };
                        break;
                    case "ç«ç„°å–·å°„å™¨":
                        gameState.inventory[item] = { type: "weapon", count: 0, damage: 50, ammo: 0, maxAmmo: 20, durability: 100 };
                        break;
                    case "å†›ç”¨æŠ¤ç”²":
                        gameState.inventory[item] = { type: "armor", count: 0, defense: 10, durability: 70 };
                        break;
                    case "é˜²æ„ŸæŸ“å¥—è£…":
                        gameState.inventory[item] = { type: "armor", count: 0, defense: 4, durability: 40, effect: { infectionResist: 40 } };
                        break;
                    case "æŠ—ç—…æ¯’è¡€æ¸…":
                        gameState.inventory[item] = { type: "medical", count: 0, effect: { infection: -50 } };
                        break;
                    default:
                        gameState.inventory[item] = { type: "resource", count: 0 };
                }
            }
            
            gameState.inventory[item].count += quantity;
            return true;
        }

        function useItem(item, quantity = 1) {
            if (gameState.inventory[item] && gameState.inventory[item].count >= quantity) {
                gameState.inventory[item].count -= quantity;
                
                if (gameState.inventory[item].count <= 0) {
                    delete gameState.inventory[item];
                    
                    // å¦‚æœè£…å¤‡è¢«ç”¨å®Œï¼Œå–æ¶ˆè£…å¤‡
                    if (gameState.equippedWeapon === item) {
                        gameState.equippedWeapon = null;
                    }
                    if (gameState.equippedArmor === item) {
                        gameState.equippedArmor = null;
                    }
                }
                
                return true;
            }
            return false;
        }

        function equipItem(item) {
            if (!gameState.inventory[item]) return false;
            
            const itemData = gameState.inventory[item];
            
            if (itemData.type === "weapon") {
                gameState.equippedWeapon = item;
                addLog(`è£…å¤‡äº†${item}`, "positive");
                playSound("success");
                return true;
            } else if (itemData.type === "armor") {
                gameState.equippedArmor = item;
                addLog(`è£…å¤‡äº†${item}`, "positive");
                playSound("success");
                return true;
            }
            
            return false;
        }

        function hasItem(item, quantity = 1) {
            return gameState.inventory[item] && gameState.inventory[item].count >= quantity;
        }

        function hasStatusEffect(effectName) {
            return gameState.statusEffects.some(effect => effect.name === effectName);
        }

        // ======================
        // åˆ¶ä½œç³»ç»Ÿ
        // ======================
        function openCraftModal() {
            const modal = document.getElementById("craft-modal");
            const recipesContainer = document.getElementById("craft-recipes");
            
            recipesContainer.innerHTML = "";
            
            // æ˜¾ç¤ºæ‰€æœ‰å¯åˆ¶ä½œçš„é…æ–¹
            for (const [recipeName, recipe] of Object.entries(gameState.recipes)) {
                // æ£€æŸ¥æ˜¯å¦æ»¡è¶³å‰ææ¡ä»¶
                let canCraft = true;
                if (recipe.requires) {
                    for (const [facility, level] of Object.entries(recipe.requires)) {
                        if (gameState.facilities[facility].level < level) {
                            canCraft = false;
                            break;
                        }
                    }
                }
                
                // æ£€æŸ¥ææ–™æ˜¯å¦è¶³å¤Ÿ
                for (const [material, amount] of Object.entries(recipe.materials)) {
                    if (!hasItem(material, amount)) {
                        canCraft = false;
                        break;
                    }
                }
                
                const recipeElement = document.createElement("div");
                recipeElement.className = "recipe";
                recipeElement.style.opacity = canCraft ? 1 : 0.5;
                
                let html = `<div class="recipe-name">${recipeName}</div>`;
                html += `<div class="recipe-materials">éœ€è¦: `;
                
                for (const [material, amount] of Object.entries(recipe.materials)) {
                    html += `${material} x${amount} `;
                }
                
                html += `</div>`;
                
                if (recipe.requires) {
                    html += `<div class="recipe-requirements">å‰æ: `;
                    for (const [facility, level] of Object.entries(recipe.requires)) {
                        html += `${facility} Lv.${level} `;
                    }
                    html += `</div>`;
                }
                
                if (canCraft) {
                    html += `<button class="btn" onclick="craftItem('${recipeName}')" style="width: 100%; margin-top: 5px;">åˆ¶ä½œ</button>`;
                } else {
                    html += `<button class="btn btn-disabled" style="width: 100%; margin-top: 5px;" disabled>æ— æ³•åˆ¶ä½œ</button>`;
                }
                
                recipeElement.innerHTML = html;
                recipesContainer.appendChild(recipeElement);
            }
            
            modal.style.display = "block";
        }

        function craftItem(recipeName) {
            const recipe = gameState.recipes[recipeName];
            
            // å†æ¬¡æ£€æŸ¥ææ–™
            for (const [material, amount] of Object.entries(recipe.materials)) {
                if (!hasItem(material, amount)) {
                    addLog(`åˆ¶ä½œ${recipeName}ç¼ºå°‘${material}`, "warning");
                    return;
                }
            }
            
            // æ¶ˆè€—ææ–™
            for (const [material, amount] of Object.entries(recipe.materials)) {
                useItem(material, amount);
            }
            
            // æ·»åŠ æˆå“
            const resultItem = Object.keys(recipe.result)[0];
            const resultAmount = recipe.result[resultItem];
            
            addItem(resultItem, resultAmount);
            addLog(`æˆåŠŸåˆ¶ä½œäº†${resultItem} x${resultAmount}`, "positive");
            playSound("craft");
            
            // å…³é—­æ¨¡æ€æ¡†
            document.getElementById("craft-modal").style.display = "none";
            updateUI();
        }

        // ======================
        // å»ºé€ ç³»ç»Ÿ
        // ======================
        function openBuildModal() {
            const modal = document.getElementById("build-modal");
            const buildContainer = document.getElementById("build-options");
            
            buildContainer.innerHTML = "";
            
            // æ˜¾ç¤ºæ‰€æœ‰å¯å»ºé€ /å‡çº§çš„è®¾æ–½
            for (const [facilityName, facility] of Object.entries(gameState.facilities)) {
                // æ£€æŸ¥æ˜¯å¦å¯ä»¥å‡çº§
                const canUpgrade = facility.level < facility.maxLevel;
                
                // æ£€æŸ¥èµ„æºæ˜¯å¦è¶³å¤Ÿ
                let canBuild = true;
                if (canUpgrade) {
                    for (const [material, amount] of Object.entries(facility.requirements)) {
                        if (!hasItem(material, amount)) {
                            canBuild = false;
                            break;
                        }
                    }
                }
                
                const facilityElement = document.createElement("div");
                facilityElement.className = "facility";
                
                let html = `<div><strong>${facilityName}</strong> Lv.${facility.level}/${facility.maxLevel}</div>`;
                html += `<div style="font-size: 12px; margin: 5px 0;">${facility.description}</div>`;
                
                if (canUpgrade) {
                    html += `<div style="font-size: 12px; margin-bottom: 5px;">å‡çº§éœ€è¦: `;
                    for (const [material, amount] of Object.entries(facility.requirements)) {
                        html += `${material} x${amount} `;
                    }
                    html += `</div>`;
                    
                    if (canBuild) {
                        html += `<button class="btn" onclick="upgradeFacility('${facilityName}')" style="width: 100%;">å‡çº§</button>`;
                    } else {
                        html += `<button class="btn btn-disabled" style="width: 100%;" disabled>èµ„æºä¸è¶³</button>`;
                    }
                } else {
                    html += `<div style="font-size: 12px; color: #999;">å·²è¾¾åˆ°æœ€å¤§ç­‰çº§</div>`;
                }
                
                facilityElement.innerHTML = html;
                buildContainer.appendChild(facilityElement);
            }
            
            modal.style.display = "block";
        }

        function upgradeFacility(facilityName) {
            const facility = gameState.facilities[facilityName];
            
            // å†æ¬¡æ£€æŸ¥æ˜¯å¦å¯ä»¥å‡çº§
            if (facility.level >= facility.maxLevel) {
                addLog(`${facilityName}å·²ç»è¾¾åˆ°æœ€å¤§ç­‰çº§`, "warning");
                return;
            }
            
            // æ£€æŸ¥ææ–™
            for (const [material, amount] of Object.entries(facility.requirements)) {
                if (!hasItem(material, amount)) {
                    addLog(`å‡çº§${facilityName}ç¼ºå°‘${material}`, "warning");
                    return;
                }
            }
            
            // æ¶ˆè€—ææ–™
            for (const [material, amount] of Object.entries(facility.requirements)) {
                useItem(material, amount);
            }
            
            // å‡çº§è®¾æ–½
            facility.level++;
            addLog(`${facilityName}å·²å‡çº§åˆ°ç­‰çº§ ${facility.level}`, "positive");
            playSound("craft");
            
            // å…³é—­æ¨¡æ€æ¡†
            document.getElementById("build-modal").style.display = "none";
            updateUI();
        }

        // ======================
        // æŠ€èƒ½ç³»ç»Ÿ
        // ======================
        function openSkillsModal() {
            const modal = document.getElementById("skills-modal");
            const skillPointsElement = document.getElementById("skill-points");
            const skillTreesContainer = document.getElementById("skill-trees");
            
            skillPointsElement.textContent = gameState.skillPoints;
            skillTreesContainer.innerHTML = "";
            
            // æ˜¾ç¤ºæ‰€æœ‰æŠ€èƒ½
            for (const [skillName, skill] of Object.entries(gameState.skills)) {
                const skillElement = document.createElement("div");
                skillElement.className = "skill";
                
                // ç¡®å®šæŠ€èƒ½çŠ¶æ€
                if (skill.learned) {
                    skillElement.classList.add("learned");
                } else {
                    // æ£€æŸ¥å‰ææ¡ä»¶
                    let requirementsMet = true;
                    for (const req of skill.requirements) {
                        if (!gameState.skills[req].learned) {
                            requirementsMet = false;
                            break;
                        }
                    }
                    
                    if (requirementsMet && gameState.skillPoints >= skill.cost) {
                        skillElement.classList.add("available");
                    } else {
                        skillElement.classList.add("unavailable");
                    }
                }
                
                let html = `<div><strong>${skillName}</strong></div>`;
                html += `<div style="font-size: 12px; margin: 5px 0;">${skill.description}</div>`;
                html += `<div style="font-size: 11px; color: #999;">æ¶ˆè€—: ${skill.cost}ç‚¹`;
                
                if (skill.requirements.length > 0) {
                    html += ` | å‰æ: ${skill.requirements.join(", ")}`;
                }
                
                html += `</div>`;
                
                if (!skill.learned) {
                    if (skillElement.classList.contains("available")) {
                        html += `<button class="btn" onclick="learnSkill('${skillName}')" style="width: 100%; margin-top: 5px;">å­¦ä¹ </button>`;
                    } else {
                        html += `<button class="btn btn-disabled" style="width: 100%; margin-top: 5px;" disabled>æ— æ³•å­¦ä¹ </button>`;
                    }
                } else {
                    html += `<button class="btn btn-disabled" style="width: 100%; margin-top: 5px;" disabled>å·²å­¦ä¹ </button>`;
                }
                
                skillElement.innerHTML = html;
                skillTreesContainer.appendChild(skillElement);
            }
            
            modal.style.display = "block";
        }

        function learnSkill(skillName) {
            const skill = gameState.skills[skillName];
            
            // æ£€æŸ¥æ˜¯å¦å·²ç»å­¦ä¼š
            if (skill.learned) {
                addLog(`å·²ç»å­¦ä¼šäº†${skillName}`, "warning");
                return;
            }
            
            // æ£€æŸ¥æŠ€èƒ½ç‚¹
            if (gameState.skillPoints < skill.cost) {
                addLog(`æŠ€èƒ½ç‚¹ä¸è¶³ï¼Œæ— æ³•å­¦ä¹ ${skillName}`, "warning");
                return;
            }
            
            // æ£€æŸ¥å‰ææ¡ä»¶
            for (const req of skill.requirements) {
                if (!gameState.skills[req].learned) {
                    addLog(`å­¦ä¹ ${skillName}éœ€è¦å…ˆå­¦ä¹ ${req}`, "warning");
                    return;
                }
            }
            
            // å­¦ä¹ æŠ€èƒ½
            gameState.skillPoints -= skill.cost;
            skill.learned = true;
            
            // åº”ç”¨æŠ€èƒ½æ•ˆæœ
            if (skill.effect) {
                skill.effect();
            }
            
            addLog(`å­¦ä¼šäº†æ–°æŠ€èƒ½ï¼š${skillName}`, "positive");
            playSound("success");
            
            // åˆ·æ–°æŠ€èƒ½ç•Œé¢
            openSkillsModal();
            updateUI();
        }

        // ======================
        // ç ”ç©¶ç³»ç»Ÿ
        // ======================
        function openResearchModal() {
            const modal = document.getElementById("research-modal");
            const researchContainer = document.getElementById("research-options");
            const researchPoints = document.getElementById("research-points");
            
            researchPoints.textContent = gameState.researchPoints;
            researchContainer.innerHTML = "";
            
            // æ˜¾ç¤ºæ‰€æœ‰å¯ç ”ç©¶çš„é¡¹ç›®
            for (const [researchName, research] of Object.entries(gameState.researches)) {
                // æ£€æŸ¥æ˜¯å¦å·²ç»ç ”ç©¶
                if (research.learned) continue;
                
                // æ£€æŸ¥å‰ææ¡ä»¶
                let requirementsMet = true;
                for (const req of research.requirements) {
                    if (!gameState.researches[req].learned) {
                        requirementsMet = false;
                        break;
                    }
                }
                
                // æ£€æŸ¥æ˜¯å¦æœ‰è¶³å¤Ÿçš„ç ”ç©¶ç‚¹æ•°
                const canResearch = requirementsMet && gameState.researchPoints >= research.cost;
                
                const researchElement = document.createElement("div");
                researchElement.className = "research";
                researchElement.style.opacity = canResearch ? 1 : 0.5;
                
                let html = `<div class="research-name">${researchName}</div>`;
                html += `<div class="research-desc">${research.description}</div>`;
                html += `<div style="font-size: 11px; color: #999;">æ¶ˆè€—: ç ”ç©¶ç‚¹æ•° x${research.cost}`;
                
                if (research.requirements.length > 0) {
                    html += ` | å‰æ: ${research.requirements.join(", ")}`;
                }
                
                html += `</div>`;
                
                if (canResearch) {
                    html += `<button class="btn" onclick="startResearch('${researchName}')" style="width: 100%; margin-top: 5px;">ç ”ç©¶</button>`;
                } else {
                    html += `<button class="btn btn-disabled" style="width: 100%; margin-top: 5px;" disabled>æ— æ³•ç ”ç©¶</button>`;
                }
                
                researchElement.innerHTML = html;
                researchContainer.appendChild(researchElement);
            }
            
            modal.style.display = "block";
        }

        function startResearch(researchName) {
            const research = gameState.researches[researchName];
            
            // å†æ¬¡æ£€æŸ¥ç ”ç©¶ç‚¹æ•°
            if (gameState.researchPoints < research.cost) {
                addLog(`ç ”ç©¶${researchName}éœ€è¦${research.cost}ç‚¹ç ”ç©¶ç‚¹æ•°`, "warning");
                return;
            }
            
            // æ¶ˆè€—ç ”ç©¶ç‚¹æ•°
            gameState.researchPoints -= research.cost;
            
            // å®Œæˆç ”ç©¶
            research.learned = true;
            
            // è§£é”ç›¸å…³é…æ–¹
            if (research.unlocks) {
                for (const item of research.unlocks) {
                    addLog(`è§£é”äº†æ–°é…æ–¹ï¼š${item}`, "info");
                }
            }
            
            addLog(`å®Œæˆäº†ç ”ç©¶ï¼š${researchName}`, "positive");
            playSound("success");
            
            // å…³é—­ç ”ç©¶ç•Œé¢
            document.getElementById("research-modal").style.display = "none";
            updateUI();
        }

        // ======================
        // äº¤æ˜“ç³»ç»Ÿ
        // ======================
        function openTradeModal() {
            const modal = document.getElementById("trade-modal");
            const traderContainer = document.getElementById("trader-items");
            const resourcesElement = document.getElementById("trade-resources");
            
            // æ˜¾ç¤ºç©å®¶èµ„æº
            let resourcesHtml = "";
            const resources = ["æœ¨æ", "é‡‘å±", "å¸ƒæ–™", "ç”µå­é›¶ä»¶", "ç‡ƒæ–™", "ç ”ç©¶æ•°æ®", "åŒ»ç–—ç”¨å“", "é£Ÿç‰©è¡¥ç»™"];
            for (const resource of resources) {
                if (hasItem(resource)) {
                    resourcesHtml += `${resource} x${gameState.inventory[resource].count} `;
                }
            }
            resourcesElement.textContent = resourcesHtml || "æ— ";
            
            traderContainer.innerHTML = "";
            
            // æ˜¾ç¤ºå•†äººå•†å“
            for (const [itemName, itemData] of Object.entries(gameState.traderInventory)) {
                // æ£€æŸ¥æ˜¯å¦æœ‰åº“å­˜
                if (itemData.stock <= 0) continue;
                
                // æ£€æŸ¥ç©å®¶æ˜¯å¦æœ‰è¶³å¤Ÿçš„èµ„æº
                let canAfford = true;
                for (const [resource, amount] of Object.entries(itemData.price)) {
                    if (!hasItem(resource, amount)) {
                        canAfford = false;
                        break;
                    }
                }
                
                const itemElement = document.createElement("div");
                itemElement.className = "trader-item";
                itemElement.style.opacity = canAfford ? 1 : 0.5;
                
                let html = `<div class="trader-item-name">${itemName}</div>`;
                html += `<div class="trader-item-price">ä»·æ ¼: `;
                
                for (const [resource, amount] of Object.entries(itemData.price)) {
                    html += `${resource} x${amount} `;
                }
                
                html += `</div>`;
                html += `<div style="font-size: 11px; color: #999;">åº“å­˜: ${itemData.stock}</div>`;
                
                if (canAfford) {
                    html += `<button class="btn" onclick="buyItem('${itemName}')" style="width: 100%; margin-top: 5px;">è´­ä¹°</button>`;
                } else {
                    html += `<button class="btn btn-disabled" style="width: 100%; margin-top: 5px;" disabled>æ— æ³•è´­ä¹°</button>`;
                }
                
                itemElement.innerHTML = html;
                traderContainer.appendChild(itemElement);
            }
            
            modal.style.display = "block";
        }

        function buyItem(itemName) {
            const itemData = gameState.traderInventory[itemName];
            
            // å†æ¬¡æ£€æŸ¥åº“å­˜å’Œèµ„æº
            if (itemData.stock <= 0) {
                addLog(`${itemName}å·²ç»å”®ç½„`, "warning");
                return;
            }
            
            for (const [resource, amount] of Object.entries(itemData.price)) {
                if (!hasItem(resource, amount)) {
                    addLog(`è´­ä¹°${itemName}éœ€è¦${amount}ä¸ª${resource}`, "warning");
                    return;
                }
            }
            
            // æ¶ˆè€—èµ„æº
            for (const [resource, amount] of Object.entries(itemData.price)) {
                useItem(resource, amount);
            }
            
            // æ·»åŠ ç‰©å“
            addItem(itemName, 1);
            
            // å‡å°‘åº“å­˜
            itemData.stock--;
            
            addLog(`è´­ä¹°äº†${itemName}`, "positive");
            playSound("success");
            
            // åˆ·æ–°äº¤æ˜“ç•Œé¢
            openTradeModal();
            updateUI();
        }

        // ======================
        // UIæ›´æ–°å’Œåˆå§‹åŒ–
        // ======================
        function updateUI() {
            // æ›´æ–°åŸºç¡€çŠ¶æ€
            elements.day.textContent = gameState.day;
            elements.time.textContent = gameState.times[gameState.time];
            elements["location-tag"].textContent = gameState.location;
            elements["temperature"].textContent = `ğŸŒ¡ï¸ ${gameState.temperature}Â°C`;
            elements["weather"].textContent = gameState.weatherIcons[gameState.weathers.indexOf(gameState.weather)];
            
            // æ›´æ–°çŠ¶æ€å€¼å’Œè¿›åº¦æ¡
            elements.health.textContent = `${gameState.health}/${gameState.maxHealth}`;
            elements.hunger.textContent = `${gameState.hunger}/${gameState.maxHunger}`;
            elements.energy.textContent = `${gameState.energy}/${gameState.maxEnergy}`;
            elements.infection.textContent = `${gameState.infection}/${gameState.maxInfection}`;
            elements.san.textContent = `${gameState.san}/${gameState.maxSan}`;
            
            elements["health-bar"].style.width = `${(gameState.health / gameState.maxHealth) * 100}%`;
            elements["hunger-bar"].style.width = `${(gameState.hunger / gameState.maxHunger) * 100}%`;
            elements["energy-bar"].style.width = `${(gameState.energy / gameState.maxEnergy) * 100}%`;
            elements["infection-bar"].style.width = `${(gameState.infection / gameState.maxInfection) * 100}%`;
            elements["san-bar"].style.width = `${(gameState.san / gameState.maxSan) * 100}%`;
            
            // æ›´æ–°é˜²å¾¡å€¼
            let defense = gameState.defense;
            if (gameState.equippedArmor) {
                defense += gameState.inventory[gameState.equippedArmor].defense;
            }
            elements.defense.textContent = defense;
            
            // æ›´æ–°ç‰©å“æ 
            updateInventoryUI();
            
            // æ›´æ–°çŠ¶æ€æ•ˆæœ
            updateStatusEffectsUI();
            
            // æ›´æ–°åœ°å›¾
            updateMapUI();
            
            // æ ¹æ®çŠ¶æ€ç¦ç”¨æŒ‰é’®
            updateButtonStates();
        }

        function updateInventoryUI() {
            const itemsContainer = document.getElementById("inventory-items");
            const weaponsContainer = document.getElementById("inventory-weapons");
            const armorContainer = document.getElementById("inventory-armor");
            const resourcesContainer = document.getElementById("inventory-resources");
            
            itemsContainer.innerHTML = "";
            weaponsContainer.innerHTML = "";
            armorContainer.innerHTML = "";
            resourcesContainer.innerHTML = "";
            
            for (const [itemName, itemData] of Object.entries(gameState.inventory)) {
                const itemElement = document.createElement("div");
                itemElement.className = "item";
                
                let countText = `x${itemData.count}`;
                if (itemData.type === "weapon" && itemData.ammo !== undefined) {
                    countText = `(${itemData.ammo}/${itemData.maxAmmo})`;
                } else if (itemData.durability !== undefined) {
                    countText = `${Math.floor((itemData.durability / (itemData.maxDurability || 100)) * 100)}%`;
                }
                
                itemElement.innerHTML = `
                    <div>${itemName}</div>
                    <div class="item-count">${countText}</div>
                `;
                
                // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                if (itemData.type === "medical") {
                    itemElement.addEventListener("click", () => {
                        if (itemName === "ç»·å¸¦" || itemName === "æŠ—ç”Ÿç´ " || itemName === "é•‡é™å‰‚" || itemName === "æŠ—ç—…æ¯’è¡€æ¸…") {
                            treat();
                        }
                    });
                } else if (itemData.type === "weapon" || itemData.type === "armor") {
                    itemElement.addEventListener("click", () => {
                        equipItem(itemName);
                    });
                }
                
                // åˆ†ç±»æ˜¾ç¤º
                switch (itemData.type) {
                    case "weapon":
                        weaponsContainer.appendChild(itemElement.cloneNode(true));
                        break;
                    case "armor":
                        armorContainer.appendChild(itemElement.cloneNode(true));
                        break;
                    case "resource":
                        resourcesContainer.appendChild(itemElement.cloneNode(true));
                        break;
                    default:
                        itemsContainer.appendChild(itemElement);
                }
            }
        }

        function updateStatusEffectsUI() {
            const container = document.getElementById("status-effects");
            container.innerHTML = "";
            
            // åº‡æŠ¤æ‰€åŸºç¡€æ•ˆæœ
            const shelterEffect = document.createElement("div");
            shelterEffect.className = "status-effect effect-buff";
            shelterEffect.textContent = "åº‡æŠ¤æ‰€ +5é˜²å¾¡";
            container.appendChild(shelterEffect);
            
            // è£…å¤‡æ•ˆæœ
            if (gameState.equippedArmor) {
                const armorEffect = document.createElement("div");
                armorEffect.className = "status-effect effect-buff";
                armorEffect.textContent = `${gameState.equippedArmor} +${gameState.inventory[gameState.equippedArmor].defense}é˜²å¾¡`;
                container.appendChild(armorEffect);
            }
            
            // æ„ŸæŸ“æ•ˆæœ
            if (gameState.infection > 0) {
                const infectionEffect = document.createElement("div");
                infectionEffect.className = "status-effect effect-debuff";
                
                if (gameState.infection < 30) {
                    infectionEffect.textContent = "è½»å¾®æ„ŸæŸ“";
                } else if (gameState.infection < 70) {
                    infectionEffect.textContent = "ä¸­åº¦æ„ŸæŸ“";
                } else {
                    infectionEffect.textContent = "é‡åº¦æ„ŸæŸ“";
                }
                
                container.appendChild(infectionEffect);
            }
            
            // å…¶ä»–çŠ¶æ€æ•ˆæœ
            for (const effect of gameState.statusEffects) {
                if (effect.name !== "åº‡æŠ¤æ‰€") {
                    const effectElement = document.createElement("div");
                    effectElement.className = `status-effect effect-${effect.type === "buff" ? "buff" : "debuff"}`;
                    effectElement.textContent = effect.name;
                    container.appendChild(effectElement);
                }
            }
        }

        function updateMapUI() {
            const mapGrid = document.getElementById("map-grid");
            mapGrid.innerHTML = "";
            
            for (let y = 0; y < 5; y++) {
                for (let x = 0; x < 5; x++) {
                    const location = gameState.map[y][x];
                    const tile = document.createElement("div");
                    tile.className = "map-tile";
                    
                    if (!location) {
                        tile.textContent = "ï¼Ÿ";
                        tile.classList.add("undiscovered");
                    } else {
                        if (gameState.discoveredLocations.includes(location)) {
                            tile.textContent = location.substring(0, 2);
                            tile.classList.add("discovered");
                            
                            if (location === gameState.location) {
                                tile.classList.add("current");
                            }
                            
                            tile.addEventListener("click", () => travel(x, y));
                        } else {
                            tile.textContent = "ï¼Ÿ";
                            tile.classList.add("undiscovered");
                        }
                    }
                    
                    mapGrid.appendChild(tile);
                }
            }
        }

        function updateButtonStates() {
            // æ ¹æ®èƒ½é‡å€¼ç¦ç”¨æŒ‰é’®
            const energyButtons = ["btn-explore", "btn-scavenge", "btn-fight"];
            for (const btnId of energyButtons) {
                const btn = document.getElementById(btnId);
                if (gameState.energy < 15) {
                    btn.classList.add("btn-disabled");
                } else {
                    btn.classList.remove("btn-disabled");
                }
            }
            
            // æ ¹æ®ä½ç½®ç¦ç”¨ä¼‘æ¯æŒ‰é’®
            document.getElementById("btn-rest").classList.toggle("btn-disabled", gameState.location !== "é¿éš¾æ‰€");
            
            // æ ¹æ®æ˜¯å¦æœ‰é£Ÿç‰©ç¦ç”¨è¿›é£ŸæŒ‰é’®
            document.getElementById("btn-eat").classList.toggle("btn-disabled", 
                !hasItem("ç½å¤´") && !hasItem("ç“¶è£…æ°´"));
            
            // æ ¹æ®æ˜¯å¦æœ‰åŒ»ç–—ç‰©å“ç¦ç”¨æ²»ç–—æŒ‰é’®
            document.getElementById("btn-treat").classList.toggle("btn-disabled", 
                !hasItem("ç»·å¸¦") && !hasItem("æŠ—ç”Ÿç´ ") && !hasItem("é•‡é™å‰‚") && !hasItem("æŠ—ç—…æ¯’è¡€æ¸…"));
            
            // æ ¹æ®æ˜¯å¦æœ‰ç ”ç©¶å®éªŒå®¤ç¦ç”¨ç ”ç©¶æŒ‰é’®
            document.getElementById("btn-research").classList.toggle("btn-disabled", 
                gameState.facilities["ç ”ç©¶å®éªŒå®¤"].level === 0);
            
            // æ ¹æ®ä½ç½®ç¦ç”¨äº¤æ˜“æŒ‰é’®
            document.getElementById("btn-trade").classList.toggle("btn-disabled", 
                gameState.location !== "æµæµªå•†äººè¥åœ°");
        }

        function addLog(message, type = "info") {
            const timeLabel = gameState.times[gameState.time];
            const logEntry = document.createElement("div");
            logEntry.className = `log-entry ${type}`;
            logEntry.textContent = `[${timeLabel}] ${message}`;
            elements["log-entries"].prepend(logEntry);
            
            // é™åˆ¶æ—¥å¿—æ•°é‡
            if (elements["log-entries"].children.length > 10) {
                elements["log-entries"].removeChild(elements["log-entries"].lastChild);
            }
        }

        // ======================
        // æ–°æ‰‹å¼•å¯¼
        // ======================
        function showTutorial() {
            if (gameState.showTutorial) {
                document.getElementById("tutorial-modal").style.display = "block";
            }
        }

        function closeTutorial() {
            playSound("click");
            document.getElementById("tutorial-modal").style.display = "none";
            gameState.showTutorial = false;
        }

        // ======================
        // éŸ³æ•ˆæ§åˆ¶
        // ======================
        function toggleSound() {
            gameState.soundEnabled = !gameState.soundEnabled;
            elements["sound-control"].textContent = gameState.soundEnabled ? "ğŸ”Š éŸ³æ•ˆ" : "ğŸ”‡ é™éŸ³";
            playSound("click");
        }

        // ======================
        // åˆå§‹åŒ–æ¸¸æˆ
        // ======================
        function initGame() {
            initializeMap();
            
            // è®¾ç½®æŒ‰é’®äº‹ä»¶
            document.getElementById("btn-next").addEventListener("click", nextTime);
            document.getElementById("btn-explore").addEventListener("click", explore);
            document.getElementById("btn-scavenge").addEventListener("click", scavenge);
            document.getElementById("btn-rest").addEventListener("click", rest);
            document.getElementById("btn-eat").addEventListener("click", eat);
            document.getElementById("btn-fight").addEventListener("click", fight);
            document.getElementById("btn-craft").addEventListener("click", craft);
            document.getElementById("btn-build").addEventListener("click", build);
            document.getElementById("btn-skills").addEventListener("click", showSkills);
            document.getElementById("btn-research").addEventListener("click", research);
            document.getElementById("btn-trade").addEventListener("click", trade);
            document.getElementById("btn-treat").addEventListener("click", treat);
            document.getElementById("btn-save").addEventListener("click", () => saveGame(1));
            document.getElementById("btn-load").addEventListener("click", openLoadModal);
            
            // å…³é—­æ¨¡æ€æ¡†æŒ‰é’®
            document.getElementById("btn-close-craft").addEventListener("click", () => {
                playSound("click");
                document.getElementById("craft-modal").style.display = "none";
            });
            
            document.getElementById("btn-close-build").addEventListener("click", () => {
                playSound("click");
                document.getElementById("build-modal").style.display = "none";
            });
            
            document.getElementById("btn-close-skills").addEventListener("click", () => {
                playSound("click");
                document.getElementById("skills-modal").style.display = "none";
            });
            
            document.getElementById("btn-close-research").addEventListener("click", () => {
                playSound("click");
                document.getElementById("research-modal").style.display = "none";
            });
            
            document.getElementById("btn-close-trade").addEventListener("click", () => {
                playSound("click");
                document.getElementById("trade-modal").style.display = "none";
            });
            
            document.getElementById("btn-close-load").addEventListener("click", () => {
                playSound("click");
                document.getElementById("load-modal").style.display = "none";
            });
            
            // æ ‡ç­¾é¡µåˆ‡æ¢
            document.querySelectorAll(".tab").forEach(tab => {
                tab.addEventListener("click", function() {
                    playSound("click");
                    // ç§»é™¤æ‰€æœ‰activeç±»
                    document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
                    document.querySelectorAll(".tab-content").forEach(c => c.classList.remove("active"));
                    
                    // æ·»åŠ activeç±»åˆ°å½“å‰æ ‡ç­¾
                    this.classList.add("active");
                    const tabId = `tab-${this.dataset.tab}`;
                    document.getElementById(tabId).classList.add("active");
                });
            });
            
            // æ‰€æœ‰æŒ‰é’®ç‚¹å‡»æ•ˆæœ
            document.querySelectorAll(".btn").forEach(btn => {
                btn.addEventListener("click", function() {
                    // æ·»åŠ ç‚¹å‡»ç‰¹æ•ˆ
                    this.style.boxShadow = "0 0 10px var(--primary-color)";
                    setTimeout(() => {
                        this.style.boxShadow = "none";
                    }, 200);
                });
            });
            
            // éŸ³æ•ˆæ§åˆ¶
            elements["sound-control"].addEventListener("click", toggleSound);
            
            updateUI();
            addLog("æ¸¸æˆå¼€å§‹ï¼ŒåŠªåŠ›åœ¨ä¸§å°¸æœ«æ—¥ä¸­ç”Ÿå­˜ä¸‹å»ï¼", "info");
            addLog("ä¸§å°¸çš„å˜¶å¼å£°ä»è¿œå¤„ä¼ æ¥...", "danger");
            
            // æ˜¾ç¤ºæ–°æ‰‹å¼•å¯¼
            showTutorial();
        }

        // å¯åŠ¨æ¸¸æˆ
        window.onload = initGame;
        
        // å…¨å±€å‡½æ•°
        window.craftItem = craftItem;
        window.upgradeFacility = upgradeFacility;
        window.learnSkill = learnSkill;
        window.travel = travel;
        window.loadGame = loadGame;
        window.startResearch = startResearch;
        window.buyItem = buyItem;
        window.restartGame = restartGame;
        window.closeTutorial = closeTutorial;
    </script>
</body>
</html>
