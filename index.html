<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>荒野求生：星烁游戏</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Arial', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            background-color: #111;
            color: #eee;
            overflow-x: hidden;
            touch-action: manipulation;
            user-select: none;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        #game-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 10px;
            max-width: 600px;
            margin: 0 auto;
            width: 100%;
        }
        
        #header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            border-bottom: 1px solid #333;
            padding-bottom: 5px;
        }
        
        #stats {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 10px;
        }
        
        .stat {
            background-color: #222;
            padding: 5px 8px;
            border-radius: 4px;
            font-size: 14px;
            min-width: 80px;
            text-align: center;
        }
        
        .stat-value {
            font-weight: bold;
            color: #fff;
        }
        
        .health { color: #ff5555; }
        .hunger { color: #ffaa44; }
        .thirst { color: #44aaff; }
        .energy { color: #aaff44; }
        .temperature { color: #ff44aa; }
        
        #game-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: #1a1a1a;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            position: relative;
            overflow: hidden;
        }
        
        #location-image {
            width: 100%;
            height: 150px;
            background-size: cover;
            background-position: center;
            margin-bottom: 10px;
            border-radius: 4px;
            border: 2px solid #333;
        }
        
        #time-display {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 14px;
        }
        
        #day-display {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 14px;
        }
        
        #weather-display {
            position: absolute;
            top: 40px;
            left: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 14px;
        }
        
        #event-log {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 10px;
            padding: 8px;
            background-color: #222;
            border-radius: 4px;
            font-size: 14px;
            line-height: 1.4;
            max-height: 150px;
            border: 1px solid #333;
        }
        
        .log-entry {
            margin-bottom: 5px;
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        #actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-bottom: 10px;
        }
        
        .action-btn {
            background-color: #333;
            color: #fff;
            border: none;
            padding: 10px;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }
        
        .action-btn:active {
            transform: scale(0.95);
            background-color: #444;
        }
        
        .action-btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 5px;
            height: 5px;
            background: rgba(255, 255, 255, 0.5);
            opacity: 0;
            border-radius: 100%;
            transform: scale(1, 1) translate(-50%, -50%);
            transform-origin: 50% 50%;
        }
        
        .action-btn:active::after {
            animation: ripple 0.6s ease-out;
        }
        
        @keyframes ripple {
            0% {
                transform: scale(0, 0);
                opacity: 0.5;
            }
            100% {
                transform: scale(20, 20);
                opacity: 0;
            }
        }
        
        #inventory-title {
            margin-bottom: 5px;
            font-size: 14px;
        }
        
        #inventory {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 10px;
            min-height: 40px;
        }
        
        .item {
            background-color: #333;
            padding: 5px 8px;
            border-radius: 4px;
            font-size: 14px;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .item:hover {
            background-color: #444;
        }
        
        .item-count {
            margin-left: 5px;
            font-weight: bold;
            color: #fff;
        }
        
        #crafting {
            margin-top: 10px;
        }
        
        #crafting-btn {
            background-color: #444;
            color: #fff;
            border: none;
            padding: 8px;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            width: 100%;
            margin-bottom: 5px;
        }
        
        #crafting-list {
            display: none;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 5px;
        }
        
        .craft-item {
            background-color: #3a3a3a;
            padding: 8px;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .craft-item:hover {
            background-color: #444;
        }
        
        .progress-bar {
            height: 5px;
            background-color: #333;
            border-radius: 2px;
            margin-top: 5px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background-color: #4CAF50;
            width: 0%;
            transition: width 0.3s;
        }
        
        #settings {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
        }
        
        .settings-btn {
            background-color: transparent;
            color: #aaa;
            border: none;
            padding: 5px;
            font-size: 20px;
            cursor: pointer;
        }
        
        .danger {
            color: #ff5555;
        }
        
        .warning {
            color: #ffaa44;
        }
        
        .success {
            color: #44ff44;
        }
        
        .info {
            color: #44aaff;
        }
        
        .rare {
            color: #aa44ff;
        }
        
        /* 夜间模式 */
        .night-mode {
            background-color: #0a0a1a;
            color: #ccc;
        }
        
        .night-mode #game-area {
            background-color: #0a0a0a;
        }
        
        .night-mode .stat,
        .night-mode #event-log {
            background-color: #111;
        }
        
        /* 加载动画 */
        .loader {
            border: 4px solid #333;
            border-top: 4px solid #4CAF50;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* 响应式调整 */
        @media (max-width: 400px) {
            .stat {
                min-width: 70px;
                font-size: 12px;
            }
            
            .action-btn {
                padding: 8px 5px;
                font-size: 12px;
            }
        }

        /* 音乐控制面板 */
        .music-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }
        
        .music-btn {
            background-color: #333;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        /* 物品使用菜单 */
        .item-menu {
            position: fixed;
            background-color: #333;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            z-index: 100;
            display: none;
        }
        
        .item-menu button {
            display: block;
            width: 100%;
            padding: 8px 12px;
            background: none;
            border: none;
            color: white;
            text-align: left;
            cursor: pointer;
        }
        
        .item-menu button:hover {
            background-color: #444;
        }
        
        /* 工具提示 */
        .tooltip {
            position: absolute;
            background-color: rgba(0,0,0,0.8);
            color: white;
            padding: 5px 8px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 100;
            pointer-events: none;
            display: none;
        }
        
        /* 地图面板 */
        #map-panel {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            z-index: 200;
            display: none;
            flex-direction: column;
            padding: 20px;
            overflow-y: auto;
        }
        
        #map-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        
        #map-close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
        }
        
        #map-content {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            flex: 1;
        }
        
        .map-location {
            background-color: #222;
            border-radius: 5px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .map-location:hover {
            background-color: #333;
        }
        
        .map-location.discovered {
            background-color: #2a4a2a;
        }
        
        .map-location.current {
            outline: 2px solid gold;
        }
        
        .map-location-image {
            width: 100%;
            height: 80px;
            background-size: cover;
            background-position: center;
            margin-bottom: 5px;
            border-radius: 3px;
        }
        
        /* 技能面板 */
        #skills-panel {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            z-index: 200;
            display: none;
            flex-direction: column;
            padding: 20px;
            overflow-y: auto;
        }
        
        #skills-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        
        #skills-close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
        }
        
        .skill-category {
            margin-bottom: 20px;
        }
        
        .skill-item {
            background-color: #222;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
        }
        
        .skill-progress {
            height: 5px;
            background-color: #333;
            border-radius: 2px;
            margin-top: 5px;
            overflow: hidden;
        }
        
        .skill-progress-fill {
            height: 100%;
            background-color: #4CAF50;
            width: 0%;
        }
        
        /* 任务面板 */
        #quests-panel {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            z-index: 200;
            display: none;
            flex-direction: column;
            padding: 20px;
            overflow-y: auto;
        }
        
        #quests-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        
        #quests-close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
        }
        
        .quest-item {
            background-color: #222;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        
        .quest-reward {
            color: #ffaa44;
            margin-top: 5px;
        }
        
        /* 基地面板 */
        #base-panel {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            z-index: 200;
            display: none;
            flex-direction: column;
            padding: 20px;
            overflow-y: auto;
        }
        
        #base-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        
        #base-close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
        }
        
        .base-upgrade {
            background-color: #222;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        
        .base-upgrade-btn {
            background-color: #444;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            margin-top: 5px;
            cursor: pointer;
        }
        
        /* 战斗面板 */
        #combat-panel {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            z-index: 200;
            display: none;
            flex-direction: column;
            padding: 20px;
            align-items: center;
            justify-content: center;
        }
        
        .enemy-health {
            width: 100%;
            height: 20px;
            background-color: #333;
            border-radius: 10px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .enemy-health-fill {
            height: 100%;
            background-color: #ff5555;
            width: 100%;
        }
        
        .combat-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            width: 100%;
            max-width: 300px;
        }
        
        .combat-btn {
            background-color: #444;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
        }
        
        /* 通知 */
        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0,0,0,0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 300;
            display: none;
            animation: fadeInOut 3s;
        }
        
        @keyframes fadeInOut {
            0% { opacity: 0; top: 10px; }
            10% { opacity: 1; top: 20px; }
            90% { opacity: 1; top: 20px; }
            100% { opacity: 0; top: 10px; }
        }
    </style>
</head>
<body>
    <div id="game-container">
        <div id="header">
            <h1>荒野求生：星烁游戏</h1>
            <div id="difficulty">难度: 地狱</div>
        </div>
        
        <div id="stats">
            <div class="stat"><span class="health">健康</span>: <span id="health-value" class="stat-value">100</span>/100</div>
            <div class="stat"><span class="hunger">饥饿</span>: <span id="hunger-value" class="stat-value">80</span>/100</div>
            <div class="stat"><span class="thirst">口渴</span>: <span id="thirst-value" class="stat-value">75</span>/100</div>
            <div class="stat"><span class="energy">精力</span>: <span id="energy-value" class="stat-value">90</span>/100</div>
            <div class="stat"><span class="temperature">体温</span>: <span id="temp-value" class="stat-value">36.5</span>°C</div>
        </div>
        
        <div id="game-area">
            <div id="day-display">第 <span id="day-count">1</span> 天</div>
            <div id="time-display"><span id="time-text">清晨</span> <span id="hour-display">06:00</span></div>
            <div id="weather-display"><span id="weather-text">晴天</span></div>
            <div id="location-image"></div>
            
            <div id="event-log"></div>
            
            <div id="actions">
                <button class="action-btn" id="gather-btn">采集资源</button>
                <button class="action-btn" id="hunt-btn">狩猎</button>
                <button class="action-btn" id="explore-btn">探索</button>
                <button class="action-btn" id="rest-btn">休息</button>
                <button class="action-btn" id="drink-btn">喝水</button>
                <button class="action-btn" id="eat-btn">进食</button>
                <button class="action-btn" id="build-btn">建造</button>
                <button class="action-btn" id="fire-btn">生火</button>
                <button class="action-btn" id="map-btn">地图</button>
                <button class="action-btn" id="skills-btn">技能</button>
                <button class="action-btn" id="quests-btn">任务</button>
                <button class="action-btn" id="base-btn">基地</button>
            </div>
            
            <div class="progress-bar" id="action-progress">
                <div class="progress-fill" id="action-progress-fill"></div>
            </div>
        </div>
        
        <div id="inventory-title">物品栏 (<span id="inventory-count">0</span>/<span id="inventory-max">10</span>)</div>
        <div id="inventory"></div>
        
        <div id="crafting">
            <button id="crafting-btn">制作物品 ▼</button>
            <div id="crafting-list"></div>
        </div>
        
        <div id="settings">
            <button class="settings-btn" id="music-btn">🎵</button>
            <button class="settings-btn" id="sound-btn">🔊</button>
            <button class="settings-btn" id="save-btn">💾</button>
            <button class="settings-btn" id="load-btn">📂</button>
            <button class="settings-btn" id="night-btn">🌙</button>
        </div>

        <!-- 音乐控制面板 -->
        <div class="music-controls">
            <button class="music-btn" id="day-music-btn">白天音乐</button>
            <button class="music-btn" id="night-music-btn">夜晚音乐</button>
            <button class="music-btn" id="rain-music-btn">雨天音乐</button>
        </div>
    </div>
    
    <!-- 背景音乐 -->
    <audio id="day-music" loop>
        <source src="https://assets.mixkit.co/music/preview/mixkit-forest-trek-169.mp3" type="audio/mpeg">
    </audio>
    
    <audio id="night-music" loop>
        <source src="https://assets.mixkit.co/music/preview/mixkit-dark-ambient-1126.mp3" type="audio/mpeg">
    </audio>
    
    <audio id="rain-music" loop>
        <source src="https://assets.mixkit.co/music/preview/mixkit-rainy-day-1180.mp3" type="audio/mpeg">
    </audio>
    
    <!-- 音效 -->
    <audio id="click-sound">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-arcade-game-jump-coin-216.mp3" type="audio/mpeg">
    </audio>
    
    <audio id="success-sound">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-achievement-bell-600.mp3" type="audio/mpeg">
    </audio>
    
    <audio id="failure-sound">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-retro-arcade-lose-2027.mp3" type="audio/mpeg">
    </audio>
    
    <audio id="danger-sound">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-unfair-game-penalty-2080.mp3" type="audio/mpeg">
    </audio>
    
    <audio id="nature-sound">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-nature-ambient-forest-1258.mp3" type="audio/mpeg">
    </audio>
    
    <audio id="combat-sound">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-sword-attack-1680.mp3" type="audio/mpeg">
    </audio>
    
    <!-- 物品使用菜单 -->
    <div id="item-menu" class="item-menu"></div>
    
    <!-- 工具提示 -->
    <div id="tooltip" class="tooltip"></div>
    
    <!-- 地图面板 -->
    <div id="map-panel">
        <div id="map-header">
            <h2>荒野地图</h2>
            <button id="map-close">×</button>
        </div>
        <div id="map-content"></div>
    </div>
    
    <!-- 技能面板 -->
    <div id="skills-panel">
        <div id="skills-header">
            <h2>生存技能</h2>
            <button id="skills-close">×</button>
        </div>
        <div class="skill-category">
            <h3>采集技能</h3>
            <div class="skill-item">
                <span>木材采集</span>
                <span id="woodcutting-level">1</span>
                <div class="skill-progress">
                    <div class="skill-progress-fill" id="woodcutting-progress"></div>
                </div>
            </div>
            <div class="skill-item">
                <span>采矿</span>
                <span id="mining-level">1</span>
                <div class="skill-progress">
                    <div class="skill-progress-fill" id="mining-progress"></div>
                </div>
            </div>
        </div>
        <div class="skill-category">
            <h3>战斗技能</h3>
            <div class="skill-item">
                <span>狩猎</span>
                <span id="hunting-level">1</span>
                <div class="skill-progress">
                    <div class="skill-progress-fill" id="hunting-progress"></div>
                </div>
            </div>
            <div class="skill-item">
                <span>战斗</span>
                <span id="combat-level">1</span>
                <div class="skill-progress">
                    <div class="skill-progress-fill" id="combat-progress"></div>
                </div>
            </div>
        </div>
        <div class="skill-category">
            <h3>生存技能</h3>
            <div class="skill-item">
                <span>生火</span>
                <span id="firemaking-level">1</span>
                <div class="skill-progress">
                    <div class="skill-progress-fill" id="firemaking-progress"></div>
                </div>
            </div>
            <div class="skill-item">
                <span>烹饪</span>
                <span id="cooking-level">1</span>
                <div class="skill-progress">
                    <div class="skill-progress-fill" id="cooking-progress"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 任务面板 -->
    <div id="quests-panel">
        <div id="quests-header">
            <h2>任务日志</h2>
            <button id="quests-close">×</button>
        </div>
        <div id="daily-quests">
            <h3>每日任务</h3>
            <div class="quest-item" id="daily-quest-1">
                <div class="quest-title">收集10个木材</div>
                <div class="quest-progress">0/10</div>
                <div class="quest-reward">奖励: 5食物</div>
            </div>
            <div class="quest-item" id="daily-quest-2">
                <div class="quest-title">狩猎3只动物</div>
                <div class="quest-progress">0/3</div>
                <div class="quest-reward">奖励: 皮革x2</div>
            </div>
        </div>
        <div id="main-quests">
            <h3>主线任务</h3>
            <div class="quest-item" id="main-quest-1">
                <div class="quest-title">建造一个庇护所</div>
                <div class="quest-progress">未完成</div>
                <div class="quest-reward">奖励: 解锁基地功能</div>
            </div>
        </div>
    </div>
    
    <!-- 基地面板 -->
    <div id="base-panel">
        <div id="base-header">
            <h2>生存基地</h2>
            <button id="base-close">×</button>
        </div>
        <div class="base-upgrade">
            <h3>简易庇护所</h3>
            <p>提供基本的保护和休息</p>
            <div>等级: <span id="shelter-level">0</span></div>
            <button class="base-upgrade-btn" id="upgrade-shelter-btn">升级 (需要木材x20, 绳子x5)</button>
        </div>
        <div class="base-upgrade">
            <h3>储物箱</h3>
            <p>增加物品存储空间</p>
            <div>等级: <span id="storage-level">0</span></div>
            <button class="base-upgrade-btn" id="upgrade-storage-btn">升级 (需要木材x15, 铁矿石x5)</button>
        </div>
        <div class="base-upgrade">
            <h3>工作台</h3>
            <p>解锁高级制作配方</p>
            <div>等级: <span id="workbench-level">0</span></div>
            <button class="base-upgrade-btn" id="upgrade-workbench-btn">升级 (需要木材x30, 铁矿石x10)</button>
        </div>
    </div>
    
    <!-- 战斗面板 -->
    <div id="combat-panel">
        <h2 id="enemy-name">野狼</h2>
        <div class="enemy-health">
            <div class="enemy-health-fill" id="enemy-health-fill"></div>
        </div>
        <p id="combat-message">一只野狼向你扑来!</p>
        <div class="combat-actions">
            <button class="combat-btn" id="attack-btn">攻击</button>
            <button class="combat-btn" id="defend-btn">防御</button>
            <button class="combat-btn" id="use-item-btn">使用物品</button>
            <button class="combat-btn" id="flee-btn">逃跑</button>
        </div>
    </div>
    
    <!-- 通知 -->
    <div class="notification" id="notification"></div>

    <script>
        // 游戏状态
        const gameState = {
            // 玩家属性
            health: 100,
            maxHealth: 100,
            hunger: 80,
            maxHunger: 100,
            thirst: 75,
            maxThirst: 100,
            energy: 90,
            maxEnergy: 100,
            temperature: 36.5,
            
            // 游戏时间
            day: 1,
            hour: 6,
            minute: 0,
            isDay: true,
            weather: 'sunny', // sunny, rainy, stormy, foggy, snowy
            weatherDuration: 0,
            
            // 物品栏
            inventory: {},
            inventoryMax: 10,
            
            // 游戏进度
            location: 'forest',
            discoveredLocations: ['forest'],
            shelterLevel: 0,
            storageLevel: 0,
            workbenchLevel: 0,
            fire: false,
            fireDuration: 0,
            
            // 技能
            skills: {
                woodcutting: { level: 1, xp: 0, xpToNext: 100 },
                mining: { level: 1, xp: 0, xpToNext: 100 },
                hunting: { level: 1, xp: 0, xpToNext: 100 },
                combat: { level: 1, xp: 0, xpToNext: 100 },
                firemaking: { level: 1, xp: 0, xpToNext: 100 },
                cooking: { level: 1, xp: 0, xpToNext: 100 }
            },
            
            // 任务
            quests: {
                daily: {
                    gatherWood: { target: 10, progress: 0, completed: false },
                    huntAnimals: { target: 3, progress: 0, completed: false }
                },
                main: {
                    buildShelter: { completed: false }
                }
            },
            
            // 战斗状态
            inCombat: false,
            enemy: null,
            
            // 设置
            musicEnabled: true,
            soundEnabled: true,
            nightMode: false,
            currentMusic: null,
            
            // 其他状态
            currentAction: null,
            actionProgress: 0,
            actionInterval: null,
            actionDifficulty: 0,
            
            // 解锁系统
            unlockedRecipes: ['bandage', 'spear', 'rope', 'fire', 'shelter', 'cooked_meat'],
            discoveredItems: ['wood', 'stone', 'herbs', 'berries', 'meat_raw'],
            
            // 统计数据
            stats: {
                itemsGathered: 0,
                animalsHunted: 0,
                locationsExplored: 0,
                daysSurvived: 0,
                itemsCrafted: 0,
                enemiesDefeated: 0
            }
        };
        
        // 物品数据
        const items = {
            wood: { 
                name: '木材', 
                emoji: '🪵', 
                weight: 1,
                description: '可用于生火或建造',
                actions: ['burn', 'build'],
                durability: null
            },
            stone: { 
                name: '石头', 
                emoji: '🪨', 
                weight: 1,
                description: '可用于制作工具',
                actions: ['craft'],
                durability: null
            },
            herbs: { 
                name: '草药', 
                emoji: '🌿', 
                weight: 0.5,
                description: '可用于制作绷带或治疗',
                actions: ['heal', 'craft'],
                durability: null
            },
            berries: { 
                name: '浆果', 
                emoji: '🍒', 
                weight: 0.3,
                description: '可食用，但可能有毒',
                actions: ['eat'],
                durability: null
            },
            meat_raw: { 
                name: '生肉', 
                emoji: '🥩', 
                weight: 1,
                description: '可食用或烹饪，生吃可能中毒',
                actions: ['eat', 'cook'],
                durability: null
            },
            meat_cooked: { 
                name: '熟肉', 
                emoji: '🍖', 
                weight: 1,
                description: '营养丰富的食物',
                actions: ['eat'],
                durability: null
            },
            water: { 
                name: '水', 
                emoji: '💧', 
                weight: 0.5,
                description: '解渴的必需品',
                actions: ['drink'],
                durability: null
            },
            fur: { 
                name: '毛皮', 
                emoji: '🐾', 
                weight: 0.8,
                description: '可用于制作衣物或庇护所',
                actions: ['craft'],
                durability: null
            },
            bone: { 
                name: '骨头', 
                emoji: '🦴', 
                weight: 0.5,
                description: '可用于制作工具',
                actions: ['craft'],
                durability: null
            },
            bandage: { 
                name: '绷带', 
                emoji: '🩹', 
                weight: 0.3,
                description: '恢复健康',
                actions: ['use'],
                durability: null
            },
            spear: { 
                name: '长矛', 
                emoji: '🔱', 
                weight: 2,
                description: '提高狩猎成功率和防御能力',
                actions: ['equip'],
                durability: 50
            },
            rope: { 
                name: '绳子', 
                emoji: '🧵', 
                weight: 1,
                description: '可用于建造或制作',
                actions: ['craft'],
                durability: null
            },
            leather: { 
                name: '皮革', 
                emoji: '🧥', 
                weight: 1,
                description: '可用于制作衣物',
                actions: ['craft'],
                durability: null
            },
            iron_ore: { 
                name: '铁矿石', 
                emoji: '⛏️', 
                weight: 2,
                description: '可用于制作工具',
                actions: ['craft'],
                durability: null
            },
            coal: { 
                name: '煤炭', 
                emoji: '🪨', 
                weight: 1,
                description: '优质的燃料',
                actions: ['burn'],
                durability: null
            },
            fish: { 
                name: '鱼', 
                emoji: '🐟', 
                weight: 0.8,
                description: '可食用或烹饪',
                actions: ['eat', 'cook'],
                durability: null
            },
            fishing_rod: { 
                name: '鱼竿', 
                emoji: '🎣', 
                weight: 2,
                description: '可以在水域钓鱼',
                actions: ['equip'],
                durability: 30
            },
            trap: { 
                name: '陷阱', 
                emoji: '🕳️', 
                weight: 3,
                description: '可以捕捉小型动物',
                actions: ['use'],
                durability: 10
            },
            bow: { 
                name: '弓箭', 
                emoji: '🏹', 
                weight: 2,
                description: '远程武器，提高狩猎成功率',
                actions: ['equip'],
                durability: 40
            },
            arrow: { 
                name: '箭', 
                emoji: '➹', 
                weight: 0.2,
                description: '弓箭的弹药',
                actions: ['craft'],
                durability: null
            },
            medicine: { 
                name: '药膏', 
                emoji: '💊', 
                weight: 0.3,
                description: '治疗伤口和疾病',
                actions: ['use'],
                durability: null
            },
            armor: { 
                name: '皮甲', 
                emoji: '🛡️', 
                weight: 3,
                description: '提供防御保护',
                actions: ['equip'],
                durability: 60
            }
        };
        
        // 制作配方
        const recipes = {
            bandage: {
                name: '绷带',
                ingredients: { herbs: 3 },
                time: 2,
                skill: 'survival',
                unlockLevel: 1,
                description: '用于治疗伤口'
            },
            spear: {
                name: '长矛',
                ingredients: { wood: 2, stone: 1, rope: 1 },
                time: 10,
                skill: 'crafting',
                unlockLevel: 2,
                description: '提高狩猎成功率和防御能力'
            },
            rope: {
                name: '绳子',
                ingredients: { herbs: 5 },
                time: 5,
                skill: 'crafting',
                unlockLevel: 1,
                description: '用于建造和制作'
            },
            fire: {
                name: '生火',
                ingredients: { wood: 3, stone: 2 },
                time: 5,
                skill: 'survival',
                unlockLevel: 1,
                once: true,
                description: '提供温暖和烹饪能力'
            },
            shelter: {
                name: '简易庇护所',
                ingredients: { wood: 10, rope: 3, fur: 2 },
                time: 30,
                skill: 'building',
                unlockLevel: 2,
                once: true,
                description: '提高休息效果和防御能力'
            },
            cooked_meat: {
                name: '烤肉',
                ingredients: { meat_raw: 1 },
                time: 3,
                skill: 'cooking',
                unlockLevel: 1,
                requiresFire: true,
                description: '营养丰富的熟食'
            },
            fishing_rod: {
                name: '鱼竿',
                ingredients: { wood: 3, rope: 2 },
                time: 15,
                skill: 'crafting',
                unlockLevel: 3,
                description: '可以在水域钓鱼'
            },
            trap: {
                name: '陷阱',
                ingredients: { wood: 5, rope: 2 },
                time: 10,
                skill: 'crafting',
                unlockLevel: 2,
                description: '捕捉小型动物'
            },
            bow: {
                name: '弓箭',
                ingredients: { wood: 4, rope: 2, leather: 1 },
                time: 20,
                skill: 'crafting',
                unlockLevel: 4,
                description: '远程狩猎武器'
            },
            arrow: {
                name: '箭',
                ingredients: { wood: 1, stone: 1, feather: 1 },
                time: 5,
                skill: 'crafting',
                unlockLevel: 4,
                description: '弓箭的弹药'
            },
            medicine: {
                name: '药膏',
                ingredients: { herbs: 5, water: 1 },
                time: 8,
                skill: 'medicine',
                unlockLevel: 3,
                description: '治疗伤口和疾病'
            },
            armor: {
                name: '皮甲',
                ingredients: { leather: 3, rope: 2 },
                time: 25,
                skill: 'crafting',
                unlockLevel: 5,
                description: '提供防御保护'
            }
        };
        
        // 地点数据
        const locations = {
            forest: {
                name: '森林',
                image: 'https://images.unsplash.com/photo-1448375240586-882707db888b?ixlib=rb-1.2.1&auto=format&fit=crop&w=600&q=80',
                resources: ['wood', 'herbs', 'berries'],
                dangers: ['wolf', 'snake', 'spider'],
                exploreTime: 2,
                discoverable: ['river', 'cave'],
                description: '茂密的森林，资源丰富但危险'
            },
            river: {
                name: '河流',
                image: 'https://images.unsplash.com/photo-1437482078695-8d9cea7f64ef?ixlib=rb-1.2.1&auto=format&fit=crop&w=600&q=80',
                resources: ['water', 'fish'],
                dangers: ['bear', 'piranha'],
                exploreTime: 3,
                discoverable: ['lake', 'waterfall'],
                description: '清澈的河流，水源充足'
            },
            cave: {
                name: '洞穴',
                image: 'https://images.unsplash.com/photo-1495563129107-1737a0896a19?ixlib=rb-1.2.1&auto=format&fit=crop&w=600&q=80',
                resources: ['stone', 'coal', 'iron_ore'],
                dangers: ['bat', 'bear', 'fall'],
                exploreTime: 4,
                discoverable: ['deep_cave'],
                description: '黑暗的洞穴，可能有珍贵矿物'
            },
            lake: {
                name: '湖泊',
                image: 'https://images.unsplash.com/photo-1476231682828-37e571bc172f?ixlib=rb-1.2.1&auto=format&fit=crop&w=600&q=80',
                resources: ['water', 'fish'],
                dangers: ['crocodile', 'piranha'],
                exploreTime: 3,
                discoverable: ['mountain'],
                description: '广阔的湖泊，鱼类资源丰富'
            },
            waterfall: {
                name: '瀑布',
                image: 'https://images.unsplash.com/photo-1519692933481-e162a57d6721?ixlib=rb-1.2.1&auto=format&fit=crop&w=600&q=80',
                resources: ['water', 'stone'],
                dangers: ['fall', 'piranha'],
                exploreTime: 4,
                discoverable: ['abandoned_camp'],
                description: '壮观的瀑布，周围岩石丰富'
            },
            deep_cave: {
                name: '深洞',
                image: 'https://images.unsplash.com/photo-1507272931001-fc06c17e4f43?ixlib=rb-1.2.1&auto=format&fit=crop&w=600&q=80',
                resources: ['iron_ore', 'coal', 'gem'],
                dangers: ['bat_swarm', 'fall', 'bear'],
                exploreTime: 6,
                discoverable: [],
                description: '深邃的洞穴，隐藏着珍贵矿物'
            },
            mountain: {
                name: '山地',
                image: 'https://images.unsplash.com/photo-1454789548928-9efd52dc4031?ixlib=rb-1.2.1&auto=format&fit=crop&w=600&q=80',
                resources: ['stone', 'iron_ore', 'herbs'],
                dangers: ['fall', 'avalanche', 'eagle'],
                exploreTime: 5,
                discoverable: [],
                description: '高耸的山地，视野开阔但危险'
            },
            abandoned_camp: {
                name: '废弃营地',
                image: 'https://images.unsplash.com/photo-1504280390367-361c6d9f38f4?ixlib=rb-1.2.1&auto=format&fit=crop&w=600&q=80',
                resources: ['wood', 'rope', 'cloth'],
                dangers: ['wolf', 'bear'],
                exploreTime: 4,
                discoverable: [],
                description: '废弃的露营地，可能找到有用物品'
            }
        };
        
        // 危险事件
        const dangers = {
            wolf: {
                name: '狼袭击',
                health: 50,
                damage: 15,
                chance: 0.2,
                avoidItems: ['spear', 'bow'],
                avoidChance: 0.7,
                loot: { fur: 1, meat_raw: 1 },
                description: '凶猛的狼群攻击'
            },
            snake: {
                name: '毒蛇咬伤',
                health: 20,
                damage: 10,
                poison: true,
                chance: 0.15,
                avoidItems: [],
                avoidChance: 0.3,
                loot: {},
                description: '被毒蛇咬伤会中毒'
            },
            spider: {
                name: '蜘蛛咬伤',
                health: 15,
                damage: 5,
                poison: true,
                chance: 0.1,
                avoidItems: [],
                avoidChance: 0.2,
                loot: {},
                description: '有毒蜘蛛的咬伤'
            },
            bear: {
                name: '熊袭击',
                health: 100,
                damage: 30,
                chance: 0.1,
                avoidItems: ['spear', 'bow'],
                avoidChance: 0.5,
                loot: { fur: 2, meat_raw: 2 },
                description: '遭遇凶猛的熊'
            },
            piranha: {
                name: '食人鱼攻击',
                health: 30,
                damage: 20,
                chance: 0.15,
                avoidItems: [],
                avoidChance: 0.2,
                loot: {},
                description: '水中的食人鱼攻击'
            },
            bat: {
                name: '蝙蝠群',
                health: 25,
                damage: 5,
                chance: 0.3,
                avoidItems: [],
                avoidChance: 0.1,
                loot: {},
                description: '被蝙蝠群袭击'
            },
            fall: {
                name: '跌落',
                health: 0,
                damage: 25,
                chance: 0.05,
                avoidItems: ['rope'],
                avoidChance: 0.8,
                loot: {},
                description: '从高处跌落受伤'
            },
            crocodile: {
                name: '鳄鱼攻击',
                health: 80,
                damage: 35,
                chance: 0.1,
                avoidItems: ['spear', 'bow'],
                avoidChance: 0.6,
                loot: { leather: 1, meat_raw: 2 },
                description: '凶猛的鳄鱼袭击'
            },
            bat_swarm: {
                name: '蝙蝠群',
                health: 40,
                damage: 8,
                chance: 0.4,
                avoidItems: [],
                avoidChance: 0.1,
                loot: {},
                description: '大群蝙蝠攻击'
            },
            avalanche: {
                name: '雪崩',
                health: 0,
                damage: 40,
                chance: 0.05,
                avoidItems: [],
                avoidChance: 0.2,
                loot: {},
                description: '遭遇雪崩危险'
            },
            eagle: {
                name: '鹰袭击',
                health: 35,
                damage: 15,
                chance: 0.15,
                avoidItems: ['bow'],
                avoidChance: 0.5,
                loot: { feather: 2 },
                description: '猛禽攻击'
            }
        };
        
        // 天气数据
        const weatherTypes = {
            sunny: {
                name: '晴天',
                temperatureEffect: 0,
                dangerModifier: 1,
                imageFilter: 'brightness(1)'
            },
            rainy: {
                name: '雨天',
                temperatureEffect: -1,
                dangerModifier: 1.2,
                imageFilter: 'brightness(0.8) contrast(1.2)'
            },
            stormy: {
                name: '雷暴',
                temperatureEffect: -2,
                dangerModifier: 1.5,
                imageFilter: 'brightness(0.7) contrast(1.3)'
            },
            foggy: {
                name: '雾天',
                temperatureEffect: -1,
                dangerModifier: 0.8,
                imageFilter: 'brightness(0.9) contrast(0.8) blur(1px)'
            },
            snowy: {
                name: '雪天',
                temperatureEffect: -3,
                dangerModifier: 1.3,
                imageFilter: 'brightness(1.2) contrast(1.1)'
            }
        };
        
        // DOM元素
        const elements = {
            healthValue: document.getElementById('health-value'),
            hungerValue: document.getElementById('hunger-value'),
            thirstValue: document.getElementById('thirst-value'),
            energyValue: document.getElementById('energy-value'),
            tempValue: document.getElementById('temp-value'),
            dayCount: document.getElementById('day-count'),
            timeText: document.getElementById('time-text'),
            hourDisplay: document.getElementById('hour-display'),
            weatherText: document.getElementById('weather-text'),
            locationImage: document.getElementById('location-image'),
            eventLog: document.getElementById('event-log'),
            inventory: document.getElementById('inventory'),
            inventoryCount: document.getElementById('inventory-count'),
            inventoryMax: document.getElementById('inventory-max'),
            craftingList: document.getElementById('crafting-list'),
            actionProgressFill: document.getElementById('action-progress-fill'),
            
            // 按钮
            gatherBtn: document.getElementById('gather-btn'),
            huntBtn: document.getElementById('hunt-btn'),
            exploreBtn: document.getElementById('explore-btn'),
            restBtn: document.getElementById('rest-btn'),
            drinkBtn: document.getElementById('drink-btn'),
            eatBtn: document.getElementById('eat-btn'),
            buildBtn: document.getElementById('build-btn'),
            fireBtn: document.getElementById('fire-btn'),
            mapBtn: document.getElementById('map-btn'),
            skillsBtn: document.getElementById('skills-btn'),
            questsBtn: document.getElementById('quests-btn'),
            baseBtn: document.getElementById('base-btn'),
            craftingBtn: document.getElementById('crafting-btn'),
            
            // 设置按钮
            musicBtn: document.getElementById('music-btn'),
            soundBtn: document.getElementById('sound-btn'),
            saveBtn: document.getElementById('save-btn'),
            loadBtn: document.getElementById('load-btn'),
            nightBtn: document.getElementById('night-btn'),
            
            // 音乐控制按钮
            dayMusicBtn: document.getElementById('day-music-btn'),
            nightMusicBtn: document.getElementById('night-music-btn'),
            rainMusicBtn: document.getElementById('rain-music-btn'),
            
            // 音频
            dayMusic: document.getElementById('day-music'),
            nightMusic: document.getElementById('night-music'),
            rainMusic: document.getElementById('rain-music'),
            clickSound: document.getElementById('click-sound'),
            successSound: document.getElementById('success-sound'),
            failureSound: document.getElementById('failure-sound'),
            dangerSound: document.getElementById('danger-sound'),
            natureSound: document.getElementById('nature-sound'),
            combatSound: document.getElementById('combat-sound'),
            
            // 物品菜单
            itemMenu: document.getElementById('item-menu'),
            
            // 工具提示
            tooltip: document.getElementById('tooltip'),
            
            // 面板
            mapPanel: document.getElementById('map-panel'),
            mapContent: document.getElementById('map-content'),
            mapClose: document.getElementById('map-close'),
            
            skillsPanel: document.getElementById('skills-panel'),
            skillsClose: document.getElementById('skills-close'),
            
            questsPanel: document.getElementById('quests-panel'),
            questsClose: document.getElementById('quests-close'),
            
            basePanel: document.getElementById('base-panel'),
            baseClose: document.getElementById('base-close'),
            
            // 战斗面板
            combatPanel: document.getElementById('combat-panel'),
            enemyName: document.getElementById('enemy-name'),
            enemyHealthFill: document.getElementById('enemy-health-fill'),
            combatMessage: document.getElementById('combat-message'),
            attackBtn: document.getElementById('attack-btn'),
            defendBtn: document.getElementById('defend-btn'),
            useItemBtn: document.getElementById('use-item-btn'),
            fleeBtn: document.getElementById('flee-btn'),
            
            // 通知
            notification: document.getElementById('notification')
        };
        
        // 当前选中的物品
        let selectedItem = null;
        
        // 初始化游戏
        function initGame() {
            updateUI();
            renderInventory();
            updateTimeDisplay();
            updateLocationImage();
            updateWeather();
            renderMap();
            renderSkills();
            renderQuests();
            renderBase();
            
            // 加载保存的游戏
            loadGame();
            
            // 开始游戏循环
            setInterval(gameLoop, 1000);
            setInterval(saveGame, 30000); // 每30秒自动保存
            
            // 设置事件监听器
            setupEventListeners();
            
            // 初始化音乐
            initMusic();
            
            // 添加初始日志
            addToLog("你在一片陌生的荒野中醒来，必须想办法生存下去...", "info");
            addToLog("警告: 这是一个高难度生存游戏，死亡是常有的事!", "warning");
            
            // 点击物品菜单外部关闭菜单
            document.addEventListener('click', (e) => {
                if (!elements.itemMenu.contains(e.target) && !e.target.classList.contains('item')) {
                    elements.itemMenu.style.display = 'none';
                }
            });
            
            // 首次交互后播放音乐
            const handleFirstInteraction = () => {
                if (gameState.musicEnabled) {
                    updateBackgroundMusic();
                }
                if (gameState.soundEnabled) {
                    elements.natureSound.play().catch(e => console.log("自然音效被阻止:", e));
                }
                document.removeEventListener('click', handleFirstInteraction);
                document.removeEventListener('keydown', handleFirstInteraction);
            };
            
            document.addEventListener('click', handleFirstInteraction);
            document.addEventListener('keydown', handleFirstInteraction);
        }
        
        // 初始化音乐
        function initMusic() {
            // 设置音乐音量
            elements.dayMusic.volume = 0.3;
            elements.nightMusic.volume = 0.3;
            elements.rainMusic.volume = 0.3;
            elements.natureSound.volume = 0.2;
            
            // 播放自然音效
            if (gameState.soundEnabled) {
                elements.natureSound.play().catch(e => console.log("自然音效被阻止:", e));
            }
            
            // 根据时间播放背景音乐
            updateBackgroundMusic();
        }
        
        // 更新背景音乐
        function updateBackgroundMusic() {
            if (!gameState.musicEnabled) return;
            
            // 停止当前音乐
            if (gameState.currentMusic) {
                fadeOutAudio(gameState.currentMusic);
            }
            
            // 根据时间和天气选择音乐
            let newMusic;
            if (gameState.weather === 'rainy' || gameState.weather === 'stormy') {
                newMusic = elements.rainMusic;
            } else if (gameState.isDay) {
                newMusic = elements.dayMusic;
            } else {
                newMusic = elements.nightMusic;
            }
            
            // 播放新音乐
            gameState.currentMusic = newMusic;
            fadeInAudio(newMusic);
        }
        
        // 淡入音频
        function fadeInAudio(audioElement, duration = 2000) {
            audioElement.volume = 0;
            audioElement.currentTime = 0;
            audioElement.play().catch(e => console.log("音乐播放被阻止:", e));
            
            const fadeInterval = setInterval(() => {
                if (audioElement.volume < 0.3) {
                    audioElement.volume += 0.01;
                } else {
                    clearInterval(fadeInterval);
                }
            }, duration / 30);
        }
        
        // 淡出音频
        function fadeOutAudio(audioElement, duration = 2000) {
            const fadeInterval = setInterval(() => {
                if (audioElement.volume > 0.01) {
                    audioElement.volume -= 0.01;
                } else {
                    audioElement.pause();
                    clearInterval(fadeInterval);
                }
            }, duration / 30);
        }
        
        // 设置事件监听器
        function setupEventListeners() {
            // 行动按钮
            elements.gatherBtn.addEventListener('click', () => startAction('gather'));
            elements.huntBtn.addEventListener('click', () => startAction('hunt'));
            elements.exploreBtn.addEventListener('click', () => startAction('explore'));
            elements.restBtn.addEventListener('click', () => startAction('rest'));
            elements.drinkBtn.addEventListener('click', () => startAction('drink'));
            elements.eatBtn.addEventListener('click', () => startAction('eat'));
            elements.buildBtn.addEventListener('click', () => startAction('build'));
            elements.fireBtn.addEventListener('click', () => startAction('fire'));
            elements.mapBtn.addEventListener('click', showMap);
            elements.skillsBtn.addEventListener('click', showSkills);
            elements.questsBtn.addEventListener('click', showQuests);
            elements.baseBtn.addEventListener('click', showBase);
            
            // 制作按钮
            elements.craftingBtn.addEventListener('click', toggleCraftingList);
            
            // 设置按钮
            elements.musicBtn.addEventListener('click', toggleMusic);
            elements.soundBtn.addEventListener('click', toggleSound);
            elements.saveBtn.addEventListener('click', () => {
                saveGame();
                addToLog("游戏已保存", "success");
                playSound('success');
            });
            elements.loadBtn.addEventListener('click', () => {
                loadGame();
                addToLog("游戏已加载", "success");
                playSound('success');
            });
            elements.nightBtn.addEventListener('click', toggleNightMode);
            
            // 音乐控制按钮
            elements.dayMusicBtn.addEventListener('click', () => playSpecificMusic('day'));
            elements.nightMusicBtn.addEventListener('click', () => playSpecificMusic('night'));
            elements.rainMusicBtn.addEventListener('click', () => playSpecificMusic('rain'));
            
            // 面板关闭按钮
            elements.mapClose.addEventListener('click', hideMap);
            elements.skillsClose.addEventListener('click', hideSkills);
            elements.questsClose.addEventListener('click', hideQuests);
            elements.baseClose.addEventListener('click', hideBase);
            
            // 战斗按钮
            elements.attackBtn.addEventListener('click', combatAttack);
            elements.defendBtn.addEventListener('click', combatDefend);
            elements.useItemBtn.addEventListener('click', combatUseItem);
            elements.fleeBtn.addEventListener('click', combatFlee);
            
            // 基地升级按钮
            document.getElementById('upgrade-shelter-btn').addEventListener('click', upgradeShelter);
            document.getElementById('upgrade-storage-btn').addEventListener('click', upgradeStorage);
            document.getElementById('upgrade-workbench-btn').addEventListener('click', upgradeWorkbench);
            
            // 点击效果
            document.querySelectorAll('button').forEach(btn => {
                btn.addEventListener('click', () => playSound('click'));
            });
            
            // 物品提示
            setupItemTooltips();
        }
        
        // 设置物品提示
        function setupItemTooltips() {
            document.addEventListener('mousemove', (e) => {
                const itemElement = e.target.closest('.item');
                if (itemElement) {
                    const itemId = itemElement.dataset.itemId;
                    if (itemId && items[itemId]) {
                        elements.tooltip.textContent = items[itemId].description;
                        elements.tooltip.style.display = 'block';
                        elements.tooltip.style.left = `${e.pageX + 10}px`;
                        elements.tooltip.style.top = `${e.pageY + 10}px`;
                    }
                } else {
                    elements.tooltip.style.display = 'none';
                }
            });
        }
        
        // 播放特定音乐
        function playSpecificMusic(type) {
            if (!gameState.musicEnabled) return;
            
            // 停止当前音乐
            if (gameState.currentMusic) {
                fadeOutAudio(gameState.currentMusic);
            }
            
            // 根据类型选择音乐
            let newMusic;
            switch (type) {
                case 'day':
                    newMusic = elements.dayMusic;
                    gameState.weather = 'sunny';
                    break;
                case 'night':
                    newMusic = elements.nightMusic;
                    gameState.weather = 'sunny';
                    break;
                case 'rain':
                    newMusic = elements.rainMusic;
                    gameState.weather = 'rainy';
                    break;
            }
            
            // 更新天气显示
            updateWeather();
            
            // 播放新音乐
            gameState.currentMusic = newMusic;
            fadeInAudio(newMusic);
            
            addToLog(`切换为${type === 'day' ? '白天' : type === 'night' ? '夜晚' : '雨天'}音乐`, "info");
            playSound('click');
        }
        
        // 游戏主循环
        function gameLoop() {
            // 更新时间
            updateTime();
            
            // 更新玩家状态
            updatePlayerStatus();
            
            // 更新火的状态
            if (gameState.fire) {
                gameState.fireDuration--;
                if (gameState.fireDuration <= 0) {
                    gameState.fire = false;
                    addToLog("火堆熄灭了", "warning");
                }
            }
            
            // 更新天气
            if (gameState.weatherDuration <= 0) {
                changeWeather();
            } else {
                gameState.weatherDuration--;
            }
            
            // 随机事件
            if (Math.random() < 0.005) { // 0.5%几率随机事件
                triggerRandomEvent();
            }
            
            // 检查任务完成情况
            checkQuests();
            
            // 更新UI
            updateUI();
        }
        
        // 更新时间
        function updateTime() {
            gameState.minute += 5;
            
            if (gameState.minute >= 60) {
                gameState.minute = 0;
                gameState.hour++;
                
                if (gameState.hour >= 24) {
                    gameState.hour = 0;
                    gameState.day++;
                    gameState.stats.daysSurvived++;
                    addToLog(`第 ${gameState.day} 天开始了`, "info");
                    
                    // 每天重置每日任务
                    resetDailyQuests();
                    
                    // 每天增加难度
                    increaseDifficulty();
                }
            }
            
            // 更新昼夜状态
            const wasDay = gameState.isDay;
            gameState.isDay = (gameState.hour >= 6 && gameState.hour < 20);
            
            // 如果昼夜状态改变，更新音乐
            if (wasDay !== gameState.isDay) {
                updateBackgroundMusic();
            }
            
            updateTimeDisplay();
        }
        
        // 更新天气
        function changeWeather() {
            const weatherTypes = Object.keys(weatherTypes);
            const newWeather = weatherTypes[Math.floor(Math.random() * weatherTypes.length)];
            
            // 确保天气变化不要太频繁
            if (newWeather !== gameState.weather || Math.random() < 0.3) {
                gameState.weather = newWeather;
                gameState.weatherDuration = 60 + Math.floor(Math.random() * 120); // 1-3小时
                
                addToLog(`天气变为${weatherTypes[newWeather].name}`, "info");
                updateWeather();
                updateBackgroundMusic();
            }
        }
        
        // 更新天气显示
        function updateWeather() {
            const weather = weatherTypes[gameState.weather];
            elements.weatherText.textContent = weather.name;
            elements.locationImage.style.filter = weather.imageFilter;
        }
        
        // 增加游戏难度
        function increaseDifficulty() {
            // 每天增加资源消耗
            gameState.hunger -= 5 + Math.floor(gameState.day / 5);
            gameState.thirst -= 7 + Math.floor(gameState.day / 5);
            
            // 每5天增加库存上限
            if (gameState.day % 5 === 0) {
                gameState.inventoryMax += 2;
                showNotification(`库存上限增加至 ${gameState.inventoryMax}`);
            }
        }
        
        // 触发随机事件
        function triggerRandomEvent() {
            const events = [
                { name: "寒冷的夜晚", effect: () => { 
                    gameState.temperature -= 2; 
                    addToLog("夜晚异常寒冷，你的体温下降了", "warning"); 
                } },
                { name: "食物变质", effect: () => { 
                    if (gameState.inventory['meat_raw'] > 0) {
                        gameState.inventory['meat_raw'] = Math.max(0, gameState.inventory['meat_raw'] - 1);
                        addToLog("一些生肉变质了，不得不丢弃", "warning");
                    }
                } },
                { name: "发现资源", effect: () => {
                    const resource = getRandomResource();
                    addItem(resource, 1);
                    addToLog(`你意外发现了1个${items[resource].name}`, "success");
                } },
                { name: "受伤", effect: () => {
                    gameState.health -= 10;
                    addToLog("你在睡梦中受伤了", "danger");
                } },
                { name: "天气变化", effect: () => {
                    changeWeather();
                } },
                { name: "野生动物", effect: () => {
                    const location = locations[gameState.location];
                    if (location.dangers && location.dangers.length > 0) {
                        const dangerId = location.dangers[Math.floor(Math.random() * location.dangers.length)];
                        startCombat(dangerId);
                    }
                } },
                { name: "发现配方", effect: () => {
                    const allRecipes = Object.keys(recipes);
                    const undiscovered = allRecipes.filter(r => !gameState.unlockedRecipes.includes(r));
                    if (undiscovered.length > 0) {
                        const newRecipe = undiscovered[Math.floor(Math.random() * undiscovered.length)];
                        gameState.unlockedRecipes.push(newRecipe);
                        addToLog(`你灵光一现，想到了如何制作${recipes[newRecipe].name}`, "info");
                    }
                } }
            ];
            
            const event = events[Math.floor(Math.random() * events.length)];
            event.effect();
        }
        
        // 更新玩家状态
        function updatePlayerStatus() {
            // 饥饿和口渴影响健康
            if (gameState.hunger <= 0) {
                gameState.health -= 1;
                addToLog("你正在挨饿!", "danger");
            }
            
            if (gameState.thirst <= 0) {
                gameState.health -= 2;
                addToLog("你严重脱水!", "danger");
            }
            
            // 精力恢复
            if (!gameState.currentAction) {
                gameState.energy = Math.min(gameState.maxEnergy, gameState.energy + 0.5);
            }
            
            // 温度影响
            const weatherEffect = weatherTypes[gameState.weather].temperatureEffect;
            const baseTemp = gameState.isDay ? 37 : 35;
            const targetTemp = baseTemp + weatherEffect;
            
            // 缓慢向目标温度靠近
            if (gameState.temperature < targetTemp) {
                gameState.temperature += 0.1;
            } else if (gameState.temperature > targetTemp) {
                gameState.temperature -= 0.1;
            }
            
            // 火堆提供温暖
            if (gameState.fire) {
                gameState.temperature += 0.5;
            }
            
            // 庇护所提供温暖
            if (gameState.shelterLevel > 0) {
                gameState.temperature += gameState.shelterLevel * 0.3;
            }
            
            // 温度极端影响健康
            if (gameState.temperature < 35) {
                gameState.health -= 1;
                addToLog("你体温过低!", "danger");
            } else if (gameState.temperature > 39) {
                gameState.health -= 1;
                addToLog("你发烧了!", "danger");
            }
            
            // 检查死亡
            if (gameState.health <= 0) {
                gameOver();
            }
            
            // 确保数值在合理范围内
            gameState.health = Math.max(0, Math.min(gameState.maxHealth, gameState.health));
            gameState.hunger = Math.max(0, Math.min(gameState.maxHunger, gameState.hunger));
            gameState.thirst = Math.max(0, Math.min(gameState.maxThirst, gameState.thirst));
            gameState.energy = Math.max(0, Math.min(gameState.maxEnergy, gameState.energy));
            gameState.temperature = Math.max(30, Math.min(42, gameState.temperature));
        }
        
        // 游戏结束
        function gameOver() {
            addToLog("你死了...", "danger");
            addToLog(`生存天数: ${gameState.day}`, "info");
            addToLog("游戏将在10秒后重新开始", "info");
            playSound('danger');
            
            // 禁用所有按钮
            document.querySelectorAll('button').forEach(btn => {
                btn.disabled = true;
            });
            
            // 停止所有音乐
            fadeOutAudio(elements.dayMusic);
            fadeOutAudio(elements.nightMusic);
            fadeOutAudio(elements.rainMusic);
            elements.natureSound.pause();
            
            // 10秒后重置游戏
            setTimeout(() => {
                resetGame();
            }, 10000);
        }
        
        // 重置游戏
        function resetGame() {
            // 重置状态
            gameState.health = 100;
            gameState.hunger = 80;
            gameState.thirst = 75;
            gameState.energy = 90;
            gameState.temperature = 36.5;
            gameState.day = 1;
            gameState.hour = 6;
            gameState.minute = 0;
            gameState.inventory = {};
            gameState.location = 'forest';
            gameState.discoveredLocations = ['forest'];
            gameState.shelterLevel = 0;
            gameState.storageLevel = 0;
            gameState.workbenchLevel = 0;
            gameState.fire = false;
            gameState.fireDuration = 0;
            gameState.currentAction = null;
            gameState.actionProgress = 0;
            gameState.weather = 'sunny';
            gameState.weatherDuration = 0;
            
            // 重置技能
            for (const skill in gameState.skills) {
                gameState.skills[skill] = { level: 1, xp: 0, xpToNext: 100 };
            }
            
            // 重置任务
            gameState.quests = {
                daily: {
                    gatherWood: { target: 10, progress: 0, completed: false },
                    huntAnimals: { target: 3, progress: 0, completed: false }
                },
                main: {
                    buildShelter: { completed: false }
                }
            };
            
            // 启用按钮
            document.querySelectorAll('button').forEach(btn => {
                btn.disabled = false;
            });
            
            // 更新UI
            updateUI();
            renderInventory();
            updateTimeDisplay();
            updateLocationImage();
            updateWeather();
            renderSkills();
            renderQuests();
            
            // 重新开始音乐
            initMusic();
            
            addToLog("新的生存挑战开始了...", "info");
        }
        
        // 开始一个行动
        function startAction(action) {
            if (gameState.currentAction) {
                addToLog("你已经在进行一个行动了", "warning");
                return;
            }
            
            if (gameState.inCombat) {
                addToLog("你正在战斗中，无法执行此行动", "warning");
                return;
            }
            
            if (gameState.energy < 10) {
                addToLog("你太累了，无法行动", "warning");
                return;
            }
            
            playSound('click');
            
            switch (action) {
                case 'gather':
                    gameState.currentAction = 'gather';
                    gameState.actionDifficulty = 5 + Math.floor(gameState.day / 3);
                    addToLog("开始采集资源...", "info");
                    break;
                    
                case 'hunt':
                    gameState.currentAction = 'hunt';
                    gameState.actionDifficulty = 10 + Math.floor(gameState.day / 2);
                    addToLog("开始狩猎...", "info");
                    break;
                    
                case 'explore':
                    gameState.currentAction = 'explore';
                    gameState.actionDifficulty = locations[gameState.location].exploreTime;
                    addToLog("开始探索周围...", "info");
                    break;
                    
                case 'rest':
                    gameState.currentAction = 'rest';
                    gameState.actionDifficulty = 4;
                    addToLog("开始休息...", "info");
                    break;
                    
                case 'drink':
                    if (gameState.inventory['water'] > 0) {
                        gameState.currentAction = 'drink';
                        gameState.actionDifficulty = 1;
                        addToLog("喝水...", "info");
                    } else {
                        addToLog("你没有水可以喝", "warning");
                        return;
                    }
                    break;
                    
                case 'eat':
                    if (gameState.inventory['berries'] > 0 || gameState.inventory['meat_cooked'] > 0 || gameState.inventory['meat_raw'] > 0) {
                        gameState.currentAction = 'eat';
                        gameState.actionDifficulty = 2;
                        addToLog("进食...", "info");
                    } else {
                        addToLog("你没有食物可以吃", "warning");
                        return;
                    }
                    break;
                    
                case 'build':
                    toggleCraftingList();
                    addToLog("选择要制作的物品", "info");
                    return;
                    
                case 'fire':
                    if (!gameState.fire) {
                        if (gameState.inventory['wood'] >= 3 && gameState.inventory['stone'] >= 2) {
                            gameState.currentAction = 'fire';
                            gameState.actionDifficulty = 5;
                            addToLog("开始生火...", "info");
                        } else {
                            addToLog("你需要3个木材和2个石头来生火", "warning");
                            return;
                        }
                    } else {
                        addToLog("火已经燃着了", "info");
                        return;
                    }
                    break;
            }
            
            // 开始行动进度
            gameState.actionProgress = 0;
            elements.actionProgressFill.style.width = '0%';
            
            // 开始行动计时器
            gameState.actionInterval = setInterval(() => {
                gameState.actionProgress++;
                elements.actionProgressFill.style.width = `${(gameState.actionProgress / gameState.actionDifficulty) * 100}%`;
                
                // 消耗精力
                gameState.energy = Math.max(0, gameState.energy - 0.5);
                
                // 行动完成
                if (gameState.actionProgress >= gameState.actionDifficulty) {
                    completeAction();
                }
            }, 1000);
        }
        
        // 完成当前行动
        function completeAction() {
            clearInterval(gameState.actionInterval);
            elements.actionProgressFill.style.width = '0%';
            
            const action = gameState.currentAction;
            gameState.currentAction = null;
            
            switch (action) {
                case 'gather':
                    gatherResources();
                    break;
                    
                case 'hunt':
                    hunt();
                    break;
                    
                case 'explore':
                    explore();
                    break;
                    
                case 'rest':
                    rest();
                    break;
                    
                case 'drink':
                    drink();
                    break;
                    
                case 'eat':
                    eat();
                    break;
                    
                case 'fire':
                    makeFire();
                    break;
            }
        }
        
        // 采集资源
        function gatherResources() {
            const location = locations[gameState.location];
            let gathered = false;
            
            // 尝试采集每种资源
            location.resources.forEach(resource => {
                // 根据技能等级提高采集成功率
                let successChance = 0.7;
                if (resource === 'wood' && gameState.skills.woodcutting.level > 1) {
                    successChance += gameState.skills.woodcutting.level * 0.05;
                } else if ((resource === 'stone' || resource === 'iron_ore') && gameState.skills.mining.level > 1) {
                    successChance += gameState.skills.mining.level * 0.05;
                }
                
                if (Math.random() < successChance) {
                    let amount = Math.floor(Math.random() * 2) + 1; // 1-2个
                    
                    // 技能提高采集数量
                    if (resource === 'wood' && gameState.skills.woodcutting.level > 1) {
                        amount += Math.floor(gameState.skills.woodcutting.level / 2);
                    } else if ((resource === 'stone' || resource === 'iron_ore') && gameState.skills.mining.level > 1) {
                        amount += Math.floor(gameState.skills.mining.level / 2);
                    }
                    
                    addItem(resource, amount);
                    addToLog(`获得了 ${amount} 个${items[resource].name}`, "success");
                    gathered = true;
                    gameState.stats.itemsGathered += amount;
                    
                    // 增加技能经验
                    if (resource === 'wood') {
                        addSkillXP('woodcutting', 10);
                    } else if (resource === 'stone' || resource === 'iron_ore') {
                        addSkillXP('mining', 10);
                    } else {
                        addSkillXP('survival', 5);
                    }
                    
                    // 发现新物品
                    if (!gameState.discoveredItems.includes(resource)) {
                        gameState.discoveredItems.push(resource);
                        addToLog(`发现了新资源: ${items[resource].name}`, "info");
                    }
                }
            });
            
            if (!gathered) {
                addToLog("没有找到任何有用的资源", "warning");
            }
            
            // 有几率遇到危险
            checkForDanger();
            
            playSound(gathered ? 'success' : 'failure');
        }
        
        // 狩猎
        function hunt() {
            const location = locations[gameState.location];
            
            // 根据狩猎技能提高成功率
            let successChance = 0.6 + (gameState.skills.hunting.level * 0.05);
            successChance = Math.min(0.9, successChance);
            
            if (location.dangers && location.dangers.length > 0 && Math.random() < successChance) {
                // 狩猎成功
                const resource = 'meat_raw';
                let amount = Math.floor(Math.random() * 2) + 1; // 1-2个
                
                // 技能提高狩猎数量
                amount += Math.floor(gameState.skills.hunting.level / 2);
                
                addItem(resource, amount);
                addToLog(`狩猎成功! 获得了 ${amount} 个${items[resource].name}`, "success");
                gameState.stats.animalsHunted += amount;
                playSound('success');
                
                // 增加狩猎技能经验
                addSkillXP('hunting', 15);
                
                // 更新狩猎任务进度
                if (gameState.quests.daily.huntAnimals && !gameState.quests.daily.huntAnimals.completed) {
                    gameState.quests.daily.huntAnimals.progress += amount;
                    renderQuests();
                }
                
                // 有额外几率获得毛皮
                if (Math.random() < 0.4) {
                    addItem('fur', 1);
                    addToLog("获得了 1 个毛皮", "success");
                }
            } else {
                addToLog("狩猎失败，没有找到猎物", "warning");
                playSound('failure');
                
                // 即使失败也获得少量经验
                addSkillXP('hunting', 5);
            }
            
            // 狩猎有更高几率遇到危险
            if (Math.random() < 0.5) {
                checkForDanger(0.2); // 额外20%危险几率
            }
        }
        
        // 探索
        function explore() {
            const location = locations[gameState.location];
            
            if (location.discoverable && location.discoverable.length > 0 && Math.random() < 0.5) {
                // 发现新地点
                const newLocation = location.discoverable[Math.floor(Math.random() * location.discoverable.length)];
                
                if (!gameState.discoveredLocations.includes(newLocation)) {
                    gameState.discoveredLocations.push(newLocation);
                    addToLog(`发现了一个新的地点: ${locations[newLocation].name}`, "success");
                    gameState.stats.locationsExplored++;
                    playSound('success');
                    
                    // 重新渲染地图
                    renderMap();
                } else {
                    addToLog("没有发现新的地点", "info");
                    playSound('failure');
                }
            } else {
                addToLog("探索没有发现任何新地点", "info");
                playSound('failure');
            }
            
            // 探索有几率遇到危险
            checkForDanger();
            
            // 探索总能找到一些资源
            if (Math.random() < 0.8) {
                const resource = getRandomResource();
                addItem(resource, 1);
                addToLog(`在探索中找到了1个${items[resource].name}`, "info");
            }
        }
        
        // 休息
        function rest() {
            const healthRecover = 10 + Math.floor(gameState.shelterLevel * 5);
            const energyRecover = 30 + Math.floor(gameState.shelterLevel * 10);
            
            gameState.health = Math.min(gameState.maxHealth, gameState.health + healthRecover);
            gameState.energy = Math.min(gameState.maxEnergy, gameState.energy + energyRecover);
            
            addToLog(`休息后恢复了 ${healthRecover} 点健康和 ${energyRecover} 点精力`, "success");
            
            // 庇护所提供更好的休息效果
            if (gameState.shelterLevel > 0) {
                addToLog("庇护所让你休息得更好", "info");
            }
            
            // 有几率恢复体温
            if (Math.random() < 0.7) {
                gameState.temperature = Math.min(37, gameState.temperature + 0.5);
            }
            
            playSound('success');
        }
        
        // 喝水
        function drink() {
            if (gameState.inventory['water'] > 0) {
                gameState.inventory['water']--;
                gameState.thirst = Math.min(gameState.maxThirst, gameState.thirst + 30);
                addToLog("喝了一些水，口渴感减轻了", "success");
                playSound('success');
                
                // 有几率恢复少量健康
                if (Math.random() < 0.3) {
                    gameState.health = Math.min(gameState.maxHealth, gameState.health + 5);
                    addToLog("干净的水让你感觉好一些了", "info");
                }
            }
        }
        
        // 进食
        function eat() {
            let foodEaten = false;
            
            // 优先吃熟肉
            if (gameState.inventory['meat_cooked'] > 0) {
                gameState.inventory['meat_cooked']--;
                gameState.hunger = Math.min(gameState.maxHunger, gameState.hunger + 40);
                addToLog("吃了一些熟肉，饥饿感大大减轻", "success");
                foodEaten = true;
                
                // 增加烹饪技能经验
                addSkillXP('cooking', 5);
            } 
            // 其次吃浆果
            else if (gameState.inventory['berries'] > 0) {
                gameState.inventory['berries']--;
                gameState.hunger = Math.min(gameState.maxHunger, gameState.hunger + 15);
                addToLog("吃了一些浆果，饥饿感减轻了", "success");
                foodEaten = true;
                
                // 浆果有几率中毒
                if (Math.random() < 0.1) {
                    gameState.health -= 10;
                    addToLog("这些浆果有毒! 你感觉不舒服", "danger");
                }
            }
            // 最后吃生肉
            else if (gameState.inventory['meat_raw'] > 0) {
                gameState.inventory['meat_raw']--;
                gameState.hunger = Math.min(gameState.maxHunger, gameState.hunger + 20);
                addToLog("吃了一些生肉，饥饿感减轻了", "success");
                foodEaten = true;
                
                // 生肉有较高几率中毒
                if (Math.random() < 0.4) {
                    gameState.health -= 15;
                    addToLog("生肉让你生病了!", "danger");
                }
            }
            
            if (foodEaten) {
                playSound('success');
            } else {
                addToLog("你没有食物可以吃", "warning");
                playSound('failure');
            }
        }
        
        // 生火
        function makeFire() {
            gameState.inventory['wood'] -= 3;
            gameState.inventory['stone'] -= 2;
            gameState.fire = true;
            gameState.fireDuration = 120 + Math.floor(Math.random() * 60); // 2-3小时
            addToLog("成功生起了火堆，可以提供温暖和烹饪食物", "success");
            playSound('success');
            
            // 增加生火技能经验
            addSkillXP('firemaking', 20);
            
            // 解锁烤肉配方
            if (!gameState.unlockedRecipes.includes('cooked_meat')) {
                gameState.unlockedRecipes.push('cooked_meat');
                addToLog("解锁了新配方: 烤肉", "info");
            }
        }
        
        // 检查危险
        function checkForDanger(extraChance = 0) {
            const location = locations[gameState.location];
            
            if (location.dangers && location.dangers.length > 0) {
                location.dangers.forEach(dangerId => {
                    const danger = dangers[dangerId];
                    const chance = (danger.chance + extraChance) * weatherTypes[gameState.weather].dangerModifier;
                    
                    if (Math.random() < chance) {
                        // 检查是否有避免危险的物品
                        let avoided = false;
                        if (danger.avoidItems.length > 0) {
                            danger.avoidItems.forEach(itemId => {
                                if (gameState.inventory[itemId] > 0 && Math.random() < danger.avoidChance) {
                                    avoided = true;
                                    addToLog(`你使用${items[itemId].name}避免了${danger.name}`, "success");
                                }
                            });
                        }
                        
                        if (!avoided) {
                            // 进入战斗或受到伤害
                            if (danger.health > 0) {
                                startCombat(dangerId);
                            } else {
                                // 受到环境伤害
                                gameState.health -= danger.damage;
                                addToLog(`${danger.name}! 受到 ${danger.damage} 点伤害`, "danger");
                                playSound('danger');
                                
                                // 毒效果
                                if (danger.poison) {
                                    gameState.health -= 5;
                                    addToLog("中毒了! 持续受到伤害", "danger");
                                }
                                
                                // 获得战利品
                                if (Object.keys(danger.loot).length > 0) {
                                    Object.entries(danger.loot).forEach(([itemId, amount]) => {
                                        addItem(itemId, amount);
                                        addToLog(`从${danger.name}获得了 ${amount} 个${items[itemId].name}`, "info");
                                    });
                                }
                            }
                        }
                    }
                });
            }
        }
        
        // 开始战斗
        function startCombat(enemyId) {
            gameState.inCombat = true;
            gameState.enemy = {
                id: enemyId,
                ...dangers[enemyId],
                currentHealth: dangers[enemyId].health
            };
            
            // 暂停当前行动
            if (gameState.currentAction) {
                clearInterval(gameState.actionInterval);
                gameState.currentAction = null;
            }
            
            // 更新战斗UI
            elements.enemyName.textContent = gameState.enemy.name;
            elements.enemyHealthFill.style.width = '100%';
            elements.combatMessage.textContent = `${gameState.enemy.name}向你扑来!`;
            
            // 显示战斗面板
            elements.combatPanel.style.display = 'flex';
            
            addToLog(`遭遇了${gameState.enemy.name}!`, "danger");
            playSound('danger');
        }
        
        // 战斗攻击
        function combatAttack() {
            if (!gameState.inCombat) return;
            
            // 计算玩家伤害
            let playerDamage = 10 + Math.floor(Math.random() * 10);
            
            // 武器加成
            if (gameState.inventory['spear']) {
                playerDamage += 15;
            } else if (gameState.inventory['bow']) {
                playerDamage += 10;
            }
            
            // 战斗技能加成
            playerDamage += gameState.skills.combat.level * 2;
            
            // 应用伤害
            gameState.enemy.currentHealth -= playerDamage;
            
            // 更新敌人生命值
            const healthPercent = (gameState.enemy.currentHealth / gameState.enemy.health) * 100;
            elements.enemyHealthFill.style.width = `${healthPercent}%`;
            
            elements.combatMessage.textContent = `你对${gameState.enemy.name}造成了${playerDamage}点伤害!`;
            playSound('combat');
            
            // 增加战斗经验
            addSkillXP('combat', 10);
            
            // 检查敌人是否被击败
            if (gameState.enemy.currentHealth <= 0) {
                endCombat(true);
                return;
            }
            
            // 敌人反击
            setTimeout(() => {
                enemyAttack();
            }, 1000);
        }
        
        // 敌人攻击
        function enemyAttack() {
            if (!gameState.inCombat) return;
            
            // 计算伤害
            let damage = gameState.enemy.damage;
            
            // 防御减免
            if (gameState.inventory['armor']) {
                damage = Math.max(5, damage - 10);
            }
            
            // 应用伤害
            gameState.health -= damage;
            
            elements.combatMessage.textContent = `${gameState.enemy.name}对你造成了${damage}点伤害!`;
            playSound('combat');
            
            // 检查玩家是否死亡
            if (gameState.health <= 0) {
                gameOver();
                return;
            }
            
            // 更新UI
            updateUI();
        }
        
        // 战斗防御
        function combatDefend() {
            if (!gameState.inCombat) return;
            
            // 防御减少伤害
            elements.combatMessage.textContent = `你采取了防御姿态，准备抵挡${gameState.enemy.name}的攻击`;
            
            // 敌人攻击
            setTimeout(() => {
                let damage = Math.max(5, gameState.enemy.damage - 15);
                gameState.health -= damage;
                
                elements.combatMessage.textContent = `你防御了${gameState.enemy.name}的攻击，只受到${damage}点伤害`;
                playSound('combat');
                
                // 增加防御经验
                addSkillXP('combat', 5);
                
                // 检查玩家是否死亡
                if (gameState.health <= 0) {
                    gameOver();
                    return;
                }
                
                updateUI();
            }, 1000);
        }
        
        // 战斗中使用物品
        function combatUseItem() {
            if (!gameState.inCombat) return;
            
            elements.combatMessage.textContent = "选择要使用的物品";
            
            // 显示可用物品
            const usableItems = Object.keys(gameState.inventory).filter(itemId => 
                items[itemId].actions.includes('use') || 
                items[itemId].actions.includes('heal')
            );
            
            if (usableItems.length === 0) {
                elements.combatMessage.textContent = "你没有可用的物品";
                return;
            }
            
            // 创建物品菜单
            elements.itemMenu.innerHTML = '';
            usableItems.forEach(itemId => {
                const button = document.createElement('button');
                button.textContent = `使用 ${items[itemId].name}`;
                button.addEventListener('click', () => {
                    useItem(itemId, items[itemId].actions.includes('use') ? 'use' : 'heal');
                    elements.itemMenu.style.display = 'none';
                    
                    // 敌人仍然会攻击
                    setTimeout(() => {
                        enemyAttack();
                    }, 1000);
                });
                elements.itemMenu.appendChild(button);
            });
            
            elements.itemMenu.style.display = 'block';
            elements.itemMenu.style.left = '50%';
            elements.itemMenu.style.top = '50%';
            elements.itemMenu.style.transform = 'translate(-50%, -50%)';
        }
        
        // 逃跑
        function combatFlee() {
            if (!gameState.inCombat) return;
            
            // 逃跑成功率
            const fleeChance = 0.5 + (gameState.skills.combat.level * 0.05);
            
            if (Math.random() < fleeChance) {
                elements.combatMessage.textContent = `你成功从${gameState.enemy.name}身边逃走了`;
                playSound('success');
                
                // 结束战斗
                setTimeout(() => {
                    endCombat(false);
                }, 1000);
            } else {
                elements.combatMessage.textContent = `逃跑失败! ${gameState.enemy.name}追上了你`;
                playSound('failure');
                
                // 敌人攻击
                setTimeout(() => {
                    enemyAttack();
                }, 1000);
            }
        }
        
        // 结束战斗
        function endCombat(victory) {
            gameState.inCombat = false;
            elements.combatPanel.style.display = 'none';
            
            if (victory) {
                addToLog(`你击败了${gameState.enemy.name}!`, "success");
                playSound('success');
                gameState.stats.enemiesDefeated++;
                
                // 获得战利品
                const loot = dangers[gameState.enemy.id].loot;
                if (Object.keys(loot).length > 0) {
                    Object.entries(loot).forEach(([itemId, amount]) => {
                        addItem(itemId, amount);
                        addToLog(`获得了 ${amount} 个${items[itemId].name}`, "info");
                    });
                }
            }
            
            gameState.enemy = null;
            updateUI(); // 确保UI更新
        }
        
        // 获取随机资源
        function getRandomResource() {
            const location = locations[gameState.location];
            return location.resources[Math.floor(Math.random() * location.resources.length)];
        }
        
        // 添加物品到库存
        function addItem(itemId, amount = 1) {
            if (!gameState.inventory[itemId]) {
                gameState.inventory[itemId] = 0;
            }
            
            // 检查库存空间
            const currentWeight = getInventoryWeight();
            const itemWeight = items[itemId].weight * amount;
            
            if (currentWeight + itemWeight > gameState.inventoryMax) {
                addToLog("库存已满，无法携带更多物品", "warning");
                return false;
            }
            
            gameState.inventory[itemId] += amount;
            
            // 更新采集木材任务进度
            if (itemId === 'wood' && gameState.quests.daily.gatherWood && !gameState.quests.daily.gatherWood.completed) {
                gameState.quests.daily.gatherWood.progress += amount;
                renderQuests();
            }
            
            renderInventory();
            return true;
        }
        
        // 从库存移除物品
        function removeItem(itemId, amount = 1) {
            if (!gameState.inventory[itemId] || gameState.inventory[itemId] < amount) {
                return false;
            }
            
            gameState.inventory[itemId] -= amount;
            
            if (gameState.inventory[itemId] <= 0) {
                delete gameState.inventory[itemId];
            }
            
            renderInventory();
            return true;
        }
        
        // 计算库存总重量
        function getInventoryWeight() {
            let total = 0;
            Object.entries(gameState.inventory).forEach(([itemId, count]) => {
                total += items[itemId].weight * count;
            });
            return total;
        }
        
        // 制作物品
        function craftItem(recipeId) {
            const recipe = recipes[recipeId];
            
            // 检查材料
            for (const [itemId, amount] of Object.entries(recipe.ingredients)) {
                if (!gameState.inventory[itemId] || gameState.inventory[itemId] < amount) {
                    addToLog(`制作需要 ${amount} 个${items[itemId].name}`, "warning");
                    playSound('failure');
                    return;
                }
            }
            
            // 检查火堆需求
            if (recipe.requiresFire && !gameState.fire) {
                addToLog("制作这个物品需要生火", "warning");
                playSound('failure');
                return;
            }
            
            // 检查工作台需求
            if (recipe.skill === 'crafting' && gameState.workbenchLevel < (recipe.unlockLevel - 1)) {
                addToLog("需要更高级的工作台来制作这个物品", "warning");
                playSound('failure');
                return;
            }
            
            // 消耗材料
            for (const [itemId, amount] of Object.entries(recipe.ingredients)) {
                removeItem(itemId, amount);
            }
            
            // 开始制作
            gameState.currentAction = 'craft';
            gameState.craftingRecipe = recipeId;
            gameState.actionDifficulty = recipe.time;
            gameState.actionProgress = 0;
            elements.actionProgressFill.style.width = '0%';
            
            addToLog(`开始制作 ${recipe.name}...`, "info");
            
            // 制作计时器
            gameState.actionInterval = setInterval(() => {
                gameState.actionProgress++;
                elements.actionProgressFill.style.width = `${(gameState.actionProgress / gameState.actionDifficulty) * 100}%`;
                
                // 消耗精力
                gameState.energy = Math.max(0, gameState.energy - 0.5);
                
                // 制作完成
                if (gameState.actionProgress >= gameState.actionDifficulty) {
                    clearInterval(gameState.actionInterval);
                    elements.actionProgressFill.style.width = '0%';
                    
                    // 获取制作结果
                    let resultItem = null;
                    
                    switch (recipeId) {
                        case 'bandage':
                            resultItem = 'bandage';
                            break;
                        case 'spear':
                            resultItem = 'spear';
                            break;
                        case 'rope':
                            resultItem = 'rope';
                            break;
                        case 'cooked_meat':
                            resultItem = 'meat_cooked';
                            break;
                        case 'fishing_rod':
                            resultItem = 'fishing_rod';
                            break;
                        case 'trap':
                            resultItem = 'trap';
                            break;
                        case 'bow':
                            resultItem = 'bow';
                            break;
                        case 'arrow':
                            resultItem = 'arrow';
                            break;
                        case 'medicine':
                            resultItem = 'medicine';
                            break;
                        case 'armor':
                            resultItem = 'armor';
                            break;
                    }
                    
                    if (resultItem) {
                        if (addItem(resultItem, 1)) {
                            addToLog(`成功制作了1个${items[resultItem].name}`, "success");
                            gameState.stats.itemsCrafted++;
                            playSound('success');
                            
                            // 检查是否完成建造庇护所任务
                            if (recipeId === 'shelter' && gameState.quests.main.buildShelter && !gameState.quests.main.buildShelter.completed) {
                                gameState.quests.main.buildShelter.completed = true;
                                addToLog("完成了主线任务: 建造庇护所!", "success");
                                addToLog("奖励: 解锁基地功能", "info");
                                renderQuests();
                            }
                        }
                    } else if (recipeId === 'shelter') {
                        gameState.shelterLevel++;
                        addToLog("成功建造了庇护所，现在可以更好地休息了", "success");
                        playSound('success');
                        
                        // 检查是否完成建造庇护所任务
                        if (gameState.quests.main.buildShelter && !gameState.quests.main.buildShelter.completed) {
                            gameState.quests.main.buildShelter.completed = true;
                            addToLog("完成了主线任务: 建造庇护所!", "success");
                            addToLog("奖励: 解锁基地功能", "info");
                            renderQuests();
                        }
                    } else if (recipeId === 'fire') {
                        makeFire();
                    }
                    
                    gameState.currentAction = null;
                    
                    // 增加制作技能经验
                    if (recipe.skill) {
                        addSkillXP(recipe.skill, 15);
                    }
                }
            }, 1000);
        }
        
        // 切换制作列表显示
        function toggleCraftingList() {
            if (elements.craftingList.style.display === 'flex') {
                elements.craftingList.style.display = 'none';
                elements.craftingBtn.innerHTML = '制作物品 ▼';
            } else {
                renderCraftingList();
                elements.craftingList.style.display = 'flex';
                elements.craftingBtn.innerHTML = '制作物品 ▲';
            }
            playSound('click');
        }
        
        // 渲染制作列表
        function renderCraftingList() {
            elements.craftingList.innerHTML = '';
            
            gameState.unlockedRecipes.forEach(recipeId => {
                const recipe = recipes[recipeId];
                const item = document.createElement('div');
                item.className = 'craft-item';
                item.innerHTML = `<strong>${recipe.name}</strong><br><small>${recipe.description}</small>`;
                
                // 显示所需材料
                let materials = '';
                for (const [itemId, amount] of Object.entries(recipe.ingredients)) {
                    materials += `${amount}${items[itemId].emoji} `;
                }
                
                item.innerHTML += `<br><small>需要: ${materials}</small>`;
                
                // 检查是否满足材料
                let canCraft = true;
                for (const [itemId, amount] of Object.entries(recipe.ingredients)) {
                    if (!gameState.inventory[itemId] || gameState.inventory[itemId] < amount) {
                        canCraft = false;
                        item.style.opacity = '0.6';
                    }
                }
                
                if (canCraft) {
                    item.addEventListener('click', () => craftItem(recipeId));
                }
                
                elements.craftingList.appendChild(item);
            });
        }
        
        // 渲染物品栏
        function renderInventory() {
            elements.inventory.innerHTML = '';
            
            Object.entries(gameState.inventory).forEach(([itemId, count]) => {
                const item = document.createElement('div');
                item.className = 'item';
                item.dataset.itemId = itemId;
                item.innerHTML = `${items[itemId].emoji} ${items[itemId].name} <span class="item-count">${count}</span>`;
                
                // 显示耐久度
                if (items[itemId].durability) {
                    item.innerHTML += ` <small>(${items[itemId].durability})</small>`;
                }
                
                // 添加点击事件
                item.addEventListener('click', (e) => {
                    e.stopPropagation();
                    showItemMenu(itemId, e);
                });
                
                elements.inventory.appendChild(item);
            });
            
            elements.inventoryCount.textContent = Math.floor(getInventoryWeight());
            elements.inventoryMax.textContent = gameState.inventoryMax;
        }
        
        // 显示物品菜单
        function showItemMenu(itemId, event) {
            selectedItem = itemId;
            const item = items[itemId];
            
            // 清空菜单
            elements.itemMenu.innerHTML = '';
            
            // 添加可用操作
            item.actions.forEach(action => {
                const button = document.createElement('button');
                
                switch (action) {
                    case 'eat':
                        button.textContent = '食用';
                        button.addEventListener('click', () => useItem(itemId, 'eat'));
                        break;
                    case 'drink':
                        button.textContent = '饮用';
                        button.addEventListener('click', () => useItem(itemId, 'drink'));
                        break;
                    case 'use':
                        button.textContent = '使用';
                        button.addEventListener('click', () => useItem(itemId, 'use'));
                        break;
                    case 'heal':
                        button.textContent = '治疗';
                        button.addEventListener('click', () => useItem(itemId, 'heal'));
                        break;
                    case 'craft':
                        button.textContent = '制作';
                        button.addEventListener('click', () => useItem(itemId, 'craft'));
                        break;
                    case 'burn':
                        button.textContent = '燃烧';
                        button.addEventListener('click', () => useItem(itemId, 'burn'));
                        break;
                    case 'equip':
                        button.textContent = '装备';
                        button.addEventListener('click', () => useItem(itemId, 'equip'));
                        break;
                    case 'cook':
                        button.textContent = '烹饪';
                        button.addEventListener('click', () => useItem(itemId, 'cook'));
                        break;
                    case 'build':
                        button.textContent = '建造';
                        button.addEventListener('click', () => useItem(itemId, 'build'));
                        break;
                }
                
                elements.itemMenu.appendChild(button);
            });
            
            // 添加丢弃选项
            const discardBtn = document.createElement('button');
            discardBtn.textContent = '丢弃';
            discardBtn.addEventListener('click', () => {
                removeItem(itemId, 1);
                addToLog(`丢弃了1个${item.name}`, "info");
                elements.itemMenu.style.display = 'none';
                playSound('click');
            });
            elements.itemMenu.appendChild(discardBtn);
            
            // 显示菜单
            elements.itemMenu.style.display = 'block';
            elements.itemMenu.style.left = `${event.pageX}px`;
            elements.itemMenu.style.top = `${event.pageY}px`;
            
            playSound('click');
        }
        
        // 使用物品
        function useItem(itemId, action) {
            const item = items[itemId];
            elements.itemMenu.style.display = 'none';
            
            switch (action) {
                case 'eat':
                    if (itemId === 'berries' || itemId === 'meat_raw' || itemId === 'meat_cooked') {
                        removeItem(itemId, 1);
                        
                        if (itemId === 'berries') {
                            gameState.hunger = Math.min(gameState.maxHunger, gameState.hunger + 15);
                            addToLog("吃了一些浆果，饥饿感减轻了", "success");
                            
                            // 浆果有几率中毒
                            if (Math.random() < 0.1) {
                                gameState.health -= 10;
                                addToLog("这些浆果有毒! 你感觉不舒服", "danger");
                            }
                        } else if (itemId === 'meat_raw') {
                            gameState.hunger = Math.min(gameState.maxHunger, gameState.hunger + 20);
                            addToLog("吃了一些生肉，饥饿感减轻了", "success");
                            
                            // 生肉有较高几率中毒
                            if (Math.random() < 0.4) {
                                gameState.health -= 15;
                                addToLog("生肉让你生病了!", "danger");
                            }
                        } else if (itemId === 'meat_cooked') {
                            gameState.hunger = Math.min(gameState.maxHunger, gameState.hunger + 40);
                            addToLog("吃了一些熟肉，饥饿感大大减轻", "success");
                        }
                        
                        playSound('success');
                    }
                    break;
                    
                case 'drink':
                    if (itemId === 'water') {
                        removeItem(itemId, 1);
                        gameState.thirst = Math.min(gameState.maxThirst, gameState.thirst + 30);
                        addToLog("喝了一些水，口渴感减轻了", "success");
                        
                        // 有几率恢复少量健康
                        if (Math.random() < 0.3) {
                            gameState.health = Math.min(gameState.maxHealth, gameState.health + 5);
                            addToLog("干净的水让你感觉好一些了", "info");
                        }
                        
                        playSound('success');
                    }
                    break;
                    
                case 'use':
                    if (itemId === 'bandage') {
                        removeItem(itemId, 1);
                        gameState.health = Math.min(gameState.maxHealth, gameState.health + 20);
                        addToLog("使用了绷带，恢复了一些健康", "success");
                        playSound('success');
                    } else if (itemId === 'medicine') {
                        removeItem(itemId, 1);
                        gameState.health = Math.min(gameState.maxHealth, gameState.health + 30);
                        addToLog("使用了药膏，感觉好多了", "success");
                        playSound('success');
                    } else if (itemId === 'trap') {
                        if (gameState.currentAction) {
                            addToLog("你已经在进行一个行动了", "warning");
                            return;
                        }
                        
                        // 设置陷阱
                        gameState.currentAction = 'set_trap';
                        gameState.actionDifficulty = 3;
                        gameState.actionProgress = 0;
                        elements.actionProgressFill.style.width = '0%';
                        
                        addToLog("开始设置陷阱...", "info");
                        
                        // 设置陷阱计时器
                        gameState.actionInterval = setInterval(() => {
                            gameState.actionProgress++;
                            elements.actionProgressFill.style.width = `${(gameState.actionProgress / gameState.actionDifficulty) * 100}%`;
                            
                            // 消耗精力
                            gameState.energy = Math.max(0, gameState.energy - 0.5);
                            
                            // 陷阱设置完成
                            if (gameState.actionProgress >= gameState.actionDifficulty) {
                                clearInterval(gameState.actionInterval);
                                elements.actionProgressFill.style.width = '0%';
                                
                                removeItem(itemId, 1);
                                addToLog("陷阱设置完成，明天检查是否有收获", "success");
                                gameState.currentAction = null;
                                
                                // 增加陷阱技能经验
                                addSkillXP('hunting', 10);
                                
                                // 第二天有几率捕获动物
                                setTimeout(() => {
                                    if (Math.random() < 0.7) {
                                        const loot = Math.random() < 0.5 ? 
                                            { 'meat_raw': 1 } : { 'fur': 1 };
                                        
                                        const itemId = Object.keys(loot)[0];
                                        const amount = loot[itemId];
                                        addItem(itemId, amount);
                                        addToLog(`陷阱捕获了猎物! 获得了 ${amount} 个${items[itemId].name}`, "success");
                                    } else {
                                        addToLog("陷阱没有捕获任何猎物", "info");
                                    }
                                }, 30000); // 30秒后检查
                                
                                playSound('success');
                            }
                        }, 1000);
                    }
                    break;
                    
                case 'heal':
                    if (itemId === 'herbs') {
                        removeItem(itemId, 1);
                        gameState.health = Math.min(gameState.maxHealth, gameState.health + 10);
                        addToLog("使用了草药，感觉好一些了", "success");
                        playSound('success');
                    }
                    break;
                    
                case 'craft':
                    toggleCraftingList();
                    addToLog(`选择要使用${item.name}制作的物品`, "info");
                    break;
                    
                case 'burn':
                    if (itemId === 'wood' || itemId === 'coal') {
                        if (!gameState.fire) {
                            if (gameState.inventory['wood'] >= 3 && gameState.inventory['stone'] >= 2) {
                                startAction('fire');
                            } else {
                                addToLog("生火需要3个木材和2个石头", "warning");
                            }
                        } else {
                            addToLog("火已经燃着了", "info");
                        }
                    }
                    break;
                    
                case 'equip':
                    addToLog(`装备了${item.name}`, "success");
                    playSound('success');
                    break;
                    
                case 'cook':
                    if (itemId === 'meat_raw' && gameState.fire) {
                        if (gameState.currentAction) {
                            addToLog("你已经在进行一个行动了", "warning");
                            return;
                        }
                        
                        gameState.currentAction = 'cook';
                        gameState.cookingItem = itemId;
                        gameState.actionDifficulty = 3;
                        gameState.actionProgress = 0;
                        elements.actionProgressFill.style.width = '0%';
                        
                        addToLog("开始烹饪生肉...", "info");
                        
                        // 烹饪计时器
                        gameState.actionInterval = setInterval(() => {
                            gameState.actionProgress++;
                            elements.actionProgressFill.style.width = `${(gameState.actionProgress / gameState.actionDifficulty) * 100}%`;
                            
                            // 消耗精力
                            gameState.energy = Math.max(0, gameState.energy - 0.5);
                            
                            // 烹饪完成
                            if (gameState.actionProgress >= gameState.actionDifficulty) {
                                clearInterval(gameState.actionInterval);
                                elements.actionProgressFill.style.width = '0%';
                                
                                removeItem(itemId, 1);
                                addItem('meat_cooked', 1);
                                addToLog("成功烹饪了1个熟肉", "success");
                                gameState.currentAction = null;
                                
                                // 增加烹饪技能经验
                                addSkillXP('cooking', 10);
                                
                                playSound('success');
                            }
                        }, 1000);
                    } else if (!gameState.fire) {
                        addToLog("需要生火才能烹饪食物", "warning");
                    }
                    break;
                    
                case 'build':
                    toggleCraftingList();
                    addToLog("选择要建造的物品", "info");
                    break;
            }
        }
        
        // 显示地图
        function showMap() {
            renderMap();
            elements.mapPanel.style.display = 'flex';
            playSound('click');
        }
        
        // 隐藏地图
        function hideMap() {
            elements.mapPanel.style.display = 'none';
            playSound('click');
        }
        
        // 渲染地图
        function renderMap() {
            elements.mapContent.innerHTML = '';
            
            Object.entries(locations).forEach(([id, location]) => {
                const locationElement = document.createElement('div');
                locationElement.className = 'map-location';
                
                if (gameState.discoveredLocations.includes(id)) {
                    locationElement.classList.add('discovered');
                    
                    if (gameState.location === id) {
                        locationElement.classList.add('current');
                    }
                    
                    locationElement.innerHTML = `
                        <div class="map-location-image" style="background-image: url('${location.image}')"></div>
                        <div>${location.name}</div>
                    `;
                    
                    locationElement.addEventListener('click', () => {
                        if (gameState.location !== id) {
                            gameState.location = id;
                            updateLocationImage();
                            addToLog(`移动到了${location.name}`, "info");
                            hideMap();
                        }
                    });
                } else {
                    locationElement.innerHTML = `
                        <div class="map-location-image" style="background-color: #333;"></div>
                        <div>未探索区域</div>
                    `;
                }
                
                elements.mapContent.appendChild(locationElement);
            });
        }
        
        // 显示技能面板
        function showSkills() {
            renderSkills();
            elements.skillsPanel.style.display = 'flex';
            playSound('click');
        }
        
        // 隐藏技能面板
        function hideSkills() {
            elements.skillsPanel.style.display = 'none';
            playSound('click');
        }
        
        // 渲染技能
        function renderSkills() {
            for (const skill in gameState.skills) {
                const levelElement = document.getElementById(`${skill}-level`);
                const progressElement = document.getElementById(`${skill}-progress`);
                
                if (levelElement && progressElement) {
                    levelElement.textContent = gameState.skills[skill].level;
                    const progressPercent = (gameState.skills[skill].xp / gameState.skills[skill].xpToNext) * 100;
                    progressElement.style.width = `${progressPercent}%`;
                }
            }
        }
        
        // 增加技能经验
        function addSkillXP(skill, xp) {
            if (!gameState.skills[skill]) return;
            
            gameState.skills[skill].xp += xp;
            
            // 检查是否升级
            while (gameState.skills[skill].xp >= gameState.skills[skill].xpToNext) {
                gameState.skills[skill].xp -= gameState.skills[skill].xpToNext;
                gameState.skills[skill].level++;
                gameState.skills[skill].xpToNext = Math.floor(gameState.skills[skill].xpToNext * 1.2);
                
                addToLog(`${getSkillName(skill)}技能提升到${gameState.skills[skill].level}级!`, "success");
                showNotification(`${getSkillName(skill)}升级!`);
            }
            
            // 更新技能显示
            renderSkills();
        }
        
        // 获取技能名称
        function getSkillName(skill) {
            const names = {
                woodcutting: '木材采集',
                mining: '采矿',
                hunting: '狩猎',
                combat: '战斗',
                firemaking: '生火',
                cooking: '烹饪'
            };
            
            return names[skill] || skill;
        }
        
        // 显示任务面板
        function showQuests() {
            renderQuests();
            elements.questsPanel.style.display = 'flex';
            playSound('click');
        }
        
        // 隐藏任务面板
        function hideQuests() {
            elements.questsPanel.style.display = 'none';
            playSound('click');
        }
        
        // 渲染任务
        function renderQuests() {
            // 每日任务
            const dailyQuest1 = document.getElementById('daily-quest-1');
            if (dailyQuest1) {
                const quest = gameState.quests.daily.gatherWood;
                dailyQuest1.querySelector('.quest-progress').textContent = 
                    `${quest.progress}/${quest.target}`;
                
                if (quest.progress >= quest.target && !quest.completed) {
                    dailyQuest1.classList.add('success');
                }
            }
            
            const dailyQuest2 = document.getElementById('daily-quest-2');
            if (dailyQuest2) {
                const quest = gameState.quests.daily.huntAnimals;
                dailyQuest2.querySelector('.quest-progress').textContent = 
                    `${quest.progress}/${quest.target}`;
                
                if (quest.progress >= quest.target && !quest.completed) {
                    dailyQuest2.classList.add('success');
                }
            }
            
            // 主线任务
            const mainQuest1 = document.getElementById('main-quest-1');
            if (mainQuest1) {
                const quest = gameState.quests.main.buildShelter;
                mainQuest1.querySelector('.quest-progress').textContent = 
                    quest.completed ? '已完成' : '未完成';
                
                if (quest.completed) {
                    mainQuest1.classList.add('success');
                }
            }
        }
        
        // 检查任务完成情况
        function checkQuests() {
            // 每日任务 - 收集木材
            if (gameState.quests.daily.gatherWood && 
                !gameState.quests.daily.gatherWood.completed && 
                gameState.quests.daily.gatherWood.progress >= gameState.quests.daily.gatherWood.target) {
                
                gameState.quests.daily.gatherWood.completed = true;
                addItem('berries', 5);
                addToLog("完成了每日任务: 收集木材! 获得了5个浆果", "success");
                renderQuests();
            }
            
            // 每日任务 - 狩猎动物
            if (gameState.quests.daily.huntAnimals && 
                !gameState.quests.daily.huntAnimals.completed && 
                gameState.quests.daily.huntAnimals.progress >= gameState.quests.daily.huntAnimals.target) {
                
                gameState.quests.daily.huntAnimals.completed = true;
                addItem('leather', 2);
                addToLog("完成了每日任务: 狩猎动物! 获得了2个皮革", "success");
                renderQuests();
            }
        }
        
        // 重置每日任务
        function resetDailyQuests() {
            gameState.quests.daily.gatherWood = { target: 10, progress: 0, completed: false };
            gameState.quests.daily.huntAnimals = { target: 3, progress: 0, completed: false };
            renderQuests();
            addToLog("新的每日任务已刷新", "info");
        }
        
        // 显示基地面板
        function showBase() {
            if (!gameState.quests.main.buildShelter.completed) {
                addToLog("你需要先建造一个庇护所来解锁基地功能", "warning");
                return;
            }
            
            renderBase();
            elements.basePanel.style.display = 'flex';
            playSound('click');
        }
        
        // 隐藏基地面板
        function hideBase() {
            elements.basePanel.style.display = 'none';
            playSound('click');
        }
        
        // 渲染基地
        function renderBase() {
            document.getElementById('shelter-level').textContent = gameState.shelterLevel;
            document.getElementById('storage-level').textContent = gameState.storageLevel;
            document.getElementById('workbench-level').textContent = gameState.workbenchLevel;
            
            // 更新升级按钮状态
            const shelterBtn = document.getElementById('upgrade-shelter-btn');
            const storageBtn = document.getElementById('upgrade-storage-btn');
            const workbenchBtn = document.getElementById('upgrade-workbench-btn');
            
            shelterBtn.disabled = !(gameState.inventory['wood'] >= 20 && gameState.inventory['rope'] >= 5);
            storageBtn.disabled = !(gameState.inventory['wood'] >= 15 && gameState.inventory['iron_ore'] >= 5);
            workbenchBtn.disabled = !(gameState.inventory['wood'] >= 30 && gameState.inventory['iron_ore'] >= 10);
        }
        
        // 升级庇护所
        function upgradeShelter() {
            if (gameState.inventory['wood'] >= 20 && gameState.inventory['rope'] >= 5) {
                gameState.inventory['wood'] -= 20;
                gameState.inventory['rope'] -= 5;
                gameState.shelterLevel++;
                
                addToLog(`庇护所升级到${gameState.shelterLevel}级!`, "success");
                playSound('success');
                
                // 更新库存和基地显示
                renderInventory();
                renderBase();
            } else {
                addToLog("升级需要20个木材和5个绳子", "warning");
                playSound('failure');
            }
        }
        
        // 升级储物箱
        function upgradeStorage() {
            if (gameState.inventory['wood'] >= 15 && gameState.inventory['iron_ore'] >= 5) {
                gameState.inventory['wood'] -= 15;
                gameState.inventory['iron_ore'] -= 5;
                gameState.storageLevel++;
                gameState.inventoryMax += 5;
                
                addToLog(`储物箱升级到${gameState.storageLevel}级! 库存上限增加5`, "success");
                playSound('success');
                
                // 更新库存和基地显示
                renderInventory();
                renderBase();
            } else {
                addToLog("升级需要15个木材和5个铁矿石", "warning");
                playSound('failure');
            }
        }
        
        // 升级工作台
        function upgradeWorkbench() {
            if (gameState.inventory['wood'] >= 30 && gameState.inventory['iron_ore'] >= 10) {
                gameState.inventory['wood'] -= 30;
                gameState.inventory['iron_ore'] -= 10;
                gameState.workbenchLevel++;
                
                addToLog(`工作台升级到${gameState.workbenchLevel}级! 解锁更多制作配方`, "success");
                playSound('success');
                
                // 解锁新配方
                if (gameState.workbenchLevel === 1) {
                    gameState.unlockedRecipes.push('fishing_rod', 'trap');
                    addToLog("解锁新配方: 鱼竿, 陷阱", "info");
                } else if (gameState.workbenchLevel === 2) {
                    gameState.unlockedRecipes.push('bow', 'arrow');
                    addToLog("解锁新配方: 弓箭, 箭", "info");
                } else if (gameState.workbenchLevel === 3) {
                    gameState.unlockedRecipes.push('medicine', 'armor');
                    addToLog("解锁新配方: 药膏, 皮甲", "info");
                }
                
                // 更新库存和基地显示
                renderInventory();
                renderBase();
                renderCraftingList();
            } else {
                addToLog("升级需要30个木材和10个铁矿石", "warning");
                playSound('failure');
            }
        }
        
        // 显示通知
        function showNotification(message) {
            elements.notification.textContent = message;
            elements.notification.style.display = 'block';
            
            setTimeout(() => {
                elements.notification.style.display = 'none';
            }, 3000);
        }
        
        // 更新UI显示
        function updateUI() {
            elements.healthValue.textContent = Math.floor(gameState.health);
            elements.hungerValue.textContent = Math.floor(gameState.hunger);
            elements.thirstValue.textContent = Math.floor(gameState.thirst);
            elements.energyValue.textContent = Math.floor(gameState.energy);
            elements.tempValue.textContent = gameState.temperature.toFixed(1);
            elements.dayCount.textContent = gameState.day;
            
            // 更新危险状态颜色
            if (gameState.health < 30) elements.healthValue.className = 'stat-value danger';
            else if (gameState.health < 60) elements.healthValue.className = 'stat-value warning';
            else elements.healthValue.className = 'stat-value';
            
            if (gameState.hunger < 30) elements.hungerValue.className = 'stat-value danger';
            else if (gameState.hunger < 60) elements.hungerValue.className = 'stat-value warning';
            else elements.hungerValue.className = 'stat-value';
            
            if (gameState.thirst < 30) elements.thirstValue.className = 'stat-value danger';
            else if (gameState.thirst < 60) elements.thirstValue.className = 'stat-value warning';
            else elements.thirstValue.className = 'stat-value';
            
            if (gameState.energy < 30) elements.energyValue.className = 'stat-value danger';
            else if (gameState.energy < 60) elements.energyValue.className = 'stat-value warning';
            else elements.energyValue.className = 'stat-value';
            
            if (gameState.temperature < 35 || gameState.temperature > 39) elements.tempValue.className = 'stat-value danger';
            else if (gameState.temperature < 36 || gameState.temperature > 38) elements.tempValue.className = 'stat-value warning';
            else elements.tempValue.className = 'stat-value';
            
            // 更新按钮状态
            elements.gatherBtn.disabled = gameState.currentAction !== null || gameState.inCombat;
            elements.huntBtn.disabled = gameState.currentAction !== null || gameState.inCombat;
            elements.exploreBtn.disabled = gameState.currentAction !== null || gameState.inCombat;
            elements.restBtn.disabled = gameState.currentAction !== null || gameState.inCombat;
            elements.drinkBtn.disabled = gameState.currentAction !== null || gameState.inCombat || gameState.inventory['water'] <= 0;
            elements.eatBtn.disabled = gameState.currentAction !== null || gameState.inCombat || 
                                      (gameState.inventory['berries'] <= 0 && 
                                       gameState.inventory['meat_cooked'] <= 0 && 
                                       gameState.inventory['meat_raw'] <= 0);
            elements.buildBtn.disabled = gameState.currentAction !== null || gameState.inCombat;
            elements.fireBtn.disabled = gameState.currentAction !== null || gameState.inCombat || gameState.fire;
            elements.mapBtn.disabled = gameState.currentAction !== null || gameState.inCombat;
            elements.skillsBtn.disabled = gameState.currentAction !== null || gameState.inCombat;
            elements.questsBtn.disabled = gameState.currentAction !== null || gameState.inCombat;
            elements.baseBtn.disabled = gameState.currentAction !== null || gameState.inCombat;
            
            // 更新制作按钮状态
            elements.craftingBtn.disabled = gameState.currentAction !== null || gameState.inCombat;
        }
        
        // 更新时间显示
        function updateTimeDisplay() {
            const hourStr = gameState.hour.toString().padStart(2, '0');
            const minuteStr = gameState.minute.toString().padStart(2, '0');
            elements.hourDisplay.textContent = `${hourStr}:${minuteStr}`;
            
            let timeOfDay = '';
            if (gameState.hour >= 5 && gameState.hour < 8) {
                timeOfDay = '清晨';
            } else if (gameState.hour >= 8 && gameState.hour < 12) {
                timeOfDay = '上午';
            } else if (gameState.hour >= 12 && gameState.hour < 14) {
                timeOfDay = '中午';
            } else if (gameState.hour >= 14 && gameState.hour < 18) {
                timeOfDay = '下午';
            } else if (gameState.hour >= 18 && gameState.hour < 20) {
                timeOfDay = '傍晚';
            } else if (gameState.hour >= 20 || gameState.hour < 5) {
                timeOfDay = '夜晚';
            }
            
            elements.timeText.textContent = timeOfDay;
            
            // 更新背景颜色
            if (gameState.isDay) {
                document.body.classList.remove('night-mode');
            } else {
                document.body.classList.add('night-mode');
            }
        }
        
        // 更新地点图片
        function updateLocationImage() {
            const location = locations[gameState.location];
            elements.locationImage.style.backgroundImage = `url('${location.image}')`;
            
            // 应用天气效果
            updateWeather();
        }
        
        // 添加日志条目
        function addToLog(text, type = 'info') {
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${getTimeString()}] ${text}`;
            elements.eventLog.appendChild(entry);
            elements.eventLog.scrollTop = elements.eventLog.scrollHeight;
        }
        
        // 获取时间字符串
        function getTimeString() {
            const hourStr = gameState.hour.toString().padStart(2, '0');
            const minuteStr = gameState.minute.toString().padStart(2, '0');
            return `${hourStr}:${minuteStr}`;
        }
        
        // 播放音效
        function playSound(type) {
            if (!gameState.soundEnabled) return;
            
            try {
                switch (type) {
                    case 'click':
                        elements.clickSound.currentTime = 0;
                        elements.clickSound.play();
                        break;
                    case 'success':
                        elements.successSound.currentTime = 0;
                        elements.successSound.play();
                        break;
                    case 'failure':
                        elements.failureSound.currentTime = 0;
                        elements.failureSound.play();
                        break;
                    case 'danger':
                        elements.dangerSound.currentTime = 0;
                        elements.dangerSound.play();
                        break;
                    case 'combat':
                        elements.combatSound.currentTime = 0;
                        elements.combatSound.play();
                        break;
                }
            } catch (e) {
                console.log("音效播放错误:", e);
            }
        }
        
        // 切换音乐
        function toggleMusic() {
            gameState.musicEnabled = !gameState.musicEnabled;
            
            if (gameState.musicEnabled) {
                updateBackgroundMusic();
                elements.musicBtn.textContent = '🎵';
            } else {
                if (gameState.currentMusic) {
                    fadeOutAudio(gameState.currentMusic);
                }
                elements.musicBtn.textContent = '🔇';
            }
            
            playSound('click');
        }
        
        // 切换音效
        function toggleSound() {
            gameState.soundEnabled = !gameState.soundEnabled;
            
            if (gameState.soundEnabled) {
                elements.natureSound.play().catch(e => console.log("自然音效播放被阻止:", e));
                elements.soundBtn.textContent = '🔊';
            } else {
                elements.natureSound.pause();
                elements.soundBtn.textContent = '🔇';
            }
            
            playSound('click');
        }
        
        // 切换夜间模式
        function toggleNightMode() {
            gameState.nightMode = !gameState.nightMode;
            
            if (gameState.nightMode) {
                document.body.classList.add('night-mode');
                elements.nightBtn.textContent = '☀️';
            } else {
                document.body.classList.remove('night-mode');
                elements.nightBtn.textContent = '🌙';
            }
            
            playSound('click');
        }
        
        // 保存游戏
        function saveGame() {
            try {
                localStorage.setItem('survivalGameSave', JSON.stringify(gameState));
                return true;
            } catch (e) {
                console.log("保存失败:", e);
                return false;
            }
        }
        
        // 加载游戏
        function loadGame() {
            try {
                const saveData = localStorage.getItem('survivalGameSave');
                if (saveData) {
                    const savedState = JSON.parse(saveData);
                    
                    // 保留音频设置
                    const musicEnabled = gameState.musicEnabled;
                    const soundEnabled = gameState.soundEnabled;
                    const nightMode = gameState.nightMode;
                    
                    // 合并状态
                    Object.assign(gameState, savedState);
                    
                    // 恢复设置
                    gameState.musicEnabled = musicEnabled;
                    gameState.soundEnabled = soundEnabled;
                    gameState.nightMode = nightMode;
                    
                    // 更新UI
                    updateUI();
                    renderInventory();
                    updateTimeDisplay();
                    updateLocationImage();
                    updateWeather();
                    renderMap();
                    renderSkills();
                    renderQuests();
                    renderBase();
                    
                    // 更新音乐
                    updateBackgroundMusic();
                    
                    return true;
                }
            } catch (e) {
                console.log("加载失败:", e);
            }
            
            return false;
        }
        
        // 启动游戏
        window.onload = initGame;
    </script>
</body>
</html>
