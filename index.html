<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è’é‡æ±‚ç”Ÿï¼šæ˜Ÿçƒæ¸¸æˆ</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Arial', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            background-color: #111;
            color: #eee;
            overflow-x: hidden;
            touch-action: manipulation;
            user-select: none;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        #game-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 10px;
            max-width: 600px;
            margin: 0 auto;
            width: 100%;
        }
        
        #header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            border-bottom: 1px solid #333;
            padding-bottom: 5px;
        }
        
        #stats {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 10px;
        }
        
        .stat {
            background-color: #222;
            padding: 5px 8px;
            border-radius: 4px;
            font-size: 14px;
            min-width: 80px;
            text-align: center;
        }
        
        .stat-value {
            font-weight: bold;
            color: #fff;
        }
        
        .health { color: #ff5555; }
        .hunger { color: #ffaa44; }
        .thirst { color: #44aaff; }
        .energy { color: #aaff44; }
        .temperature { color: #ff44aa; }
        
        #game-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: #1a1a1a;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            position: relative;
            overflow: hidden;
        }
        
        #location-image {
            width: 100%;
            height: 150px;
            background-size: cover;
            background-position: center;
            margin-bottom: 10px;
            border-radius: 4px;
            border: 2px solid #333;
        }
        
        #time-display {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 14px;
        }
        
        #day-display {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 14px;
        }
        
        #weather-display {
            position: absolute;
            top: 40px;
            left: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 14px;
        }
        
        #event-log {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 10px;
            padding: 8px;
            background-color: #222;
            border-radius: 4px;
            font-size: 14px;
            line-height: 1.4;
            max-height: 150px;
            border: 1px solid #333;
        }
        
        .log-entry {
            margin-bottom: 5px;
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        #actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-bottom: 10px;
        }
        
        .action-btn {
            background-color: #333;
            color: #fff;
            border: none;
            padding: 10px;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }
        
        .action-btn:active {
            transform: scale(0.95);
            background-color: #444;
        }
        
        .action-btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 5px;
            height: 5px;
            background: rgba(255, 255, 255, 0.5);
            opacity: 0;
            border-radius: 100%;
            transform: scale(1, 1) translate(-50%, -50%);
            transform-origin: 50% 50%;
        }
        
        .action-btn:active::after {
            animation: ripple 0.6s ease-out;
        }
        
        @keyframes ripple {
            0% {
                transform: scale(0, 0);
                opacity: 0.5;
            }
            100% {
                transform: scale(20, 20);
                opacity: 0;
            }
        }
        
        #inventory-title {
            margin-bottom: 5px;
            font-size: 14px;
        }
        
        #inventory {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 10px;
            min-height: 40px;
        }
        
        .item {
            background-color: #333;
            padding: 5px 8px;
            border-radius: 4px;
            font-size: 14px;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .item:hover {
            background-color: #444;
        }
        
        .item-count {
            margin-left: 5px;
            font-weight: bold;
            color: #fff;
        }
        
        #crafting {
            margin-top: 10px;
        }
        
        #crafting-btn {
            background-color: #444;
            color: #fff;
            border: none;
            padding: 8px;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            width: 100%;
            margin-bottom: 5px;
        }
        
        #crafting-list {
            display: none;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 5px;
        }
        
        .craft-item {
            background-color: #3a3a3a;
            padding: 8px;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .craft-item:hover {
            background-color: #444;
        }
        
        .progress-bar {
            height: 5px;
            background-color: #333;
            border-radius: 2px;
            margin-top: 5px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background-color: #4CAF50;
            width: 0%;
            transition: width 0.3s;
        }
        
        #settings {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
        }
        
        .settings-btn {
            background-color: transparent;
            color: #aaa;
            border: none;
            padding: 5px;
            font-size: 20px;
            cursor: pointer;
        }
        
        .danger {
            color: #ff5555;
        }
        
        .warning {
            color: #ffaa44;
        }
        
        .success {
            color: #44ff44;
        }
        
        .info {
            color: #44aaff;
        }
        
        .rare {
            color: #aa44ff;
        }
        
        /* å¤œé—´æ¨¡å¼ */
        .night-mode {
            background-color: #0a0a1a;
            color: #ccc;
        }
        
        .night-mode #game-area {
            background-color: #0a0a0a;
        }
        
        .night-mode .stat,
        .night-mode #event-log {
            background-color: #111;
        }
        
        /* åŠ è½½åŠ¨ç”» */
        .loader {
            border: 4px solid #333;
            border-top: 4px solid #4CAF50;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 400px) {
            .stat {
                min-width: 70px;
                font-size: 12px;
            }
            
            .action-btn {
                padding: 8px 5px;
                font-size: 12px;
            }
        }

        /* éŸ³ä¹æ§åˆ¶é¢æ¿ */
        .music-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }
        
        .music-btn {
            background-color: #333;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        /* ç‰©å“ä½¿ç”¨èœå• */
        .item-menu {
            position: fixed;
            background-color: #333;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            z-index: 100;
            display: none;
        }
        
        .item-menu button {
            display: block;
            width: 100%;
            padding: 8px 12px;
            background: none;
            border: none;
            color: white;
            text-align: left;
            cursor: pointer;
        }
        
        .item-menu button:hover {
            background-color: #444;
        }
        
        /* å·¥å…·æç¤º */
        .tooltip {
            position: absolute;
            background-color: rgba(0,0,0,0.8);
            color: white;
            padding: 5px 8px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 100;
            pointer-events: none;
            display: none;
        }
        
        /* åœ°å›¾é¢æ¿ */
        #map-panel {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            z-index: 200;
            display: none;
            flex-direction: column;
            padding: 20px;
            overflow-y: auto;
        }
        
        #map-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        
        #map-close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
        }
        
        #map-content {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            flex: 1;
        }
        
        .map-location {
            background-color: #222;
            border-radius: 5px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .map-location:hover {
            background-color: #333;
        }
        
        .map-location.discovered {
            background-color: #2a4a2a;
        }
        
        .map-location.current {
            outline: 2px solid gold;
        }
        
        .map-location-image {
            width: 100%;
            height: 80px;
            background-size: cover;
            background-position: center;
            margin-bottom: 5px;
            border-radius: 3px;
        }
        
        /* æŠ€èƒ½é¢æ¿ */
        #skills-panel {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            z-index: 200;
            display: none;
            flex-direction: column;
            padding: 20px;
            overflow-y: auto;
        }
        
        #skills-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        
        #skills-close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
        }
        
        .skill-category {
            margin-bottom: 20px;
        }
        
        .skill-item {
            background-color: #222;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
        }
        
        .skill-progress {
            height: 5px;
            background-color: #333;
            border-radius: 2px;
            margin-top: 5px;
            overflow: hidden;
        }
        
        .skill-progress-fill {
            height: 100%;
            background-color: #4CAF50;
            width: 0%;
        }
        
        /* ä»»åŠ¡é¢æ¿ */
        #quests-panel {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            z-index: 200;
            display: none;
            flex-direction: column;
            padding: 20px;
            overflow-y: auto;
        }
        
        #quests-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        
        #quests-close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
        }
        
        .quest-item {
            background-color: #222;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        
        .quest-reward {
            color: #ffaa44;
            margin-top: 5px;
        }
        
        /* åŸºåœ°é¢æ¿ */
        #base-panel {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            z-index: 200;
            display: none;
            flex-direction: column;
            padding: 20px;
            overflow-y: auto;
        }
        
        #base-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        
        #base-close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
        }
        
        .base-upgrade {
            background-color: #222;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        
        .base-upgrade-btn {
            background-color: #444;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            margin-top: 5px;
            cursor: pointer;
        }
        
        /* æˆ˜æ–—é¢æ¿ */
        #combat-panel {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            z-index: 200;
            display: none;
            flex-direction: column;
            padding: 20px;
            align-items: center;
            justify-content: center;
        }
        
        .enemy-health {
            width: 100%;
            height: 20px;
            background-color: #333;
            border-radius: 10px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .enemy-health-fill {
            height: 100%;
            background-color: #ff5555;
            width: 100%;
        }
        
        .combat-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            width: 100%;
            max-width: 300px;
        }
        
        .combat-btn {
            background-color: #444;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
        }
        
        /* é€šçŸ¥ */
        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0,0,0,0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 300;
            display: none;
            animation: fadeInOut 3s;
        }
        
        @keyframes fadeInOut {
            0% { opacity: 0; top: 10px; }
            10% { opacity: 1; top: 20px; }
            90% { opacity: 1; top: 20px; }
            100% { opacity: 0; top: 10px; }
        }
    </style>
</head>
<body>
    <div id="game-container">
        <div id="header">
            <h1>è’é‡æ±‚ç”Ÿï¼šæ˜Ÿçƒæ¸¸æˆ</h1>
            <div id="difficulty">éš¾åº¦: åœ°ç‹±</div>
        </div>
        
        <div id="stats">
            <div class="stat"><span class="health">å¥åº·</span>: <span id="health-value" class="stat-value">100</span>/100</div>
            <div class="stat"><span class="hunger">é¥¥é¥¿</span>: <span id="hunger-value" class="stat-value">80</span>/100</div>
            <div class="stat"><span class="thirst">å£æ¸´</span>: <span id="thirst-value" class="stat-value">75</span>/100</div>
            <div class="stat"><span class="energy">ç²¾åŠ›</span>: <span id="energy-value" class="stat-value">90</span>/100</div>
            <div class="stat"><span class="temperature">ä½“æ¸©</span>: <span id="temp-value" class="stat-value">36.5</span>Â°C</div>
        </div>
        
        <div id="game-area">
            <div id="day-display">ç¬¬ <span id="day-count">1</span> å¤©</div>
            <div id="time-display"><span id="time-text">æ¸…æ™¨</span> <span id="hour-display">06:00</span></div>
            <div id="weather-display"><span id="weather-text">æ™´å¤©</span></div>
            <div id="location-image"></div>
            
            <div id="event-log"></div>
            
            <div id="actions">
                <button class="action-btn" id="gather-btn">é‡‡é›†èµ„æº</button>
                <button class="action-btn" id="hunt-btn">ç‹©çŒ</button>
                <button class="action-btn" id="explore-btn">æ¢ç´¢</button>
                <button class="action-btn" id="rest-btn">ä¼‘æ¯</button>
                <button class="action-btn" id="drink-btn">å–æ°´</button>
                <button class="action-btn" id="eat-btn">è¿›é£Ÿ</button>
                <button class="action-btn" id="build-btn">å»ºé€ </button>
                <button class="action-btn" id="fire-btn">ç”Ÿç«</button>
                <button class="action-btn" id="map-btn">åœ°å›¾</button>
                <button class="action-btn" id="skills-btn">æŠ€èƒ½</button>
                <button class="action-btn" id="quests-btn">ä»»åŠ¡</button>
                <button class="action-btn" id="base-btn">åŸºåœ°</button>
            </div>
            
            <div class="progress-bar" id="action-progress">
                <div class="progress-fill" id="action-progress-fill"></div>
            </div>
        </div>
        
        <div id="inventory-title">ç‰©å“æ  (<span id="inventory-count">0</span>/<span id="inventory-max">10</span>)</div>
        <div id="inventory"></div>
        
        <div id="crafting">
            <button id="crafting-btn">åˆ¶ä½œç‰©å“ â–¼</button>
            <div id="crafting-list"></div>
        </div>
        
        <div id="settings">
            <button class="settings-btn" id="music-btn">ğŸµ</button>
            <button class="settings-btn" id="sound-btn">ğŸ”Š</button>
            <button class="settings-btn" id="save-btn">ğŸ’¾</button>
            <button class="settings-btn" id="load-btn">ğŸ“‚</button>
            <button class="settings-btn" id="night-btn">ğŸŒ™</button>
        </div>

        <!-- éŸ³ä¹æ§åˆ¶é¢æ¿ -->
        <div class="music-controls">
            <button class="music-btn" id="day-music-btn">ç™½å¤©éŸ³ä¹</button>
            <button class="music-btn" id="night-music-btn">å¤œæ™šéŸ³ä¹</button>
            <button class="music-btn" id="rain-music-btn">é›¨å¤©éŸ³ä¹</button>
        </div>
    </div>
    
    <!-- èƒŒæ™¯éŸ³ä¹ -->
    <audio id="day-music" loop>
        <source src="https://assets.mixkit.co/music/preview/mixkit-forest-trek-169.mp3" type="audio/mpeg">
    </audio>
    
    <audio id="night-music" loop>
        <source src="https://assets.mixkit.co/music/preview/mixkit-dark-ambient-1126.mp3" type="audio/mpeg">
    </audio>
    
    <audio id="rain-music" loop>
        <source src="https://assets.mixkit.co/music/preview/mixkit-rainy-day-1180.mp3" type="audio/mpeg">
    </audio>
    
    <!-- éŸ³æ•ˆ -->
    <audio id="click-sound">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-arcade-game-jump-coin-216.mp3" type="audio/mpeg">
    </audio>
    
    <audio id="success-sound">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-achievement-bell-600.mp3" type="audio/mpeg">
    </audio>
    
    <audio id="failure-sound">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-retro-arcade-lose-2027.mp3" type="audio/mpeg">
    </audio>
    
    <audio id="danger-sound">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-unfair-game-penalty-2080.mp3" type="audio/mpeg">
    </audio>
    
    <audio id="nature-sound">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-nature-ambient-forest-1258.mp3" type="audio/mpeg">
    </audio>
    
    <audio id="combat-sound">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-sword-attack-1680.mp3" type="audio/mpeg">
    </audio>
    
    <!-- ç‰©å“ä½¿ç”¨èœå• -->
    <div id="item-menu" class="item-menu"></div>
    
    <!-- å·¥å…·æç¤º -->
    <div id="tooltip" class="tooltip"></div>
    
    <!-- åœ°å›¾é¢æ¿ -->
    <div id="map-panel">
        <div id="map-header">
            <h2>è’é‡åœ°å›¾</h2>
            <button id="map-close">Ã—</button>
        </div>
        <div id="map-content"></div>
    </div>
    
    <!-- æŠ€èƒ½é¢æ¿ -->
    <div id="skills-panel">
        <div id="skills-header">
            <h2>ç”Ÿå­˜æŠ€èƒ½</h2>
            <button id="skills-close">Ã—</button>
        </div>
        <div class="skill-category">
            <h3>é‡‡é›†æŠ€èƒ½</h3>
            <div class="skill-item">
                <span>æœ¨æé‡‡é›†</span>
                <span id="woodcutting-level">1</span>
                <div class="skill-progress">
                    <div class="skill-progress-fill" id="woodcutting-progress"></div>
                </div>
            </div>
            <div class="skill-item">
                <span>é‡‡çŸ¿</span>
                <span id="mining-level">1</span>
                <div class="skill-progress">
                    <div class="skill-progress-fill" id="mining-progress"></div>
                </div>
            </div>
        </div>
        <div class="skill-category">
            <h3>æˆ˜æ–—æŠ€èƒ½</h3>
            <div class="skill-item">
                <span>ç‹©çŒ</span>
                <span id="hunting-level">1</span>
                <div class="skill-progress">
                    <div class="skill-progress-fill" id="hunting-progress"></div>
                </div>
            </div>
            <div class="skill-item">
                <span>æˆ˜æ–—</span>
                <span id="combat-level">1</span>
                <div class="skill-progress">
                    <div class="skill-progress-fill" id="combat-progress"></div>
                </div>
            </div>
        </div>
        <div class="skill-category">
            <h3>ç”Ÿå­˜æŠ€èƒ½</h3>
            <div class="skill-item">
                <span>ç”Ÿç«</span>
                <span id="firemaking-level">1</span>
                <div class="skill-progress">
                    <div class="skill-progress-fill" id="firemaking-progress"></div>
                </div>
            </div>
            <div class="skill-item">
                <span>çƒ¹é¥ª</span>
                <span id="cooking-level">1</span>
                <div class="skill-progress">
                    <div class="skill-progress-fill" id="cooking-progress"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ä»»åŠ¡é¢æ¿ -->
    <div id="quests-panel">
        <div id="quests-header">
            <h2>ä»»åŠ¡æ—¥å¿—</h2>
            <button id="quests-close">Ã—</button>
        </div>
        <div id="daily-quests">
            <h3>æ¯æ—¥ä»»åŠ¡</h3>
            <div class="quest-item" id="daily-quest-1">
                <div class="quest-title">æ”¶é›†10ä¸ªæœ¨æ</div>
                <div class="quest-progress">0/10</div>
                <div class="quest-reward">å¥–åŠ±: 5é£Ÿç‰©</div>
            </div>
            <div class="quest-item" id="daily-quest-2">
                <div class="quest-title">ç‹©çŒ3åªåŠ¨ç‰©</div>
                <div class="quest-progress">0/3</div>
                <div class="quest-reward">å¥–åŠ±: çš®é©x2</div>
            </div>
        </div>
        <div id="main-quests">
            <h3>ä¸»çº¿ä»»åŠ¡</h3>
            <div class="quest-item" id="main-quest-1">
                <div class="quest-title">å»ºé€ ä¸€ä¸ªåº‡æŠ¤æ‰€</div>
                <div class="quest-progress">æœªå®Œæˆ</div>
                <div class="quest-reward">å¥–åŠ±: è§£é”åŸºåœ°åŠŸèƒ½</div>
            </div>
        </div>
    </div>
    
    <!-- åŸºåœ°é¢æ¿ -->
    <div id="base-panel">
        <div id="base-header">
            <h2>ç”Ÿå­˜åŸºåœ°</h2>
            <button id="base-close">Ã—</button>
        </div>
        <div class="base-upgrade">
            <h3>ç®€æ˜“åº‡æŠ¤æ‰€</h3>
            <p>æä¾›åŸºæœ¬çš„ä¿æŠ¤å’Œä¼‘æ¯</p>
            <div>ç­‰çº§: <span id="shelter-level">0</span></div>
            <button class="base-upgrade-btn" id="upgrade-shelter-btn">å‡çº§ (éœ€è¦æœ¨æx20, ç»³å­x5)</button>
        </div>
        <div class="base-upgrade">
            <h3>å‚¨ç‰©ç®±</h3>
            <p>å¢åŠ ç‰©å“å­˜å‚¨ç©ºé—´</p>
            <div>ç­‰çº§: <span id="storage-level">0</span></div>
            <button class="base-upgrade-btn" id="upgrade-storage-btn">å‡çº§ (éœ€è¦æœ¨æx15, é“çŸ¿çŸ³x5)</button>
        </div>
        <div class="base-upgrade">
            <h3>å·¥ä½œå°</h3>
            <p>è§£é”é«˜çº§åˆ¶ä½œé…æ–¹</p>
            <div>ç­‰çº§: <span id="workbench-level">0</span></div>
            <button class="base-upgrade-btn" id="upgrade-workbench-btn">å‡çº§ (éœ€è¦æœ¨æx30, é“çŸ¿çŸ³x10)</button>
        </div>
    </div>
    
    <!-- æˆ˜æ–—é¢æ¿ -->
    <div id="combat-panel">
        <h2 id="enemy-name">é‡ç‹¼</h2>
        <div class="enemy-health">
            <div class="enemy-health-fill" id="enemy-health-fill"></div>
        </div>
        <p id="combat-message">ä¸€åªé‡ç‹¼å‘ä½ æ‰‘æ¥!</p>
        <div class="combat-actions">
            <button class="combat-btn" id="attack-btn">æ”»å‡»</button>
            <button class="combat-btn" id="defend-btn">é˜²å¾¡</button>
            <button class="combat-btn" id="use-item-btn">ä½¿ç”¨ç‰©å“</button>
            <button class="combat-btn" id="flee-btn">é€ƒè·‘</button>
        </div>
    </div>
    
    <!-- é€šçŸ¥ -->
    <div class="notification" id="notification"></div>

    <script>
        // æ¸¸æˆçŠ¶æ€
        const gameState = {
            // ç©å®¶å±æ€§
            health: 100,
            maxHealth: 100,
            hunger: 80,
            maxHunger: 100,
            thirst: 75,
            maxThirst: 100,
            energy: 90,
            maxEnergy: 100,
            temperature: 36.5,
            
            // æ¸¸æˆæ—¶é—´
            day: 1,
            hour: 6,
            minute: 0,
            isDay: true,
            weather: 'sunny', // sunny, rainy, stormy, foggy, snowy
            weatherDuration: 0,
            
            // ç‰©å“æ 
            inventory: {},
            inventoryMax: 10,
            
            // æ¸¸æˆè¿›åº¦
            location: 'forest',
            discoveredLocations: ['forest'],
            shelterLevel: 0,
            storageLevel: 0,
            workbenchLevel: 0,
            fire: false,
            fireDuration: 0,
            
            // æŠ€èƒ½
            skills: {
                woodcutting: { level: 1, xp: 0, xpToNext: 100 },
                mining: { level: 1, xp: 0, xpToNext: 100 },
                hunting: { level: 1, xp: 0, xpToNext: 100 },
                combat: { level: 1, xp: 0, xpToNext: 100 },
                firemaking: { level: 1, xp: 0, xpToNext: 100 },
                cooking: { level: 1, xp: 0, xpToNext: 100 }
            },
            
            // ä»»åŠ¡
            quests: {
                daily: {
                    gatherWood: { target: 10, progress: 0, completed: false },
                    huntAnimals: { target: 3, progress: 0, completed: false }
                },
                main: {
                    buildShelter: { completed: false }
                }
            },
            
            // æˆ˜æ–—çŠ¶æ€
            inCombat: false,
            enemy: null,
            
            // è®¾ç½®
            musicEnabled: true,
            soundEnabled: true,
            nightMode: false,
            currentMusic: null,
            
            // å…¶ä»–çŠ¶æ€
            currentAction: null,
            actionProgress: 0,
            actionInterval: null,
            actionDifficulty: 0,
            
            // è§£é”ç³»ç»Ÿ
            unlockedRecipes: ['bandage', 'spear', 'rope', 'fire', 'shelter', 'cooked_meat'],
            discoveredItems: ['wood', 'stone', 'herbs', 'berries', 'meat_raw'],
            
            // ç»Ÿè®¡æ•°æ®
            stats: {
                itemsGathered: 0,
                animalsHunted: 0,
                locationsExplored: 0,
                daysSurvived: 0,
                itemsCrafted: 0,
                enemiesDefeated: 0
            }
        };
        
        // ç‰©å“æ•°æ®
        const items = {
            wood: { 
                name: 'æœ¨æ', 
                emoji: 'ğŸªµ', 
                weight: 1,
                description: 'å¯ç”¨äºç”Ÿç«æˆ–å»ºé€ ',
                actions: ['burn', 'build'],
                durability: null
            },
            stone: { 
                name: 'çŸ³å¤´', 
                emoji: 'ğŸª¨', 
                weight: 1,
                description: 'å¯ç”¨äºåˆ¶ä½œå·¥å…·',
                actions: ['craft'],
                durability: null
            },
            herbs: { 
                name: 'è‰è¯', 
                emoji: 'ğŸŒ¿', 
                weight: 0.5,
                description: 'å¯ç”¨äºåˆ¶ä½œç»·å¸¦æˆ–æ²»ç–—',
                actions: ['heal', 'craft'],
                durability: null
            },
            berries: { 
                name: 'æµ†æœ', 
                emoji: 'ğŸ’', 
                weight: 0.3,
                description: 'å¯é£Ÿç”¨ï¼Œä½†å¯èƒ½æœ‰æ¯’',
                actions: ['eat'],
                durability: null
            },
            meat_raw: { 
                name: 'ç”Ÿè‚‰', 
                emoji: 'ğŸ¥©', 
                weight: 1,
                description: 'å¯é£Ÿç”¨æˆ–çƒ¹é¥ªï¼Œç”Ÿåƒå¯èƒ½ä¸­æ¯’',
                actions: ['eat', 'cook'],
                durability: null
            },
            meat_cooked: { 
                name: 'ç†Ÿè‚‰', 
                emoji: 'ğŸ–', 
                weight: 1,
                description: 'è¥å…»ä¸°å¯Œçš„é£Ÿç‰©',
                actions: ['eat'],
                durability: null
            },
            water: { 
                name: 'æ°´', 
                emoji: 'ğŸ’§', 
                weight: 0.5,
                description: 'è§£æ¸´çš„å¿…éœ€å“',
                actions: ['drink'],
                durability: null
            },
            fur: { 
                name: 'æ¯›çš®', 
                emoji: 'ğŸ¾', 
                weight: 0.8,
                description: 'å¯ç”¨äºåˆ¶ä½œè¡£ç‰©æˆ–åº‡æŠ¤æ‰€',
                actions: ['craft'],
                durability: null
            },
            bone: { 
                name: 'éª¨å¤´', 
                emoji: 'ğŸ¦´', 
                weight: 0.5,
                description: 'å¯ç”¨äºåˆ¶ä½œå·¥å…·',
                actions: ['craft'],
                durability: null
            },
            bandage: { 
                name: 'ç»·å¸¦', 
                emoji: 'ğŸ©¹', 
                weight: 0.3,
                description: 'æ¢å¤å¥åº·',
                actions: ['use'],
                durability: null
            },
            spear: { 
                name: 'é•¿çŸ›', 
                emoji: 'ğŸ”±', 
                weight: 2,
                description: 'æé«˜ç‹©çŒæˆåŠŸç‡å’Œé˜²å¾¡èƒ½åŠ›',
                actions: ['equip'],
                durability: 50
            },
            rope: { 
                name: 'ç»³å­', 
                emoji: 'ğŸ§µ', 
                weight: 1,
                description: 'å¯ç”¨äºå»ºé€ æˆ–åˆ¶ä½œ',
                actions: ['craft'],
                durability: null
            },
            leather: { 
                name: 'çš®é©', 
                emoji: 'ğŸ§¥', 
                weight: 1,
                description: 'å¯ç”¨äºåˆ¶ä½œè¡£ç‰©',
                actions: ['craft'],
                durability: null
            },
            iron_ore: { 
                name: 'é“çŸ¿çŸ³', 
                emoji: 'â›ï¸', 
                weight: 2,
                description: 'å¯ç”¨äºåˆ¶ä½œå·¥å…·',
                actions: ['craft'],
                durability: null
            },
            coal: { 
                name: 'ç…¤ç‚­', 
                emoji: 'ğŸª¨', 
                weight: 1,
                description: 'ä¼˜è´¨çš„ç‡ƒæ–™',
                actions: ['burn'],
                durability: null
            },
            fish: { 
                name: 'é±¼', 
                emoji: 'ğŸŸ', 
                weight: 0.8,
                description: 'å¯é£Ÿç”¨æˆ–çƒ¹é¥ª',
                actions: ['eat', 'cook'],
                durability: null
            },
            fishing_rod: { 
                name: 'é±¼ç«¿', 
                emoji: 'ğŸ£', 
                weight: 2,
                description: 'å¯ä»¥åœ¨æ°´åŸŸé’“é±¼',
                actions: ['equip'],
                durability: 30
            },
            trap: { 
                name: 'é™·é˜±', 
                emoji: 'ğŸ•³ï¸', 
                weight: 3,
                description: 'å¯ä»¥æ•æ‰å°å‹åŠ¨ç‰©',
                actions: ['use'],
                durability: 10
            },
            bow: { 
                name: 'å¼“ç®­', 
                emoji: 'ğŸ¹', 
                weight: 2,
                description: 'è¿œç¨‹æ­¦å™¨ï¼Œæé«˜ç‹©çŒæˆåŠŸç‡',
                actions: ['equip'],
                durability: 40
            },
            arrow: { 
                name: 'ç®­', 
                emoji: 'â¹', 
                weight: 0.2,
                description: 'å¼“ç®­çš„å¼¹è¯',
                actions: ['craft'],
                durability: null
            },
            medicine: { 
                name: 'è¯è†', 
                emoji: 'ğŸ’Š', 
                weight: 0.3,
                description: 'æ²»ç–—ä¼¤å£å’Œç–¾ç—…',
                actions: ['use'],
                durability: null
            },
            armor: { 
                name: 'çš®ç”²', 
                emoji: 'ğŸ›¡ï¸', 
                weight: 3,
                description: 'æä¾›é˜²å¾¡ä¿æŠ¤',
                actions: ['equip'],
                durability: 60
            }
        };
        
        // åˆ¶ä½œé…æ–¹
        const recipes = {
            bandage: {
                name: 'ç»·å¸¦',
                ingredients: { herbs: 3 },
                time: 2,
                skill: 'survival',
                unlockLevel: 1,
                description: 'ç”¨äºæ²»ç–—ä¼¤å£'
            },
            spear: {
                name: 'é•¿çŸ›',
                ingredients: { wood: 2, stone: 1, rope: 1 },
                time: 10,
                skill: 'crafting',
                unlockLevel: 2,
                description: 'æé«˜ç‹©çŒæˆåŠŸç‡å’Œé˜²å¾¡èƒ½åŠ›'
            },
            rope: {
                name: 'ç»³å­',
                ingredients: { herbs: 5 },
                time: 5,
                skill: 'crafting',
                unlockLevel: 1,
                description: 'ç”¨äºå»ºé€ å’Œåˆ¶ä½œ'
            },
            fire: {
                name: 'ç”Ÿç«',
                ingredients: { wood: 3, stone: 2 },
                time: 5,
                skill: 'survival',
                unlockLevel: 1,
                once: true,
                description: 'æä¾›æ¸©æš–å’Œçƒ¹é¥ªèƒ½åŠ›'
            },
            shelter: {
                name: 'ç®€æ˜“åº‡æŠ¤æ‰€',
                ingredients: { wood: 10, rope: 3, fur: 2 },
                time: 30,
                skill: 'building',
                unlockLevel: 2,
                once: true,
                description: 'æé«˜ä¼‘æ¯æ•ˆæœå’Œé˜²å¾¡èƒ½åŠ›'
            },
            cooked_meat: {
                name: 'çƒ¤è‚‰',
                ingredients: { meat_raw: 1 },
                time: 3,
                skill: 'cooking',
                unlockLevel: 1,
                requiresFire: true,
                description: 'è¥å…»ä¸°å¯Œçš„ç†Ÿé£Ÿ'
            },
            fishing_rod: {
                name: 'é±¼ç«¿',
                ingredients: { wood: 3, rope: 2 },
                time: 15,
                skill: 'crafting',
                unlockLevel: 3,
                description: 'å¯ä»¥åœ¨æ°´åŸŸé’“é±¼'
            },
            trap: {
                name: 'é™·é˜±',
                ingredients: { wood: 5, rope: 2 },
                time: 10,
                skill: 'crafting',
                unlockLevel: 2,
                description: 'æ•æ‰å°å‹åŠ¨ç‰©'
            },
            bow: {
                name: 'å¼“ç®­',
                ingredients: { wood: 4, rope: 2, leather: 1 },
                time: 20,
                skill: 'crafting',
                unlockLevel: 4,
                description: 'è¿œç¨‹ç‹©çŒæ­¦å™¨'
            },
            arrow: {
                name: 'ç®­',
                ingredients: { wood: 1, stone: 1, feather: 1 },
                time: 5,
                skill: 'crafting',
                unlockLevel: 4,
                description: 'å¼“ç®­çš„å¼¹è¯'
            },
            medicine: {
                name: 'è¯è†',
                ingredients: { herbs: 5, water: 1 },
                time: 8,
                skill: 'medicine',
                unlockLevel: 3,
                description: 'æ²»ç–—ä¼¤å£å’Œç–¾ç—…'
            },
            armor: {
                name: 'çš®ç”²',
                ingredients: { leather: 3, rope: 2 },
                time: 25,
                skill: 'crafting',
                unlockLevel: 5,
                description: 'æä¾›é˜²å¾¡ä¿æŠ¤'
            }
        };
        
        // åœ°ç‚¹æ•°æ®
        const locations = {
            forest: {
                name: 'æ£®æ—',
                image: 'https://images.unsplash.com/photo-1448375240586-882707db888b?ixlib=rb-1.2.1&auto=format&fit=crop&w=600&q=80',
                resources: ['wood', 'herbs', 'berries'],
                dangers: ['wolf', 'snake', 'spider'],
                exploreTime: 2,
                discoverable: ['river', 'cave'],
                description: 'èŒ‚å¯†çš„æ£®æ—ï¼Œèµ„æºä¸°å¯Œä½†å±é™©'
            },
            river: {
                name: 'æ²³æµ',
                image: 'https://images.unsplash.com/photo-1437482078695-8d9cea7f64ef?ixlib=rb-1.2.1&auto=format&fit=crop&w=600&q=80',
                resources: ['water', 'fish'],
                dangers: ['bear', 'piranha'],
                exploreTime: 3,
                discoverable: ['lake', 'waterfall'],
                description: 'æ¸…æ¾ˆçš„æ²³æµï¼Œæ°´æºå……è¶³'
            },
            cave: {
                name: 'æ´ç©´',
                image: 'https://images.unsplash.com/photo-1495563129107-1737a0896a19?ixlib=rb-1.2.1&auto=format&fit=crop&w=600&q=80',
                resources: ['stone', 'coal', 'iron_ore'],
                dangers: ['bat', 'bear', 'fall'],
                exploreTime: 4,
                discoverable: ['deep_cave'],
                description: 'é»‘æš—çš„æ´ç©´ï¼Œå¯èƒ½æœ‰çè´µçŸ¿ç‰©'
            },
            lake: {
                name: 'æ¹–æ³Š',
                image: 'https://images.unsplash.com/photo-1476231682828-37e571bc172f?ixlib=rb-1.2.1&auto=format&fit=crop&w=600&q=80',
                resources: ['water', 'fish'],
                dangers: ['crocodile', 'piranha'],
                exploreTime: 3,
                discoverable: ['mountain'],
                description: 'å¹¿é˜”çš„æ¹–æ³Šï¼Œé±¼ç±»èµ„æºä¸°å¯Œ'
            },
            waterfall: {
                name: 'ç€‘å¸ƒ',
                image: 'https://images.unsplash.com/photo-1519692933481-e162a57d6721?ixlib=rb-1.2.1&auto=format&fit=crop&w=600&q=80',
                resources: ['water', 'stone'],
                dangers: ['fall', 'piranha'],
                exploreTime: 4,
                discoverable: ['abandoned_camp'],
                description: 'å£®è§‚çš„ç€‘å¸ƒï¼Œå‘¨å›´å²©çŸ³ä¸°å¯Œ'
            },
            deep_cave: {
                name: 'æ·±æ´',
                image: 'https://images.unsplash.com/photo-1507272931001-fc06c17e4f43?ixlib=rb-1.2.1&auto=format&fit=crop&w=600&q=80',
                resources: ['iron_ore', 'coal', 'gem'],
                dangers: ['bat_swarm', 'fall', 'bear'],
                exploreTime: 6,
                discoverable: [],
                description: 'æ·±é‚ƒçš„æ´ç©´ï¼Œéšè—ç€çè´µçŸ¿ç‰©'
            },
            mountain: {
                name: 'å±±åœ°',
                image: 'https://images.unsplash.com/photo-1454789548928-9efd52dc4031?ixlib=rb-1.2.1&auto=format&fit=crop&w=600&q=80',
                resources: ['stone', 'iron_ore', 'herbs'],
                dangers: ['fall', 'avalanche', 'eagle'],
                exploreTime: 5,
                discoverable: [],
                description: 'é«˜è€¸çš„å±±åœ°ï¼Œè§†é‡å¼€é˜”ä½†å±é™©'
            },
            abandoned_camp: {
                name: 'åºŸå¼ƒè¥åœ°',
                image: 'https://images.unsplash.com/photo-1504280390367-361c6d9f38f4?ixlib=rb-1.2.1&auto=format&fit=crop&w=600&q=80',
                resources: ['wood', 'rope', 'cloth'],
                dangers: ['wolf', 'bear'],
                exploreTime: 4,
                discoverable: [],
                description: 'åºŸå¼ƒçš„éœ²è¥åœ°ï¼Œå¯èƒ½æ‰¾åˆ°æœ‰ç”¨ç‰©å“'
            }
        };
        
        // å±é™©äº‹ä»¶
        const dangers = {
            wolf: {
                name: 'ç‹¼è¢­å‡»',
                health: 50,
                damage: 15,
                chance: 0.2,
                avoidItems: ['spear', 'bow'],
                avoidChance: 0.7,
                loot: { fur: 1, meat_raw: 1 },
                description: 'å‡¶çŒ›çš„ç‹¼ç¾¤æ”»å‡»'
            },
            snake: {
                name: 'æ¯’è›‡å’¬ä¼¤',
                health: 20,
                damage: 10,
                poison: true,
                chance: 0.15,
                avoidItems: [],
                avoidChance: 0.3,
                loot: {},
                description: 'è¢«æ¯’è›‡å’¬ä¼¤ä¼šä¸­æ¯’'
            },
            spider: {
                name: 'èœ˜è››å’¬ä¼¤',
                health: 15,
                damage: 5,
                poison: true,
                chance: 0.1,
                avoidItems: [],
                avoidChance: 0.2,
                loot: {},
                description: 'æœ‰æ¯’èœ˜è››çš„å’¬ä¼¤'
            },
            bear: {
                name: 'ç†Šè¢­å‡»',
                health: 100,
                damage: 30,
                chance: 0.1,
                avoidItems: ['spear', 'bow'],
                avoidChance: 0.5,
                loot: { fur: 2, meat_raw: 2 },
                description: 'é­é‡å‡¶çŒ›çš„ç†Š'
            },
            piranha: {
                name: 'é£Ÿäººé±¼æ”»å‡»',
                health: 30,
                damage: 20,
                chance: 0.15,
                avoidItems: [],
                avoidChance: 0.2,
                loot: {},
                description: 'æ°´ä¸­çš„é£Ÿäººé±¼æ”»å‡»'
            },
            bat: {
                name: 'è™è ç¾¤',
                health: 25,
                damage: 5,
                chance: 0.3,
                avoidItems: [],
                avoidChance: 0.1,
                loot: {},
                description: 'è¢«è™è ç¾¤è¢­å‡»'
            },
            fall: {
                name: 'è·Œè½',
                health: 0,
                damage: 25,
                chance: 0.05,
                avoidItems: ['rope'],
                avoidChance: 0.8,
                loot: {},
                description: 'ä»é«˜å¤„è·Œè½å—ä¼¤'
            },
            crocodile: {
                name: 'é³„é±¼æ”»å‡»',
                health: 80,
                damage: 35,
                chance: 0.1,
                avoidItems: ['spear', 'bow'],
                avoidChance: 0.6,
                loot: { leather: 1, meat_raw: 2 },
                description: 'å‡¶çŒ›çš„é³„é±¼è¢­å‡»'
            },
            bat_swarm: {
                name: 'è™è ç¾¤',
                health: 40,
                damage: 8,
                chance: 0.4,
                avoidItems: [],
                avoidChance: 0.1,
                loot: {},
                description: 'å¤§ç¾¤è™è æ”»å‡»'
            },
            avalanche: {
                name: 'é›ªå´©',
                health: 0,
                damage: 40,
                chance: 0.05,
                avoidItems: [],
                avoidChance: 0.2,
                loot: {},
                description: 'é­é‡é›ªå´©å±é™©'
            },
            eagle: {
                name: 'é¹°è¢­å‡»',
                health: 35,
                damage: 15,
                chance: 0.15,
                avoidItems: ['bow'],
                avoidChance: 0.5,
                loot: { feather: 2 },
                description: 'çŒ›ç¦½æ”»å‡»'
            }
        };
        
        // å¤©æ°”æ•°æ®
        const weatherTypes = {
            sunny: {
                name: 'æ™´å¤©',
                temperatureEffect: 0,
                dangerModifier: 1,
                imageFilter: 'brightness(1)'
            },
            rainy: {
                name: 'é›¨å¤©',
                temperatureEffect: -1,
                dangerModifier: 1.2,
                imageFilter: 'brightness(0.8) contrast(1.2)'
            },
            stormy: {
                name: 'é›·æš´',
                temperatureEffect: -2,
                dangerModifier: 1.5,
                imageFilter: 'brightness(0.7) contrast(1.3)'
            },
            foggy: {
                name: 'é›¾å¤©',
                temperatureEffect: -1,
                dangerModifier: 0.8,
                imageFilter: 'brightness(0.9) contrast(0.8) blur(1px)'
            },
            snowy: {
                name: 'é›ªå¤©',
                temperatureEffect: -3,
                dangerModifier: 1.3,
                imageFilter: 'brightness(1.2) contrast(1.1)'
            }
        };
        
        // DOMå…ƒç´ 
        const elements = {
            healthValue: document.getElementById('health-value'),
            hungerValue: document.getElementById('hunger-value'),
            thirstValue: document.getElementById('thirst-value'),
            energyValue: document.getElementById('energy-value'),
            tempValue: document.getElementById('temp-value'),
            dayCount: document.getElementById('day-count'),
            timeText: document.getElementById('time-text'),
            hourDisplay: document.getElementById('hour-display'),
            weatherText: document.getElementById('weather-text'),
            locationImage: document.getElementById('location-image'),
            eventLog: document.getElementById('event-log'),
            inventory: document.getElementById('inventory'),
            inventoryCount: document.getElementById('inventory-count'),
            inventoryMax: document.getElementById('inventory-max'),
            craftingList: document.getElementById('crafting-list'),
            actionProgressFill: document.getElementById('action-progress-fill'),
            
            // æŒ‰é’®
            gatherBtn: document.getElementById('gather-btn'),
            huntBtn: document.getElementById('hunt-btn'),
            exploreBtn: document.getElementById('explore-btn'),
            restBtn: document.getElementById('rest-btn'),
            drinkBtn: document.getElementById('drink-btn'),
            eatBtn: document.getElementById('eat-btn'),
            buildBtn: document.getElementById('build-btn'),
            fireBtn: document.getElementById('fire-btn'),
            mapBtn: document.getElementById('map-btn'),
            skillsBtn: document.getElementById('skills-btn'),
            questsBtn: document.getElementById('quests-btn'),
            baseBtn: document.getElementById('base-btn'),
            craftingBtn: document.getElementById('crafting-btn'),
            
            // è®¾ç½®æŒ‰é’®
            musicBtn: document.getElementById('music-btn'),
            soundBtn: document.getElementById('sound-btn'),
            saveBtn: document.getElementById('save-btn'),
            loadBtn: document.getElementById('load-btn'),
            nightBtn: document.getElementById('night-btn'),
            
            // éŸ³ä¹æ§åˆ¶æŒ‰é’®
            dayMusicBtn: document.getElementById('day-music-btn'),
            nightMusicBtn: document.getElementById('night-music-btn'),
            rainMusicBtn: document.getElementById('rain-music-btn'),
            
            // éŸ³é¢‘
            dayMusic: document.getElementById('day-music'),
            nightMusic: document.getElementById('night-music'),
            rainMusic: document.getElementById('rain-music'),
            clickSound: document.getElementById('click-sound'),
            successSound: document.getElementById('success-sound'),
            failureSound: document.getElementById('failure-sound'),
            dangerSound: document.getElementById('danger-sound'),
            natureSound: document.getElementById('nature-sound'),
            combatSound: document.getElementById('combat-sound'),
            
            // ç‰©å“èœå•
            itemMenu: document.getElementById('item-menu'),
            
            // å·¥å…·æç¤º
            tooltip: document.getElementById('tooltip'),
            
            // é¢æ¿
            mapPanel: document.getElementById('map-panel'),
            mapContent: document.getElementById('map-content'),
            mapClose: document.getElementById('map-close'),
            
            skillsPanel: document.getElementById('skills-panel'),
            skillsClose: document.getElementById('skills-close'),
            
            questsPanel: document.getElementById('quests-panel'),
            questsClose: document.getElementById('quests-close'),
            
            basePanel: document.getElementById('base-panel'),
            baseClose: document.getElementById('base-close'),
            
            // æˆ˜æ–—é¢æ¿
            combatPanel: document.getElementById('combat-panel'),
            enemyName: document.getElementById('enemy-name'),
            enemyHealthFill: document.getElementById('enemy-health-fill'),
            combatMessage: document.getElementById('combat-message'),
            attackBtn: document.getElementById('attack-btn'),
            defendBtn: document.getElementById('defend-btn'),
            useItemBtn: document.getElementById('use-item-btn'),
            fleeBtn: document.getElementById('flee-btn'),
            
            // é€šçŸ¥
            notification: document.getElementById('notification')
        };
        
        // å½“å‰é€‰ä¸­çš„ç‰©å“
        let selectedItem = null;
        
        // åˆå§‹åŒ–æ¸¸æˆ
        function initGame() {
            updateUI();
            renderInventory();
            updateTimeDisplay();
            updateLocationImage();
            updateWeather();
            renderMap();
            renderSkills();
            renderQuests();
            renderBase();
            
            // åŠ è½½ä¿å­˜çš„æ¸¸æˆ
            loadGame();
            
            // å¼€å§‹æ¸¸æˆå¾ªç¯
            setInterval(gameLoop, 1000);
            setInterval(saveGame, 30000); // æ¯30ç§’è‡ªåŠ¨ä¿å­˜
            
            // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
            setupEventListeners();
            
            // åˆå§‹åŒ–éŸ³ä¹
            initMusic();
            
            // æ·»åŠ åˆå§‹æ—¥å¿—
            addToLog("ä½ åœ¨ä¸€ç‰‡é™Œç”Ÿçš„è’é‡ä¸­é†’æ¥ï¼Œå¿…é¡»æƒ³åŠæ³•ç”Ÿå­˜ä¸‹å»...", "info");
            addToLog("è­¦å‘Š: è¿™æ˜¯ä¸€ä¸ªé«˜éš¾åº¦ç”Ÿå­˜æ¸¸æˆï¼Œæ­»äº¡æ˜¯å¸¸æœ‰çš„äº‹!", "warning");
            
            // ç‚¹å‡»ç‰©å“èœå•å¤–éƒ¨å…³é—­èœå•
            document.addEventListener('click', (e) => {
                if (!elements.itemMenu.contains(e.target) && !e.target.classList.contains('item')) {
                    elements.itemMenu.style.display = 'none';
                }
            });
            
            // é¦–æ¬¡äº¤äº’åæ’­æ”¾éŸ³ä¹
            const handleFirstInteraction = () => {
                if (gameState.musicEnabled) {
                    updateBackgroundMusic();
                }
                if (gameState.soundEnabled) {
                    elements.natureSound.play().catch(e => console.log("è‡ªç„¶éŸ³æ•ˆè¢«é˜»æ­¢:", e));
                }
                document.removeEventListener('click', handleFirstInteraction);
                document.removeEventListener('keydown', handleFirstInteraction);
            };
            
            document.addEventListener('click', handleFirstInteraction);
            document.addEventListener('keydown', handleFirstInteraction);
        }
        
        // åˆå§‹åŒ–éŸ³ä¹
        function initMusic() {
            // è®¾ç½®éŸ³ä¹éŸ³é‡
            elements.dayMusic.volume = 0.3;
            elements.nightMusic.volume = 0.3;
            elements.rainMusic.volume = 0.3;
            elements.natureSound.volume = 0.2;
            
            // æ’­æ”¾è‡ªç„¶éŸ³æ•ˆ
            if (gameState.soundEnabled) {
                elements.natureSound.play().catch(e => console.log("è‡ªç„¶éŸ³æ•ˆè¢«é˜»æ­¢:", e));
            }
            
            // æ ¹æ®æ—¶é—´æ’­æ”¾èƒŒæ™¯éŸ³ä¹
            updateBackgroundMusic();
        }
        
        // æ›´æ–°èƒŒæ™¯éŸ³ä¹
        function updateBackgroundMusic() {
            if (!gameState.musicEnabled) return;
            
            // åœæ­¢å½“å‰éŸ³ä¹
            if (gameState.currentMusic) {
                fadeOutAudio(gameState.currentMusic);
            }
            
            // æ ¹æ®æ—¶é—´å’Œå¤©æ°”é€‰æ‹©éŸ³ä¹
            let newMusic;
            if (gameState.weather === 'rainy' || gameState.weather === 'stormy') {
                newMusic = elements.rainMusic;
            } else if (gameState.isDay) {
                newMusic = elements.dayMusic;
            } else {
                newMusic = elements.nightMusic;
            }
            
            // æ’­æ”¾æ–°éŸ³ä¹
            gameState.currentMusic = newMusic;
            fadeInAudio(newMusic);
        }
        
        // æ·¡å…¥éŸ³é¢‘
        function fadeInAudio(audioElement, duration = 2000) {
            audioElement.volume = 0;
            audioElement.currentTime = 0;
            audioElement.play().catch(e => console.log("éŸ³ä¹æ’­æ”¾è¢«é˜»æ­¢:", e));
            
            const fadeInterval = setInterval(() => {
                if (audioElement.volume < 0.3) {
                    audioElement.volume += 0.01;
                } else {
                    clearInterval(fadeInterval);
                }
            }, duration / 30);
        }
        
        // æ·¡å‡ºéŸ³é¢‘
        function fadeOutAudio(audioElement, duration = 2000) {
            const fadeInterval = setInterval(() => {
                if (audioElement.volume > 0.01) {
                    audioElement.volume -= 0.01;
                } else {
                    audioElement.pause();
                    clearInterval(fadeInterval);
                }
            }, duration / 30);
        }
        
        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            // è¡ŒåŠ¨æŒ‰é’®
            elements.gatherBtn.addEventListener('click', () => startAction('gather'));
            elements.huntBtn.addEventListener('click', () => startAction('hunt'));
            elements.exploreBtn.addEventListener('click', () => startAction('explore'));
            elements.restBtn.addEventListener('click', () => startAction('rest'));
            elements.drinkBtn.addEventListener('click', () => startAction('drink'));
            elements.eatBtn.addEventListener('click', () => startAction('eat'));
            elements.buildBtn.addEventListener('click', () => startAction('build'));
            elements.fireBtn.addEventListener('click', () => startAction('fire'));
            elements.mapBtn.addEventListener('click', showMap);
            elements.skillsBtn.addEventListener('click', showSkills);
            elements.questsBtn.addEventListener('click', showQuests);
            elements.baseBtn.addEventListener('click', showBase);
            
            // åˆ¶ä½œæŒ‰é’®
            elements.craftingBtn.addEventListener('click', toggleCraftingList);
            
            // è®¾ç½®æŒ‰é’®
            elements.musicBtn.addEventListener('click', toggleMusic);
            elements.soundBtn.addEventListener('click', toggleSound);
            elements.saveBtn.addEventListener('click', () => {
                saveGame();
                addToLog("æ¸¸æˆå·²ä¿å­˜", "success");
                playSound('success');
            });
            elements.loadBtn.addEventListener('click', () => {
                loadGame();
                addToLog("æ¸¸æˆå·²åŠ è½½", "success");
                playSound('success');
            });
            elements.nightBtn.addEventListener('click', toggleNightMode);
            
            // éŸ³ä¹æ§åˆ¶æŒ‰é’®
            elements.dayMusicBtn.addEventListener('click', () => playSpecificMusic('day'));
            elements.nightMusicBtn.addEventListener('click', () => playSpecificMusic('night'));
            elements.rainMusicBtn.addEventListener('click', () => playSpecificMusic('rain'));
            
            // é¢æ¿å…³é—­æŒ‰é’®
            elements.mapClose.addEventListener('click', hideMap);
            elements.skillsClose.addEventListener('click', hideSkills);
            elements.questsClose.addEventListener('click', hideQuests);
            elements.baseClose.addEventListener('click', hideBase);
            
            // æˆ˜æ–—æŒ‰é’®
            elements.attackBtn.addEventListener('click', combatAttack);
            elements.defendBtn.addEventListener('click', combatDefend);
            elements.useItemBtn.addEventListener('click', combatUseItem);
            elements.fleeBtn.addEventListener('click', combatFlee);
            
            // åŸºåœ°å‡çº§æŒ‰é’®
            document.getElementById('upgrade-shelter-btn').addEventListener('click', upgradeShelter);
            document.getElementById('upgrade-storage-btn').addEventListener('click', upgradeStorage);
            document.getElementById('upgrade-workbench-btn').addEventListener('click', upgradeWorkbench);
            
            // ç‚¹å‡»æ•ˆæœ
            document.querySelectorAll('button').forEach(btn => {
                btn.addEventListener('click', () => playSound('click'));
            });
            
            // ç‰©å“æç¤º
            setupItemTooltips();
        }
        
        // è®¾ç½®ç‰©å“æç¤º
        function setupItemTooltips() {
            document.addEventListener('mousemove', (e) => {
                const itemElement = e.target.closest('.item');
                if (itemElement) {
                    const itemId = itemElement.dataset.itemId;
                    if (itemId && items[itemId]) {
                        elements.tooltip.textContent = items[itemId].description;
                        elements.tooltip.style.display = 'block';
                        elements.tooltip.style.left = `${e.pageX + 10}px`;
                        elements.tooltip.style.top = `${e.pageY + 10}px`;
                    }
                } else {
                    elements.tooltip.style.display = 'none';
                }
            });
        }
        
        // æ’­æ”¾ç‰¹å®šéŸ³ä¹
        function playSpecificMusic(type) {
            if (!gameState.musicEnabled) return;
            
            // åœæ­¢å½“å‰éŸ³ä¹
            if (gameState.currentMusic) {
                fadeOutAudio(gameState.currentMusic);
            }
            
            // æ ¹æ®ç±»å‹é€‰æ‹©éŸ³ä¹
            let newMusic;
            switch (type) {
                case 'day':
                    newMusic = elements.dayMusic;
                    gameState.weather = 'sunny';
                    break;
                case 'night':
                    newMusic = elements.nightMusic;
                    gameState.weather = 'sunny';
                    break;
                case 'rain':
                    newMusic = elements.rainMusic;
                    gameState.weather = 'rainy';
                    break;
            }
            
            // æ›´æ–°å¤©æ°”æ˜¾ç¤º
            updateWeather();
            
            // æ’­æ”¾æ–°éŸ³ä¹
            gameState.currentMusic = newMusic;
            fadeInAudio(newMusic);
            
            addToLog(`åˆ‡æ¢ä¸º${type === 'day' ? 'ç™½å¤©' : type === 'night' ? 'å¤œæ™š' : 'é›¨å¤©'}éŸ³ä¹`, "info");
            playSound('click');
        }
        
        // æ¸¸æˆä¸»å¾ªç¯
        function gameLoop() {
            // æ›´æ–°æ—¶é—´
            updateTime();
            
            // æ›´æ–°ç©å®¶çŠ¶æ€
            updatePlayerStatus();
            
            // æ›´æ–°ç«çš„çŠ¶æ€
            if (gameState.fire) {
                gameState.fireDuration--;
                if (gameState.fireDuration <= 0) {
                    gameState.fire = false;
                    addToLog("ç«å †ç†„ç­äº†", "warning");
                }
            }
            
            // æ›´æ–°å¤©æ°”
            if (gameState.weatherDuration <= 0) {
                changeWeather();
            } else {
                gameState.weatherDuration--;
            }
            
            // éšæœºäº‹ä»¶
            if (Math.random() < 0.005) { // 0.5%å‡ ç‡éšæœºäº‹ä»¶
                triggerRandomEvent();
            }
            
            // æ£€æŸ¥ä»»åŠ¡å®Œæˆæƒ…å†µ
            checkQuests();
            
            // æ›´æ–°UI
            updateUI();
        }
        
        // æ›´æ–°æ—¶é—´
        function updateTime() {
            gameState.minute += 5;
            
            if (gameState.minute >= 60) {
                gameState.minute = 0;
                gameState.hour++;
                
                if (gameState.hour >= 24) {
                    gameState.hour = 0;
                    gameState.day++;
                    gameState.stats.daysSurvived++;
                    addToLog(`ç¬¬ ${gameState.day} å¤©å¼€å§‹äº†`, "info");
                    
                    // æ¯å¤©é‡ç½®æ¯æ—¥ä»»åŠ¡
                    resetDailyQuests();
                    
                    // æ¯å¤©å¢åŠ éš¾åº¦
                    increaseDifficulty();
                }
            }
            
            // æ›´æ–°æ˜¼å¤œçŠ¶æ€
            const wasDay = gameState.isDay;
            gameState.isDay = (gameState.hour >= 6 && gameState.hour < 20);
            
            // å¦‚æœæ˜¼å¤œçŠ¶æ€æ”¹å˜ï¼Œæ›´æ–°éŸ³ä¹
            if (wasDay !== gameState.isDay) {
                updateBackgroundMusic();
            }
            
            updateTimeDisplay();
        }
        
        // æ›´æ–°å¤©æ°”
        function changeWeather() {
            const weatherTypes = Object.keys(weatherTypes);
            const newWeather = weatherTypes[Math.floor(Math.random() * weatherTypes.length)];
            
            // ç¡®ä¿å¤©æ°”å˜åŒ–ä¸è¦å¤ªé¢‘ç¹
            if (newWeather !== gameState.weather || Math.random() < 0.3) {
                gameState.weather = newWeather;
                gameState.weatherDuration = 60 + Math.floor(Math.random() * 120); // 1-3å°æ—¶
                
                addToLog(`å¤©æ°”å˜ä¸º${weatherTypes[newWeather].name}`, "info");
                updateWeather();
                updateBackgroundMusic();
            }
        }
        
        // æ›´æ–°å¤©æ°”æ˜¾ç¤º
        function updateWeather() {
            const weather = weatherTypes[gameState.weather];
            elements.weatherText.textContent = weather.name;
            elements.locationImage.style.filter = weather.imageFilter;
        }
        
        // å¢åŠ æ¸¸æˆéš¾åº¦
        function increaseDifficulty() {
            // æ¯å¤©å¢åŠ èµ„æºæ¶ˆè€—
            gameState.hunger -= 5 + Math.floor(gameState.day / 5);
            gameState.thirst -= 7 + Math.floor(gameState.day / 5);
            
            // æ¯5å¤©å¢åŠ åº“å­˜ä¸Šé™
            if (gameState.day % 5 === 0) {
                gameState.inventoryMax += 2;
                showNotification(`åº“å­˜ä¸Šé™å¢åŠ è‡³ ${gameState.inventoryMax}`);
            }
        }
        
        // è§¦å‘éšæœºäº‹ä»¶
        function triggerRandomEvent() {
            const events = [
                { name: "å¯’å†·çš„å¤œæ™š", effect: () => { 
                    gameState.temperature -= 2; 
                    addToLog("å¤œæ™šå¼‚å¸¸å¯’å†·ï¼Œä½ çš„ä½“æ¸©ä¸‹é™äº†", "warning"); 
                } },
                { name: "é£Ÿç‰©å˜è´¨", effect: () => { 
                    if (gameState.inventory['meat_raw'] > 0) {
                        gameState.inventory['meat_raw'] = Math.max(0, gameState.inventory['meat_raw'] - 1);
                        addToLog("ä¸€äº›ç”Ÿè‚‰å˜è´¨äº†ï¼Œä¸å¾—ä¸ä¸¢å¼ƒ", "warning");
                    }
                } },
                { name: "å‘ç°èµ„æº", effect: () => {
                    const resource = getRandomResource();
                    addItem(resource, 1);
                    addToLog(`ä½ æ„å¤–å‘ç°äº†1ä¸ª${items[resource].name}`, "success");
                } },
                { name: "å—ä¼¤", effect: () => {
                    gameState.health -= 10;
                    addToLog("ä½ åœ¨ç¡æ¢¦ä¸­å—ä¼¤äº†", "danger");
                } },
                { name: "å¤©æ°”å˜åŒ–", effect: () => {
                    changeWeather();
                } },
                { name: "é‡ç”ŸåŠ¨ç‰©", effect: () => {
                    const location = locations[gameState.location];
                    if (location.dangers && location.dangers.length > 0) {
                        const dangerId = location.dangers[Math.floor(Math.random() * location.dangers.length)];
                        startCombat(dangerId);
                    }
                } },
                { name: "å‘ç°é…æ–¹", effect: () => {
                    const allRecipes = Object.keys(recipes);
                    const undiscovered = allRecipes.filter(r => !gameState.unlockedRecipes.includes(r));
                    if (undiscovered.length > 0) {
                        const newRecipe = undiscovered[Math.floor(Math.random() * undiscovered.length)];
                        gameState.unlockedRecipes.push(newRecipe);
                        addToLog(`ä½ çµå…‰ä¸€ç°ï¼Œæƒ³åˆ°äº†å¦‚ä½•åˆ¶ä½œ${recipes[newRecipe].name}`, "info");
                    }
                } }
            ];
            
            const event = events[Math.floor(Math.random() * events.length)];
            event.effect();
        }
        
        // æ›´æ–°ç©å®¶çŠ¶æ€
        function updatePlayerStatus() {
            // é¥¥é¥¿å’Œå£æ¸´å½±å“å¥åº·
            if (gameState.hunger <= 0) {
                gameState.health -= 1;
                addToLog("ä½ æ­£åœ¨æŒ¨é¥¿!", "danger");
            }
            
            if (gameState.thirst <= 0) {
                gameState.health -= 2;
                addToLog("ä½ ä¸¥é‡è„±æ°´!", "danger");
            }
            
            // ç²¾åŠ›æ¢å¤
            if (!gameState.currentAction) {
                gameState.energy = Math.min(gameState.maxEnergy, gameState.energy + 0.5);
            }
            
            // æ¸©åº¦å½±å“
            const weatherEffect = weatherTypes[gameState.weather].temperatureEffect;
            const baseTemp = gameState.isDay ? 37 : 35;
            const targetTemp = baseTemp + weatherEffect;
            
            // ç¼“æ…¢å‘ç›®æ ‡æ¸©åº¦é è¿‘
            if (gameState.temperature < targetTemp) {
                gameState.temperature += 0.1;
            } else if (gameState.temperature > targetTemp) {
                gameState.temperature -= 0.1;
            }
            
            // ç«å †æä¾›æ¸©æš–
            if (gameState.fire) {
                gameState.temperature += 0.5;
            }
            
            // åº‡æŠ¤æ‰€æä¾›æ¸©æš–
            if (gameState.shelterLevel > 0) {
                gameState.temperature += gameState.shelterLevel * 0.3;
            }
            
            // æ¸©åº¦æç«¯å½±å“å¥åº·
            if (gameState.temperature < 35) {
                gameState.health -= 1;
                addToLog("ä½ ä½“æ¸©è¿‡ä½!", "danger");
            } else if (gameState.temperature > 39) {
                gameState.health -= 1;
                addToLog("ä½ å‘çƒ§äº†!", "danger");
            }
            
            // æ£€æŸ¥æ­»äº¡
            if (gameState.health <= 0) {
                gameOver();
            }
            
            // ç¡®ä¿æ•°å€¼åœ¨åˆç†èŒƒå›´å†…
            gameState.health = Math.max(0, Math.min(gameState.maxHealth, gameState.health));
            gameState.hunger = Math.max(0, Math.min(gameState.maxHunger, gameState.hunger));
            gameState.thirst = Math.max(0, Math.min(gameState.maxThirst, gameState.thirst));
            gameState.energy = Math.max(0, Math.min(gameState.maxEnergy, gameState.energy));
            gameState.temperature = Math.max(30, Math.min(42, gameState.temperature));
        }
        
        // æ¸¸æˆç»“æŸ
        function gameOver() {
            addToLog("ä½ æ­»äº†...", "danger");
            addToLog(`ç”Ÿå­˜å¤©æ•°: ${gameState.day}`, "info");
            addToLog("æ¸¸æˆå°†åœ¨10ç§’åé‡æ–°å¼€å§‹", "info");
            playSound('danger');
            
            // ç¦ç”¨æ‰€æœ‰æŒ‰é’®
            document.querySelectorAll('button').forEach(btn => {
                btn.disabled = true;
            });
            
            // åœæ­¢æ‰€æœ‰éŸ³ä¹
            fadeOutAudio(elements.dayMusic);
            fadeOutAudio(elements.nightMusic);
            fadeOutAudio(elements.rainMusic);
            elements.natureSound.pause();
            
            // 10ç§’åé‡ç½®æ¸¸æˆ
            setTimeout(() => {
                resetGame();
            }, 10000);
        }
        
        // é‡ç½®æ¸¸æˆ
        function resetGame() {
            // é‡ç½®çŠ¶æ€
            gameState.health = 100;
            gameState.hunger = 80;
            gameState.thirst = 75;
            gameState.energy = 90;
            gameState.temperature = 36.5;
            gameState.day = 1;
            gameState.hour = 6;
            gameState.minute = 0;
            gameState.inventory = {};
            gameState.location = 'forest';
            gameState.discoveredLocations = ['forest'];
            gameState.shelterLevel = 0;
            gameState.storageLevel = 0;
            gameState.workbenchLevel = 0;
            gameState.fire = false;
            gameState.fireDuration = 0;
            gameState.currentAction = null;
            gameState.actionProgress = 0;
            gameState.weather = 'sunny';
            gameState.weatherDuration = 0;
            
            // é‡ç½®æŠ€èƒ½
            for (const skill in gameState.skills) {
                gameState.skills[skill] = { level: 1, xp: 0, xpToNext: 100 };
            }
            
            // é‡ç½®ä»»åŠ¡
            gameState.quests = {
                daily: {
                    gatherWood: { target: 10, progress: 0, completed: false },
                    huntAnimals: { target: 3, progress: 0, completed: false }
                },
                main: {
                    buildShelter: { completed: false }
                }
            };
            
            // å¯ç”¨æŒ‰é’®
            document.querySelectorAll('button').forEach(btn => {
                btn.disabled = false;
            });
            
            // æ›´æ–°UI
            updateUI();
            renderInventory();
            updateTimeDisplay();
            updateLocationImage();
            updateWeather();
            renderSkills();
            renderQuests();
            
            // é‡æ–°å¼€å§‹éŸ³ä¹
            initMusic();
            
            addToLog("æ–°çš„ç”Ÿå­˜æŒ‘æˆ˜å¼€å§‹äº†...", "info");
        }
        
        // å¼€å§‹ä¸€ä¸ªè¡ŒåŠ¨
        function startAction(action) {
            if (gameState.currentAction) {
                addToLog("ä½ å·²ç»åœ¨è¿›è¡Œä¸€ä¸ªè¡ŒåŠ¨äº†", "warning");
                return;
            }
            
            if (gameState.inCombat) {
                addToLog("ä½ æ­£åœ¨æˆ˜æ–—ä¸­ï¼Œæ— æ³•æ‰§è¡Œæ­¤è¡ŒåŠ¨", "warning");
                return;
            }
            
            if (gameState.energy < 10) {
                addToLog("ä½ å¤ªç´¯äº†ï¼Œæ— æ³•è¡ŒåŠ¨", "warning");
                return;
            }
            
            playSound('click');
            
            switch (action) {
                case 'gather':
                    gameState.currentAction = 'gather';
                    gameState.actionDifficulty = 5 + Math.floor(gameState.day / 3);
                    addToLog("å¼€å§‹é‡‡é›†èµ„æº...", "info");
                    break;
                    
                case 'hunt':
                    gameState.currentAction = 'hunt';
                    gameState.actionDifficulty = 10 + Math.floor(gameState.day / 2);
                    addToLog("å¼€å§‹ç‹©çŒ...", "info");
                    break;
                    
                case 'explore':
                    gameState.currentAction = 'explore';
                    gameState.actionDifficulty = locations[gameState.location].exploreTime;
                    addToLog("å¼€å§‹æ¢ç´¢å‘¨å›´...", "info");
                    break;
                    
                case 'rest':
                    gameState.currentAction = 'rest';
                    gameState.actionDifficulty = 4;
                    addToLog("å¼€å§‹ä¼‘æ¯...", "info");
                    break;
                    
                case 'drink':
                    if (gameState.inventory['water'] > 0) {
                        gameState.currentAction = 'drink';
                        gameState.actionDifficulty = 1;
                        addToLog("å–æ°´...", "info");
                    } else {
                        addToLog("ä½ æ²¡æœ‰æ°´å¯ä»¥å–", "warning");
                        return;
                    }
                    break;
                    
                case 'eat':
                    if (gameState.inventory['berries'] > 0 || gameState.inventory['meat_cooked'] > 0 || gameState.inventory['meat_raw'] > 0) {
                        gameState.currentAction = 'eat';
                        gameState.actionDifficulty = 2;
                        addToLog("è¿›é£Ÿ...", "info");
                    } else {
                        addToLog("ä½ æ²¡æœ‰é£Ÿç‰©å¯ä»¥åƒ", "warning");
                        return;
                    }
                    break;
                    
                case 'build':
                    toggleCraftingList();
                    addToLog("é€‰æ‹©è¦åˆ¶ä½œçš„ç‰©å“", "info");
                    return;
                    
                case 'fire':
                    if (!gameState.fire) {
                        if (gameState.inventory['wood'] >= 3 && gameState.inventory['stone'] >= 2) {
                            gameState.currentAction = 'fire';
                            gameState.actionDifficulty = 5;
                            addToLog("å¼€å§‹ç”Ÿç«...", "info");
                        } else {
                            addToLog("ä½ éœ€è¦3ä¸ªæœ¨æå’Œ2ä¸ªçŸ³å¤´æ¥ç”Ÿç«", "warning");
                            return;
                        }
                    } else {
                        addToLog("ç«å·²ç»ç‡ƒç€äº†", "info");
                        return;
                    }
                    break;
            }
            
            // å¼€å§‹è¡ŒåŠ¨è¿›åº¦
            gameState.actionProgress = 0;
            elements.actionProgressFill.style.width = '0%';
            
            // å¼€å§‹è¡ŒåŠ¨è®¡æ—¶å™¨
            gameState.actionInterval = setInterval(() => {
                gameState.actionProgress++;
                elements.actionProgressFill.style.width = `${(gameState.actionProgress / gameState.actionDifficulty) * 100}%`;
                
                // æ¶ˆè€—ç²¾åŠ›
                gameState.energy = Math.max(0, gameState.energy - 0.5);
                
                // è¡ŒåŠ¨å®Œæˆ
                if (gameState.actionProgress >= gameState.actionDifficulty) {
                    completeAction();
                }
            }, 1000);
        }
        
        // å®Œæˆå½“å‰è¡ŒåŠ¨
        function completeAction() {
            clearInterval(gameState.actionInterval);
            elements.actionProgressFill.style.width = '0%';
            
            const action = gameState.currentAction;
            gameState.currentAction = null;
            
            switch (action) {
                case 'gather':
                    gatherResources();
                    break;
                    
                case 'hunt':
                    hunt();
                    break;
                    
                case 'explore':
                    explore();
                    break;
                    
                case 'rest':
                    rest();
                    break;
                    
                case 'drink':
                    drink();
                    break;
                    
                case 'eat':
                    eat();
                    break;
                    
                case 'fire':
                    makeFire();
                    break;
            }
        }
        
        // é‡‡é›†èµ„æº
        function gatherResources() {
            const location = locations[gameState.location];
            let gathered = false;
            
            // å°è¯•é‡‡é›†æ¯ç§èµ„æº
            location.resources.forEach(resource => {
                // æ ¹æ®æŠ€èƒ½ç­‰çº§æé«˜é‡‡é›†æˆåŠŸç‡
                let successChance = 0.7;
                if (resource === 'wood' && gameState.skills.woodcutting.level > 1) {
                    successChance += gameState.skills.woodcutting.level * 0.05;
                } else if ((resource === 'stone' || resource === 'iron_ore') && gameState.skills.mining.level > 1) {
                    successChance += gameState.skills.mining.level * 0.05;
                }
                
                if (Math.random() < successChance) {
                    let amount = Math.floor(Math.random() * 2) + 1; // 1-2ä¸ª
                    
                    // æŠ€èƒ½æé«˜é‡‡é›†æ•°é‡
                    if (resource === 'wood' && gameState.skills.woodcutting.level > 1) {
                        amount += Math.floor(gameState.skills.woodcutting.level / 2);
                    } else if ((resource === 'stone' || resource === 'iron_ore') && gameState.skills.mining.level > 1) {
                        amount += Math.floor(gameState.skills.mining.level / 2);
                    }
                    
                    addItem(resource, amount);
                    addToLog(`è·å¾—äº† ${amount} ä¸ª${items[resource].name}`, "success");
                    gathered = true;
                    gameState.stats.itemsGathered += amount;
                    
                    // å¢åŠ æŠ€èƒ½ç»éªŒ
                    if (resource === 'wood') {
                        addSkillXP('woodcutting', 10);
                    } else if (resource === 'stone' || resource === 'iron_ore') {
                        addSkillXP('mining', 10);
                    } else {
                        addSkillXP('survival', 5);
                    }
                    
                    // å‘ç°æ–°ç‰©å“
                    if (!gameState.discoveredItems.includes(resource)) {
                        gameState.discoveredItems.push(resource);
                        addToLog(`å‘ç°äº†æ–°èµ„æº: ${items[resource].name}`, "info");
                    }
                }
            });
            
            if (!gathered) {
                addToLog("æ²¡æœ‰æ‰¾åˆ°ä»»ä½•æœ‰ç”¨çš„èµ„æº", "warning");
            }
            
            // æœ‰å‡ ç‡é‡åˆ°å±é™©
            checkForDanger();
            
            playSound(gathered ? 'success' : 'failure');
        }
        
        // ç‹©çŒ
        function hunt() {
            const location = locations[gameState.location];
            
            // æ ¹æ®ç‹©çŒæŠ€èƒ½æé«˜æˆåŠŸç‡
            let successChance = 0.6 + (gameState.skills.hunting.level * 0.05);
            successChance = Math.min(0.9, successChance);
            
            if (location.dangers && location.dangers.length > 0 && Math.random() < successChance) {
                // ç‹©çŒæˆåŠŸ
                const resource = 'meat_raw';
                let amount = Math.floor(Math.random() * 2) + 1; // 1-2ä¸ª
                
                // æŠ€èƒ½æé«˜ç‹©çŒæ•°é‡
                amount += Math.floor(gameState.skills.hunting.level / 2);
                
                addItem(resource, amount);
                addToLog(`ç‹©çŒæˆåŠŸ! è·å¾—äº† ${amount} ä¸ª${items[resource].name}`, "success");
                gameState.stats.animalsHunted += amount;
                playSound('success');
                
                // å¢åŠ ç‹©çŒæŠ€èƒ½ç»éªŒ
                addSkillXP('hunting', 15);
                
                // æ›´æ–°ç‹©çŒä»»åŠ¡è¿›åº¦
                if (gameState.quests.daily.huntAnimals && !gameState.quests.daily.huntAnimals.completed) {
                    gameState.quests.daily.huntAnimals.progress += amount;
                    renderQuests();
                }
                
                // æœ‰é¢å¤–å‡ ç‡è·å¾—æ¯›çš®
                if (Math.random() < 0.4) {
                    addItem('fur', 1);
                    addToLog("è·å¾—äº† 1 ä¸ªæ¯›çš®", "success");
                }
            } else {
                addToLog("ç‹©çŒå¤±è´¥ï¼Œæ²¡æœ‰æ‰¾åˆ°çŒç‰©", "warning");
                playSound('failure');
                
                // å³ä½¿å¤±è´¥ä¹Ÿè·å¾—å°‘é‡ç»éªŒ
                addSkillXP('hunting', 5);
            }
            
            // ç‹©çŒæœ‰æ›´é«˜å‡ ç‡é‡åˆ°å±é™©
            if (Math.random() < 0.5) {
                checkForDanger(0.2); // é¢å¤–20%å±é™©å‡ ç‡
            }
        }
        
        // æ¢ç´¢
        function explore() {
            const location = locations[gameState.location];
            
            if (location.discoverable && location.discoverable.length > 0 && Math.random() < 0.5) {
                // å‘ç°æ–°åœ°ç‚¹
                const newLocation = location.discoverable[Math.floor(Math.random() * location.discoverable.length)];
                
                if (!gameState.discoveredLocations.includes(newLocation)) {
                    gameState.discoveredLocations.push(newLocation);
                    addToLog(`å‘ç°äº†ä¸€ä¸ªæ–°çš„åœ°ç‚¹: ${locations[newLocation].name}`, "success");
                    gameState.stats.locationsExplored++;
                    playSound('success');
                    
                    // é‡æ–°æ¸²æŸ“åœ°å›¾
                    renderMap();
                } else {
                    addToLog("æ²¡æœ‰å‘ç°æ–°çš„åœ°ç‚¹", "info");
                    playSound('failure');
                }
            } else {
                addToLog("æ¢ç´¢æ²¡æœ‰å‘ç°ä»»ä½•æ–°åœ°ç‚¹", "info");
                playSound('failure');
            }
            
            // æ¢ç´¢æœ‰å‡ ç‡é‡åˆ°å±é™©
            checkForDanger();
            
            // æ¢ç´¢æ€»èƒ½æ‰¾åˆ°ä¸€äº›èµ„æº
            if (Math.random() < 0.8) {
                const resource = getRandomResource();
                addItem(resource, 1);
                addToLog(`åœ¨æ¢ç´¢ä¸­æ‰¾åˆ°äº†1ä¸ª${items[resource].name}`, "info");
            }
        }
        
        // ä¼‘æ¯
        function rest() {
            const healthRecover = 10 + Math.floor(gameState.shelterLevel * 5);
            const energyRecover = 30 + Math.floor(gameState.shelterLevel * 10);
            
            gameState.health = Math.min(gameState.maxHealth, gameState.health + healthRecover);
            gameState.energy = Math.min(gameState.maxEnergy, gameState.energy + energyRecover);
            
            addToLog(`ä¼‘æ¯åæ¢å¤äº† ${healthRecover} ç‚¹å¥åº·å’Œ ${energyRecover} ç‚¹ç²¾åŠ›`, "success");
            
            // åº‡æŠ¤æ‰€æä¾›æ›´å¥½çš„ä¼‘æ¯æ•ˆæœ
            if (gameState.shelterLevel > 0) {
                addToLog("åº‡æŠ¤æ‰€è®©ä½ ä¼‘æ¯å¾—æ›´å¥½", "info");
            }
            
            // æœ‰å‡ ç‡æ¢å¤ä½“æ¸©
            if (Math.random() < 0.7) {
                gameState.temperature = Math.min(37, gameState.temperature + 0.5);
            }
            
            playSound('success');
        }
        
        // å–æ°´
        function drink() {
            if (gameState.inventory['water'] > 0) {
                gameState.inventory['water']--;
                gameState.thirst = Math.min(gameState.maxThirst, gameState.thirst + 30);
                addToLog("å–äº†ä¸€äº›æ°´ï¼Œå£æ¸´æ„Ÿå‡è½»äº†", "success");
                playSound('success');
                
                // æœ‰å‡ ç‡æ¢å¤å°‘é‡å¥åº·
                if (Math.random() < 0.3) {
                    gameState.health = Math.min(gameState.maxHealth, gameState.health + 5);
                    addToLog("å¹²å‡€çš„æ°´è®©ä½ æ„Ÿè§‰å¥½ä¸€äº›äº†", "info");
                }
            }
        }
        
        // è¿›é£Ÿ
        function eat() {
            let foodEaten = false;
            
            // ä¼˜å…ˆåƒç†Ÿè‚‰
            if (gameState.inventory['meat_cooked'] > 0) {
                gameState.inventory['meat_cooked']--;
                gameState.hunger = Math.min(gameState.maxHunger, gameState.hunger + 40);
                addToLog("åƒäº†ä¸€äº›ç†Ÿè‚‰ï¼Œé¥¥é¥¿æ„Ÿå¤§å¤§å‡è½»", "success");
                foodEaten = true;
                
                // å¢åŠ çƒ¹é¥ªæŠ€èƒ½ç»éªŒ
                addSkillXP('cooking', 5);
            } 
            // å…¶æ¬¡åƒæµ†æœ
            else if (gameState.inventory['berries'] > 0) {
                gameState.inventory['berries']--;
                gameState.hunger = Math.min(gameState.maxHunger, gameState.hunger + 15);
                addToLog("åƒäº†ä¸€äº›æµ†æœï¼Œé¥¥é¥¿æ„Ÿå‡è½»äº†", "success");
                foodEaten = true;
                
                // æµ†æœæœ‰å‡ ç‡ä¸­æ¯’
                if (Math.random() < 0.1) {
                    gameState.health -= 10;
                    addToLog("è¿™äº›æµ†æœæœ‰æ¯’! ä½ æ„Ÿè§‰ä¸èˆ’æœ", "danger");
                }
            }
            // æœ€ååƒç”Ÿè‚‰
            else if (gameState.inventory['meat_raw'] > 0) {
                gameState.inventory['meat_raw']--;
                gameState.hunger = Math.min(gameState.maxHunger, gameState.hunger + 20);
                addToLog("åƒäº†ä¸€äº›ç”Ÿè‚‰ï¼Œé¥¥é¥¿æ„Ÿå‡è½»äº†", "success");
                foodEaten = true;
                
                // ç”Ÿè‚‰æœ‰è¾ƒé«˜å‡ ç‡ä¸­æ¯’
                if (Math.random() < 0.4) {
                    gameState.health -= 15;
                    addToLog("ç”Ÿè‚‰è®©ä½ ç”Ÿç—…äº†!", "danger");
                }
            }
            
            if (foodEaten) {
                playSound('success');
            } else {
                addToLog("ä½ æ²¡æœ‰é£Ÿç‰©å¯ä»¥åƒ", "warning");
                playSound('failure');
            }
        }
        
        // ç”Ÿç«
        function makeFire() {
            gameState.inventory['wood'] -= 3;
            gameState.inventory['stone'] -= 2;
            gameState.fire = true;
            gameState.fireDuration = 120 + Math.floor(Math.random() * 60); // 2-3å°æ—¶
            addToLog("æˆåŠŸç”Ÿèµ·äº†ç«å †ï¼Œå¯ä»¥æä¾›æ¸©æš–å’Œçƒ¹é¥ªé£Ÿç‰©", "success");
            playSound('success');
            
            // å¢åŠ ç”Ÿç«æŠ€èƒ½ç»éªŒ
            addSkillXP('firemaking', 20);
            
            // è§£é”çƒ¤è‚‰é…æ–¹
            if (!gameState.unlockedRecipes.includes('cooked_meat')) {
                gameState.unlockedRecipes.push('cooked_meat');
                addToLog("è§£é”äº†æ–°é…æ–¹: çƒ¤è‚‰", "info");
            }
        }
        
        // æ£€æŸ¥å±é™©
        function checkForDanger(extraChance = 0) {
            const location = locations[gameState.location];
            
            if (location.dangers && location.dangers.length > 0) {
                location.dangers.forEach(dangerId => {
                    const danger = dangers[dangerId];
                    const chance = (danger.chance + extraChance) * weatherTypes[gameState.weather].dangerModifier;
                    
                    if (Math.random() < chance) {
                        // æ£€æŸ¥æ˜¯å¦æœ‰é¿å…å±é™©çš„ç‰©å“
                        let avoided = false;
                        if (danger.avoidItems.length > 0) {
                            danger.avoidItems.forEach(itemId => {
                                if (gameState.inventory[itemId] > 0 && Math.random() < danger.avoidChance) {
                                    avoided = true;
                                    addToLog(`ä½ ä½¿ç”¨${items[itemId].name}é¿å…äº†${danger.name}`, "success");
                                }
                            });
                        }
                        
                        if (!avoided) {
                            // è¿›å…¥æˆ˜æ–—æˆ–å—åˆ°ä¼¤å®³
                            if (danger.health > 0) {
                                startCombat(dangerId);
                            } else {
                                // å—åˆ°ç¯å¢ƒä¼¤å®³
                                gameState.health -= danger.damage;
                                addToLog(`${danger.name}! å—åˆ° ${danger.damage} ç‚¹ä¼¤å®³`, "danger");
                                playSound('danger');
                                
                                // æ¯’æ•ˆæœ
                                if (danger.poison) {
                                    gameState.health -= 5;
                                    addToLog("ä¸­æ¯’äº†! æŒç»­å—åˆ°ä¼¤å®³", "danger");
                                }
                                
                                // è·å¾—æˆ˜åˆ©å“
                                if (Object.keys(danger.loot).length > 0) {
                                    Object.entries(danger.loot).forEach(([itemId, amount]) => {
                                        addItem(itemId, amount);
                                        addToLog(`ä»${danger.name}è·å¾—äº† ${amount} ä¸ª${items[itemId].name}`, "info");
                                    });
                                }
                            }
                        }
                    }
                });
            }
        }
        
        // å¼€å§‹æˆ˜æ–—
        function startCombat(enemyId) {
            gameState.inCombat = true;
            gameState.enemy = {
                id: enemyId,
                ...dangers[enemyId],
                currentHealth: dangers[enemyId].health
            };
            
            // æš‚åœå½“å‰è¡ŒåŠ¨
            if (gameState.currentAction) {
                clearInterval(gameState.actionInterval);
                gameState.currentAction = null;
            }
            
            // æ›´æ–°æˆ˜æ–—UI
            elements.enemyName.textContent = gameState.enemy.name;
            elements.enemyHealthFill.style.width = '100%';
            elements.combatMessage.textContent = `${gameState.enemy.name}å‘ä½ æ‰‘æ¥!`;
            
            // æ˜¾ç¤ºæˆ˜æ–—é¢æ¿
            elements.combatPanel.style.display = 'flex';
            
            addToLog(`é­é‡äº†${gameState.enemy.name}!`, "danger");
            playSound('danger');
        }
        
        // æˆ˜æ–—æ”»å‡»
        function combatAttack() {
            if (!gameState.inCombat) return;
            
            // è®¡ç®—ç©å®¶ä¼¤å®³
            let playerDamage = 10 + Math.floor(Math.random() * 10);
            
            // æ­¦å™¨åŠ æˆ
            if (gameState.inventory['spear']) {
                playerDamage += 15;
            } else if (gameState.inventory['bow']) {
                playerDamage += 10;
            }
            
            // æˆ˜æ–—æŠ€èƒ½åŠ æˆ
            playerDamage += gameState.skills.combat.level * 2;
            
            // åº”ç”¨ä¼¤å®³
            gameState.enemy.currentHealth -= playerDamage;
            
            // æ›´æ–°æ•Œäººç”Ÿå‘½å€¼
            const healthPercent = (gameState.enemy.currentHealth / gameState.enemy.health) * 100;
            elements.enemyHealthFill.style.width = `${healthPercent}%`;
            
            elements.combatMessage.textContent = `ä½ å¯¹${gameState.enemy.name}é€ æˆäº†${playerDamage}ç‚¹ä¼¤å®³!`;
            playSound('combat');
            
            // å¢åŠ æˆ˜æ–—ç»éªŒ
            addSkillXP('combat', 10);
            
            // æ£€æŸ¥æ•Œäººæ˜¯å¦è¢«å‡»è´¥
            if (gameState.enemy.currentHealth <= 0) {
                endCombat(true);
                return;
            }
            
            // æ•Œäººåå‡»
            setTimeout(() => {
                enemyAttack();
            }, 1000);
        }
        
        // æ•Œäººæ”»å‡»
        function enemyAttack() {
            if (!gameState.inCombat) return;
            
            // è®¡ç®—ä¼¤å®³
            let damage = gameState.enemy.damage;
            
            // é˜²å¾¡å‡å…
            if (gameState.inventory['armor']) {
                damage = Math.max(5, damage - 10);
            }
            
            // åº”ç”¨ä¼¤å®³
            gameState.health -= damage;
            
            elements.combatMessage.textContent = `${gameState.enemy.name}å¯¹ä½ é€ æˆäº†${damage}ç‚¹ä¼¤å®³!`;
            playSound('combat');
            
            // æ£€æŸ¥ç©å®¶æ˜¯å¦æ­»äº¡
            if (gameState.health <= 0) {
                gameOver();
                return;
            }
            
            // æ›´æ–°UI
            updateUI();
        }
        
        // æˆ˜æ–—é˜²å¾¡
        function combatDefend() {
            if (!gameState.inCombat) return;
            
            // é˜²å¾¡å‡å°‘ä¼¤å®³
            elements.combatMessage.textContent = `ä½ é‡‡å–äº†é˜²å¾¡å§¿æ€ï¼Œå‡†å¤‡æŠµæŒ¡${gameState.enemy.name}çš„æ”»å‡»`;
            
            // æ•Œäººæ”»å‡»
            setTimeout(() => {
                let damage = Math.max(5, gameState.enemy.damage - 15);
                gameState.health -= damage;
                
                elements.combatMessage.textContent = `ä½ é˜²å¾¡äº†${gameState.enemy.name}çš„æ”»å‡»ï¼Œåªå—åˆ°${damage}ç‚¹ä¼¤å®³`;
                playSound('combat');
                
                // å¢åŠ é˜²å¾¡ç»éªŒ
                addSkillXP('combat', 5);
                
                // æ£€æŸ¥ç©å®¶æ˜¯å¦æ­»äº¡
                if (gameState.health <= 0) {
                    gameOver();
                    return;
                }
                
                updateUI();
            }, 1000);
        }
        
        // æˆ˜æ–—ä¸­ä½¿ç”¨ç‰©å“
        function combatUseItem() {
            if (!gameState.inCombat) return;
            
            elements.combatMessage.textContent = "é€‰æ‹©è¦ä½¿ç”¨çš„ç‰©å“";
            
            // æ˜¾ç¤ºå¯ç”¨ç‰©å“
            const usableItems = Object.keys(gameState.inventory).filter(itemId => 
                items[itemId].actions.includes('use') || 
                items[itemId].actions.includes('heal')
            );
            
            if (usableItems.length === 0) {
                elements.combatMessage.textContent = "ä½ æ²¡æœ‰å¯ç”¨çš„ç‰©å“";
                return;
            }
            
            // åˆ›å»ºç‰©å“èœå•
            elements.itemMenu.innerHTML = '';
            usableItems.forEach(itemId => {
                const button = document.createElement('button');
                button.textContent = `ä½¿ç”¨ ${items[itemId].name}`;
                button.addEventListener('click', () => {
                    useItem(itemId, items[itemId].actions.includes('use') ? 'use' : 'heal');
                    elements.itemMenu.style.display = 'none';
                    
                    // æ•Œäººä»ç„¶ä¼šæ”»å‡»
                    setTimeout(() => {
                        enemyAttack();
                    }, 1000);
                });
                elements.itemMenu.appendChild(button);
            });
            
            elements.itemMenu.style.display = 'block';
            elements.itemMenu.style.left = '50%';
            elements.itemMenu.style.top = '50%';
            elements.itemMenu.style.transform = 'translate(-50%, -50%)';
        }
        
        // é€ƒè·‘
        function combatFlee() {
            if (!gameState.inCombat) return;
            
            // é€ƒè·‘æˆåŠŸç‡
            const fleeChance = 0.5 + (gameState.skills.combat.level * 0.05);
            
            if (Math.random() < fleeChance) {
                elements.combatMessage.textContent = `ä½ æˆåŠŸä»${gameState.enemy.name}èº«è¾¹é€ƒèµ°äº†`;
                playSound('success');
                
                // ç»“æŸæˆ˜æ–—
                setTimeout(() => {
                    endCombat(false);
                }, 1000);
            } else {
                elements.combatMessage.textContent = `é€ƒè·‘å¤±è´¥! ${gameState.enemy.name}è¿½ä¸Šäº†ä½ `;
                playSound('failure');
                
                // æ•Œäººæ”»å‡»
                setTimeout(() => {
                    enemyAttack();
                }, 1000);
            }
        }
        
        // ç»“æŸæˆ˜æ–—
        function endCombat(victory) {
            gameState.inCombat = false;
            elements.combatPanel.style.display = 'none';
            
            if (victory) {
                addToLog(`ä½ å‡»è´¥äº†${gameState.enemy.name}!`, "success");
                playSound('success');
                gameState.stats.enemiesDefeated++;
                
                // è·å¾—æˆ˜åˆ©å“
                const loot = dangers[gameState.enemy.id].loot;
                if (Object.keys(loot).length > 0) {
                    Object.entries(loot).forEach(([itemId, amount]) => {
                        addItem(itemId, amount);
                        addToLog(`è·å¾—äº† ${amount} ä¸ª${items[itemId].name}`, "info");
                    });
                }
            }
            
            gameState.enemy = null;
            updateUI(); // ç¡®ä¿UIæ›´æ–°
        }
        
        // è·å–éšæœºèµ„æº
        function getRandomResource() {
            const location = locations[gameState.location];
            return location.resources[Math.floor(Math.random() * location.resources.length)];
        }
        
        // æ·»åŠ ç‰©å“åˆ°åº“å­˜
        function addItem(itemId, amount = 1) {
            if (!gameState.inventory[itemId]) {
                gameState.inventory[itemId] = 0;
            }
            
            // æ£€æŸ¥åº“å­˜ç©ºé—´
            const currentWeight = getInventoryWeight();
            const itemWeight = items[itemId].weight * amount;
            
            if (currentWeight + itemWeight > gameState.inventoryMax) {
                addToLog("åº“å­˜å·²æ»¡ï¼Œæ— æ³•æºå¸¦æ›´å¤šç‰©å“", "warning");
                return false;
            }
            
            gameState.inventory[itemId] += amount;
            
            // æ›´æ–°é‡‡é›†æœ¨æä»»åŠ¡è¿›åº¦
            if (itemId === 'wood' && gameState.quests.daily.gatherWood && !gameState.quests.daily.gatherWood.completed) {
                gameState.quests.daily.gatherWood.progress += amount;
                renderQuests();
            }
            
            renderInventory();
            return true;
        }
        
        // ä»åº“å­˜ç§»é™¤ç‰©å“
        function removeItem(itemId, amount = 1) {
            if (!gameState.inventory[itemId] || gameState.inventory[itemId] < amount) {
                return false;
            }
            
            gameState.inventory[itemId] -= amount;
            
            if (gameState.inventory[itemId] <= 0) {
                delete gameState.inventory[itemId];
            }
            
            renderInventory();
            return true;
        }
        
        // è®¡ç®—åº“å­˜æ€»é‡é‡
        function getInventoryWeight() {
            let total = 0;
            Object.entries(gameState.inventory).forEach(([itemId, count]) => {
                total += items[itemId].weight * count;
            });
            return total;
        }
        
        // åˆ¶ä½œç‰©å“
        function craftItem(recipeId) {
            const recipe = recipes[recipeId];
            
            // æ£€æŸ¥ææ–™
            for (const [itemId, amount] of Object.entries(recipe.ingredients)) {
                if (!gameState.inventory[itemId] || gameState.inventory[itemId] < amount) {
                    addToLog(`åˆ¶ä½œéœ€è¦ ${amount} ä¸ª${items[itemId].name}`, "warning");
                    playSound('failure');
                    return;
                }
            }
            
            // æ£€æŸ¥ç«å †éœ€æ±‚
            if (recipe.requiresFire && !gameState.fire) {
                addToLog("åˆ¶ä½œè¿™ä¸ªç‰©å“éœ€è¦ç”Ÿç«", "warning");
                playSound('failure');
                return;
            }
            
            // æ£€æŸ¥å·¥ä½œå°éœ€æ±‚
            if (recipe.skill === 'crafting' && gameState.workbenchLevel < (recipe.unlockLevel - 1)) {
                addToLog("éœ€è¦æ›´é«˜çº§çš„å·¥ä½œå°æ¥åˆ¶ä½œè¿™ä¸ªç‰©å“", "warning");
                playSound('failure');
                return;
            }
            
            // æ¶ˆè€—ææ–™
            for (const [itemId, amount] of Object.entries(recipe.ingredients)) {
                removeItem(itemId, amount);
            }
            
            // å¼€å§‹åˆ¶ä½œ
            gameState.currentAction = 'craft';
            gameState.craftingRecipe = recipeId;
            gameState.actionDifficulty = recipe.time;
            gameState.actionProgress = 0;
            elements.actionProgressFill.style.width = '0%';
            
            addToLog(`å¼€å§‹åˆ¶ä½œ ${recipe.name}...`, "info");
            
            // åˆ¶ä½œè®¡æ—¶å™¨
            gameState.actionInterval = setInterval(() => {
                gameState.actionProgress++;
                elements.actionProgressFill.style.width = `${(gameState.actionProgress / gameState.actionDifficulty) * 100}%`;
                
                // æ¶ˆè€—ç²¾åŠ›
                gameState.energy = Math.max(0, gameState.energy - 0.5);
                
                // åˆ¶ä½œå®Œæˆ
                if (gameState.actionProgress >= gameState.actionDifficulty) {
                    clearInterval(gameState.actionInterval);
                    elements.actionProgressFill.style.width = '0%';
                    
                    // è·å–åˆ¶ä½œç»“æœ
                    let resultItem = null;
                    
                    switch (recipeId) {
                        case 'bandage':
                            resultItem = 'bandage';
                            break;
                        case 'spear':
                            resultItem = 'spear';
                            break;
                        case 'rope':
                            resultItem = 'rope';
                            break;
                        case 'cooked_meat':
                            resultItem = 'meat_cooked';
                            break;
                        case 'fishing_rod':
                            resultItem = 'fishing_rod';
                            break;
                        case 'trap':
                            resultItem = 'trap';
                            break;
                        case 'bow':
                            resultItem = 'bow';
                            break;
                        case 'arrow':
                            resultItem = 'arrow';
                            break;
                        case 'medicine':
                            resultItem = 'medicine';
                            break;
                        case 'armor':
                            resultItem = 'armor';
                            break;
                    }
                    
                    if (resultItem) {
                        if (addItem(resultItem, 1)) {
                            addToLog(`æˆåŠŸåˆ¶ä½œäº†1ä¸ª${items[resultItem].name}`, "success");
                            gameState.stats.itemsCrafted++;
                            playSound('success');
                            
                            // æ£€æŸ¥æ˜¯å¦å®Œæˆå»ºé€ åº‡æŠ¤æ‰€ä»»åŠ¡
                            if (recipeId === 'shelter' && gameState.quests.main.buildShelter && !gameState.quests.main.buildShelter.completed) {
                                gameState.quests.main.buildShelter.completed = true;
                                addToLog("å®Œæˆäº†ä¸»çº¿ä»»åŠ¡: å»ºé€ åº‡æŠ¤æ‰€!", "success");
                                addToLog("å¥–åŠ±: è§£é”åŸºåœ°åŠŸèƒ½", "info");
                                renderQuests();
                            }
                        }
                    } else if (recipeId === 'shelter') {
                        gameState.shelterLevel++;
                        addToLog("æˆåŠŸå»ºé€ äº†åº‡æŠ¤æ‰€ï¼Œç°åœ¨å¯ä»¥æ›´å¥½åœ°ä¼‘æ¯äº†", "success");
                        playSound('success');
                        
                        // æ£€æŸ¥æ˜¯å¦å®Œæˆå»ºé€ åº‡æŠ¤æ‰€ä»»åŠ¡
                        if (gameState.quests.main.buildShelter && !gameState.quests.main.buildShelter.completed) {
                            gameState.quests.main.buildShelter.completed = true;
                            addToLog("å®Œæˆäº†ä¸»çº¿ä»»åŠ¡: å»ºé€ åº‡æŠ¤æ‰€!", "success");
                            addToLog("å¥–åŠ±: è§£é”åŸºåœ°åŠŸèƒ½", "info");
                            renderQuests();
                        }
                    } else if (recipeId === 'fire') {
                        makeFire();
                    }
                    
                    gameState.currentAction = null;
                    
                    // å¢åŠ åˆ¶ä½œæŠ€èƒ½ç»éªŒ
                    if (recipe.skill) {
                        addSkillXP(recipe.skill, 15);
                    }
                }
            }, 1000);
        }
        
        // åˆ‡æ¢åˆ¶ä½œåˆ—è¡¨æ˜¾ç¤º
        function toggleCraftingList() {
            if (elements.craftingList.style.display === 'flex') {
                elements.craftingList.style.display = 'none';
                elements.craftingBtn.innerHTML = 'åˆ¶ä½œç‰©å“ â–¼';
            } else {
                renderCraftingList();
                elements.craftingList.style.display = 'flex';
                elements.craftingBtn.innerHTML = 'åˆ¶ä½œç‰©å“ â–²';
            }
            playSound('click');
        }
        
        // æ¸²æŸ“åˆ¶ä½œåˆ—è¡¨
        function renderCraftingList() {
            elements.craftingList.innerHTML = '';
            
            gameState.unlockedRecipes.forEach(recipeId => {
                const recipe = recipes[recipeId];
                const item = document.createElement('div');
                item.className = 'craft-item';
                item.innerHTML = `<strong>${recipe.name}</strong><br><small>${recipe.description}</small>`;
                
                // æ˜¾ç¤ºæ‰€éœ€ææ–™
                let materials = '';
                for (const [itemId, amount] of Object.entries(recipe.ingredients)) {
                    materials += `${amount}${items[itemId].emoji} `;
                }
                
                item.innerHTML += `<br><small>éœ€è¦: ${materials}</small>`;
                
                // æ£€æŸ¥æ˜¯å¦æ»¡è¶³ææ–™
                let canCraft = true;
                for (const [itemId, amount] of Object.entries(recipe.ingredients)) {
                    if (!gameState.inventory[itemId] || gameState.inventory[itemId] < amount) {
                        canCraft = false;
                        item.style.opacity = '0.6';
                    }
                }
                
                if (canCraft) {
                    item.addEventListener('click', () => craftItem(recipeId));
                }
                
                elements.craftingList.appendChild(item);
            });
        }
        
        // æ¸²æŸ“ç‰©å“æ 
        function renderInventory() {
            elements.inventory.innerHTML = '';
            
            Object.entries(gameState.inventory).forEach(([itemId, count]) => {
                const item = document.createElement('div');
                item.className = 'item';
                item.dataset.itemId = itemId;
                item.innerHTML = `${items[itemId].emoji} ${items[itemId].name} <span class="item-count">${count}</span>`;
                
                // æ˜¾ç¤ºè€ä¹…åº¦
                if (items[itemId].durability) {
                    item.innerHTML += ` <small>(${items[itemId].durability})</small>`;
                }
                
                // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                item.addEventListener('click', (e) => {
                    e.stopPropagation();
                    showItemMenu(itemId, e);
                });
                
                elements.inventory.appendChild(item);
            });
            
            elements.inventoryCount.textContent = Math.floor(getInventoryWeight());
            elements.inventoryMax.textContent = gameState.inventoryMax;
        }
        
        // æ˜¾ç¤ºç‰©å“èœå•
        function showItemMenu(itemId, event) {
            selectedItem = itemId;
            const item = items[itemId];
            
            // æ¸…ç©ºèœå•
            elements.itemMenu.innerHTML = '';
            
            // æ·»åŠ å¯ç”¨æ“ä½œ
            item.actions.forEach(action => {
                const button = document.createElement('button');
                
                switch (action) {
                    case 'eat':
                        button.textContent = 'é£Ÿç”¨';
                        button.addEventListener('click', () => useItem(itemId, 'eat'));
                        break;
                    case 'drink':
                        button.textContent = 'é¥®ç”¨';
                        button.addEventListener('click', () => useItem(itemId, 'drink'));
                        break;
                    case 'use':
                        button.textContent = 'ä½¿ç”¨';
                        button.addEventListener('click', () => useItem(itemId, 'use'));
                        break;
                    case 'heal':
                        button.textContent = 'æ²»ç–—';
                        button.addEventListener('click', () => useItem(itemId, 'heal'));
                        break;
                    case 'craft':
                        button.textContent = 'åˆ¶ä½œ';
                        button.addEventListener('click', () => useItem(itemId, 'craft'));
                        break;
                    case 'burn':
                        button.textContent = 'ç‡ƒçƒ§';
                        button.addEventListener('click', () => useItem(itemId, 'burn'));
                        break;
                    case 'equip':
                        button.textContent = 'è£…å¤‡';
                        button.addEventListener('click', () => useItem(itemId, 'equip'));
                        break;
                    case 'cook':
                        button.textContent = 'çƒ¹é¥ª';
                        button.addEventListener('click', () => useItem(itemId, 'cook'));
                        break;
                    case 'build':
                        button.textContent = 'å»ºé€ ';
                        button.addEventListener('click', () => useItem(itemId, 'build'));
                        break;
                }
                
                elements.itemMenu.appendChild(button);
            });
            
            // æ·»åŠ ä¸¢å¼ƒé€‰é¡¹
            const discardBtn = document.createElement('button');
            discardBtn.textContent = 'ä¸¢å¼ƒ';
            discardBtn.addEventListener('click', () => {
                removeItem(itemId, 1);
                addToLog(`ä¸¢å¼ƒäº†1ä¸ª${item.name}`, "info");
                elements.itemMenu.style.display = 'none';
                playSound('click');
            });
            elements.itemMenu.appendChild(discardBtn);
            
            // æ˜¾ç¤ºèœå•
            elements.itemMenu.style.display = 'block';
            elements.itemMenu.style.left = `${event.pageX}px`;
            elements.itemMenu.style.top = `${event.pageY}px`;
            
            playSound('click');
        }
        
        // ä½¿ç”¨ç‰©å“
        function useItem(itemId, action) {
            const item = items[itemId];
            elements.itemMenu.style.display = 'none';
            
            switch (action) {
                case 'eat':
                    if (itemId === 'berries' || itemId === 'meat_raw' || itemId === 'meat_cooked') {
                        removeItem(itemId, 1);
                        
                        if (itemId === 'berries') {
                            gameState.hunger = Math.min(gameState.maxHunger, gameState.hunger + 15);
                            addToLog("åƒäº†ä¸€äº›æµ†æœï¼Œé¥¥é¥¿æ„Ÿå‡è½»äº†", "success");
                            
                            // æµ†æœæœ‰å‡ ç‡ä¸­æ¯’
                            if (Math.random() < 0.1) {
                                gameState.health -= 10;
                                addToLog("è¿™äº›æµ†æœæœ‰æ¯’! ä½ æ„Ÿè§‰ä¸èˆ’æœ", "danger");
                            }
                        } else if (itemId === 'meat_raw') {
                            gameState.hunger = Math.min(gameState.maxHunger, gameState.hunger + 20);
                            addToLog("åƒäº†ä¸€äº›ç”Ÿè‚‰ï¼Œé¥¥é¥¿æ„Ÿå‡è½»äº†", "success");
                            
                            // ç”Ÿè‚‰æœ‰è¾ƒé«˜å‡ ç‡ä¸­æ¯’
                            if (Math.random() < 0.4) {
                                gameState.health -= 15;
                                addToLog("ç”Ÿè‚‰è®©ä½ ç”Ÿç—…äº†!", "danger");
                            }
                        } else if (itemId === 'meat_cooked') {
                            gameState.hunger = Math.min(gameState.maxHunger, gameState.hunger + 40);
                            addToLog("åƒäº†ä¸€äº›ç†Ÿè‚‰ï¼Œé¥¥é¥¿æ„Ÿå¤§å¤§å‡è½»", "success");
                        }
                        
                        playSound('success');
                    }
                    break;
                    
                case 'drink':
                    if (itemId === 'water') {
                        removeItem(itemId, 1);
                        gameState.thirst = Math.min(gameState.maxThirst, gameState.thirst + 30);
                        addToLog("å–äº†ä¸€äº›æ°´ï¼Œå£æ¸´æ„Ÿå‡è½»äº†", "success");
                        
                        // æœ‰å‡ ç‡æ¢å¤å°‘é‡å¥åº·
                        if (Math.random() < 0.3) {
                            gameState.health = Math.min(gameState.maxHealth, gameState.health + 5);
                            addToLog("å¹²å‡€çš„æ°´è®©ä½ æ„Ÿè§‰å¥½ä¸€äº›äº†", "info");
                        }
                        
                        playSound('success');
                    }
                    break;
                    
                case 'use':
                    if (itemId === 'bandage') {
                        removeItem(itemId, 1);
                        gameState.health = Math.min(gameState.maxHealth, gameState.health + 20);
                        addToLog("ä½¿ç”¨äº†ç»·å¸¦ï¼Œæ¢å¤äº†ä¸€äº›å¥åº·", "success");
                        playSound('success');
                    } else if (itemId === 'medicine') {
                        removeItem(itemId, 1);
                        gameState.health = Math.min(gameState.maxHealth, gameState.health + 30);
                        addToLog("ä½¿ç”¨äº†è¯è†ï¼Œæ„Ÿè§‰å¥½å¤šäº†", "success");
                        playSound('success');
                    } else if (itemId === 'trap') {
                        if (gameState.currentAction) {
                            addToLog("ä½ å·²ç»åœ¨è¿›è¡Œä¸€ä¸ªè¡ŒåŠ¨äº†", "warning");
                            return;
                        }
                        
                        // è®¾ç½®é™·é˜±
                        gameState.currentAction = 'set_trap';
                        gameState.actionDifficulty = 3;
                        gameState.actionProgress = 0;
                        elements.actionProgressFill.style.width = '0%';
                        
                        addToLog("å¼€å§‹è®¾ç½®é™·é˜±...", "info");
                        
                        // è®¾ç½®é™·é˜±è®¡æ—¶å™¨
                        gameState.actionInterval = setInterval(() => {
                            gameState.actionProgress++;
                            elements.actionProgressFill.style.width = `${(gameState.actionProgress / gameState.actionDifficulty) * 100}%`;
                            
                            // æ¶ˆè€—ç²¾åŠ›
                            gameState.energy = Math.max(0, gameState.energy - 0.5);
                            
                            // é™·é˜±è®¾ç½®å®Œæˆ
                            if (gameState.actionProgress >= gameState.actionDifficulty) {
                                clearInterval(gameState.actionInterval);
                                elements.actionProgressFill.style.width = '0%';
                                
                                removeItem(itemId, 1);
                                addToLog("é™·é˜±è®¾ç½®å®Œæˆï¼Œæ˜å¤©æ£€æŸ¥æ˜¯å¦æœ‰æ”¶è·", "success");
                                gameState.currentAction = null;
                                
                                // å¢åŠ é™·é˜±æŠ€èƒ½ç»éªŒ
                                addSkillXP('hunting', 10);
                                
                                // ç¬¬äºŒå¤©æœ‰å‡ ç‡æ•è·åŠ¨ç‰©
                                setTimeout(() => {
                                    if (Math.random() < 0.7) {
                                        const loot = Math.random() < 0.5 ? 
                                            { 'meat_raw': 1 } : { 'fur': 1 };
                                        
                                        const itemId = Object.keys(loot)[0];
                                        const amount = loot[itemId];
                                        addItem(itemId, amount);
                                        addToLog(`é™·é˜±æ•è·äº†çŒç‰©! è·å¾—äº† ${amount} ä¸ª${items[itemId].name}`, "success");
                                    } else {
                                        addToLog("é™·é˜±æ²¡æœ‰æ•è·ä»»ä½•çŒç‰©", "info");
                                    }
                                }, 30000); // 30ç§’åæ£€æŸ¥
                                
                                playSound('success');
                            }
                        }, 1000);
                    }
                    break;
                    
                case 'heal':
                    if (itemId === 'herbs') {
                        removeItem(itemId, 1);
                        gameState.health = Math.min(gameState.maxHealth, gameState.health + 10);
                        addToLog("ä½¿ç”¨äº†è‰è¯ï¼Œæ„Ÿè§‰å¥½ä¸€äº›äº†", "success");
                        playSound('success');
                    }
                    break;
                    
                case 'craft':
                    toggleCraftingList();
                    addToLog(`é€‰æ‹©è¦ä½¿ç”¨${item.name}åˆ¶ä½œçš„ç‰©å“`, "info");
                    break;
                    
                case 'burn':
                    if (itemId === 'wood' || itemId === 'coal') {
                        if (!gameState.fire) {
                            if (gameState.inventory['wood'] >= 3 && gameState.inventory['stone'] >= 2) {
                                startAction('fire');
                            } else {
                                addToLog("ç”Ÿç«éœ€è¦3ä¸ªæœ¨æå’Œ2ä¸ªçŸ³å¤´", "warning");
                            }
                        } else {
                            addToLog("ç«å·²ç»ç‡ƒç€äº†", "info");
                        }
                    }
                    break;
                    
                case 'equip':
                    addToLog(`è£…å¤‡äº†${item.name}`, "success");
                    playSound('success');
                    break;
                    
                case 'cook':
                    if (itemId === 'meat_raw' && gameState.fire) {
                        if (gameState.currentAction) {
                            addToLog("ä½ å·²ç»åœ¨è¿›è¡Œä¸€ä¸ªè¡ŒåŠ¨äº†", "warning");
                            return;
                        }
                        
                        gameState.currentAction = 'cook';
                        gameState.cookingItem = itemId;
                        gameState.actionDifficulty = 3;
                        gameState.actionProgress = 0;
                        elements.actionProgressFill.style.width = '0%';
                        
                        addToLog("å¼€å§‹çƒ¹é¥ªç”Ÿè‚‰...", "info");
                        
                        // çƒ¹é¥ªè®¡æ—¶å™¨
                        gameState.actionInterval = setInterval(() => {
                            gameState.actionProgress++;
                            elements.actionProgressFill.style.width = `${(gameState.actionProgress / gameState.actionDifficulty) * 100}%`;
                            
                            // æ¶ˆè€—ç²¾åŠ›
                            gameState.energy = Math.max(0, gameState.energy - 0.5);
                            
                            // çƒ¹é¥ªå®Œæˆ
                            if (gameState.actionProgress >= gameState.actionDifficulty) {
                                clearInterval(gameState.actionInterval);
                                elements.actionProgressFill.style.width = '0%';
                                
                                removeItem(itemId, 1);
                                addItem('meat_cooked', 1);
                                addToLog("æˆåŠŸçƒ¹é¥ªäº†1ä¸ªç†Ÿè‚‰", "success");
                                gameState.currentAction = null;
                                
                                // å¢åŠ çƒ¹é¥ªæŠ€èƒ½ç»éªŒ
                                addSkillXP('cooking', 10);
                                
                                playSound('success');
                            }
                        }, 1000);
                    } else if (!gameState.fire) {
                        addToLog("éœ€è¦ç”Ÿç«æ‰èƒ½çƒ¹é¥ªé£Ÿç‰©", "warning");
                    }
                    break;
                    
                case 'build':
                    toggleCraftingList();
                    addToLog("é€‰æ‹©è¦å»ºé€ çš„ç‰©å“", "info");
                    break;
            }
        }
        
        // æ˜¾ç¤ºåœ°å›¾
        function showMap() {
            renderMap();
            elements.mapPanel.style.display = 'flex';
            playSound('click');
        }
        
        // éšè—åœ°å›¾
        function hideMap() {
            elements.mapPanel.style.display = 'none';
            playSound('click');
        }
        
        // æ¸²æŸ“åœ°å›¾
        function renderMap() {
            elements.mapContent.innerHTML = '';
            
            Object.entries(locations).forEach(([id, location]) => {
                const locationElement = document.createElement('div');
                locationElement.className = 'map-location';
                
                if (gameState.discoveredLocations.includes(id)) {
                    locationElement.classList.add('discovered');
                    
                    if (gameState.location === id) {
                        locationElement.classList.add('current');
                    }
                    
                    locationElement.innerHTML = `
                        <div class="map-location-image" style="background-image: url('${location.image}')"></div>
                        <div>${location.name}</div>
                    `;
                    
                    locationElement.addEventListener('click', () => {
                        if (gameState.location !== id) {
                            gameState.location = id;
                            updateLocationImage();
                            addToLog(`ç§»åŠ¨åˆ°äº†${location.name}`, "info");
                            hideMap();
                        }
                    });
                } else {
                    locationElement.innerHTML = `
                        <div class="map-location-image" style="background-color: #333;"></div>
                        <div>æœªæ¢ç´¢åŒºåŸŸ</div>
                    `;
                }
                
                elements.mapContent.appendChild(locationElement);
            });
        }
        
        // æ˜¾ç¤ºæŠ€èƒ½é¢æ¿
        function showSkills() {
            renderSkills();
            elements.skillsPanel.style.display = 'flex';
            playSound('click');
        }
        
        // éšè—æŠ€èƒ½é¢æ¿
        function hideSkills() {
            elements.skillsPanel.style.display = 'none';
            playSound('click');
        }
        
        // æ¸²æŸ“æŠ€èƒ½
        function renderSkills() {
            for (const skill in gameState.skills) {
                const levelElement = document.getElementById(`${skill}-level`);
                const progressElement = document.getElementById(`${skill}-progress`);
                
                if (levelElement && progressElement) {
                    levelElement.textContent = gameState.skills[skill].level;
                    const progressPercent = (gameState.skills[skill].xp / gameState.skills[skill].xpToNext) * 100;
                    progressElement.style.width = `${progressPercent}%`;
                }
            }
        }
        
        // å¢åŠ æŠ€èƒ½ç»éªŒ
        function addSkillXP(skill, xp) {
            if (!gameState.skills[skill]) return;
            
            gameState.skills[skill].xp += xp;
            
            // æ£€æŸ¥æ˜¯å¦å‡çº§
            while (gameState.skills[skill].xp >= gameState.skills[skill].xpToNext) {
                gameState.skills[skill].xp -= gameState.skills[skill].xpToNext;
                gameState.skills[skill].level++;
                gameState.skills[skill].xpToNext = Math.floor(gameState.skills[skill].xpToNext * 1.2);
                
                addToLog(`${getSkillName(skill)}æŠ€èƒ½æå‡åˆ°${gameState.skills[skill].level}çº§!`, "success");
                showNotification(`${getSkillName(skill)}å‡çº§!`);
            }
            
            // æ›´æ–°æŠ€èƒ½æ˜¾ç¤º
            renderSkills();
        }
        
        // è·å–æŠ€èƒ½åç§°
        function getSkillName(skill) {
            const names = {
                woodcutting: 'æœ¨æé‡‡é›†',
                mining: 'é‡‡çŸ¿',
                hunting: 'ç‹©çŒ',
                combat: 'æˆ˜æ–—',
                firemaking: 'ç”Ÿç«',
                cooking: 'çƒ¹é¥ª'
            };
            
            return names[skill] || skill;
        }
        
        // æ˜¾ç¤ºä»»åŠ¡é¢æ¿
        function showQuests() {
            renderQuests();
            elements.questsPanel.style.display = 'flex';
            playSound('click');
        }
        
        // éšè—ä»»åŠ¡é¢æ¿
        function hideQuests() {
            elements.questsPanel.style.display = 'none';
            playSound('click');
        }
        
        // æ¸²æŸ“ä»»åŠ¡
        function renderQuests() {
            // æ¯æ—¥ä»»åŠ¡
            const dailyQuest1 = document.getElementById('daily-quest-1');
            if (dailyQuest1) {
                const quest = gameState.quests.daily.gatherWood;
                dailyQuest1.querySelector('.quest-progress').textContent = 
                    `${quest.progress}/${quest.target}`;
                
                if (quest.progress >= quest.target && !quest.completed) {
                    dailyQuest1.classList.add('success');
                }
            }
            
            const dailyQuest2 = document.getElementById('daily-quest-2');
            if (dailyQuest2) {
                const quest = gameState.quests.daily.huntAnimals;
                dailyQuest2.querySelector('.quest-progress').textContent = 
                    `${quest.progress}/${quest.target}`;
                
                if (quest.progress >= quest.target && !quest.completed) {
                    dailyQuest2.classList.add('success');
                }
            }
            
            // ä¸»çº¿ä»»åŠ¡
            const mainQuest1 = document.getElementById('main-quest-1');
            if (mainQuest1) {
                const quest = gameState.quests.main.buildShelter;
                mainQuest1.querySelector('.quest-progress').textContent = 
                    quest.completed ? 'å·²å®Œæˆ' : 'æœªå®Œæˆ';
                
                if (quest.completed) {
                    mainQuest1.classList.add('success');
                }
            }
        }
        
        // æ£€æŸ¥ä»»åŠ¡å®Œæˆæƒ…å†µ
        function checkQuests() {
            // æ¯æ—¥ä»»åŠ¡ - æ”¶é›†æœ¨æ
            if (gameState.quests.daily.gatherWood && 
                !gameState.quests.daily.gatherWood.completed && 
                gameState.quests.daily.gatherWood.progress >= gameState.quests.daily.gatherWood.target) {
                
                gameState.quests.daily.gatherWood.completed = true;
                addItem('berries', 5);
                addToLog("å®Œæˆäº†æ¯æ—¥ä»»åŠ¡: æ”¶é›†æœ¨æ! è·å¾—äº†5ä¸ªæµ†æœ", "success");
                renderQuests();
            }
            
            // æ¯æ—¥ä»»åŠ¡ - ç‹©çŒåŠ¨ç‰©
            if (gameState.quests.daily.huntAnimals && 
                !gameState.quests.daily.huntAnimals.completed && 
                gameState.quests.daily.huntAnimals.progress >= gameState.quests.daily.huntAnimals.target) {
                
                gameState.quests.daily.huntAnimals.completed = true;
                addItem('leather', 2);
                addToLog("å®Œæˆäº†æ¯æ—¥ä»»åŠ¡: ç‹©çŒåŠ¨ç‰©! è·å¾—äº†2ä¸ªçš®é©", "success");
                renderQuests();
            }
        }
        
        // é‡ç½®æ¯æ—¥ä»»åŠ¡
        function resetDailyQuests() {
            gameState.quests.daily.gatherWood = { target: 10, progress: 0, completed: false };
            gameState.quests.daily.huntAnimals = { target: 3, progress: 0, completed: false };
            renderQuests();
            addToLog("æ–°çš„æ¯æ—¥ä»»åŠ¡å·²åˆ·æ–°", "info");
        }
        
        // æ˜¾ç¤ºåŸºåœ°é¢æ¿
        function showBase() {
            if (!gameState.quests.main.buildShelter.completed) {
                addToLog("ä½ éœ€è¦å…ˆå»ºé€ ä¸€ä¸ªåº‡æŠ¤æ‰€æ¥è§£é”åŸºåœ°åŠŸèƒ½", "warning");
                return;
            }
            
            renderBase();
            elements.basePanel.style.display = 'flex';
            playSound('click');
        }
        
        // éšè—åŸºåœ°é¢æ¿
        function hideBase() {
            elements.basePanel.style.display = 'none';
            playSound('click');
        }
        
        // æ¸²æŸ“åŸºåœ°
        function renderBase() {
            document.getElementById('shelter-level').textContent = gameState.shelterLevel;
            document.getElementById('storage-level').textContent = gameState.storageLevel;
            document.getElementById('workbench-level').textContent = gameState.workbenchLevel;
            
            // æ›´æ–°å‡çº§æŒ‰é’®çŠ¶æ€
            const shelterBtn = document.getElementById('upgrade-shelter-btn');
            const storageBtn = document.getElementById('upgrade-storage-btn');
            const workbenchBtn = document.getElementById('upgrade-workbench-btn');
            
            shelterBtn.disabled = !(gameState.inventory['wood'] >= 20 && gameState.inventory['rope'] >= 5);
            storageBtn.disabled = !(gameState.inventory['wood'] >= 15 && gameState.inventory['iron_ore'] >= 5);
            workbenchBtn.disabled = !(gameState.inventory['wood'] >= 30 && gameState.inventory['iron_ore'] >= 10);
        }
        
        // å‡çº§åº‡æŠ¤æ‰€
        function upgradeShelter() {
            if (gameState.inventory['wood'] >= 20 && gameState.inventory['rope'] >= 5) {
                gameState.inventory['wood'] -= 20;
                gameState.inventory['rope'] -= 5;
                gameState.shelterLevel++;
                
                addToLog(`åº‡æŠ¤æ‰€å‡çº§åˆ°${gameState.shelterLevel}çº§!`, "success");
                playSound('success');
                
                // æ›´æ–°åº“å­˜å’ŒåŸºåœ°æ˜¾ç¤º
                renderInventory();
                renderBase();
            } else {
                addToLog("å‡çº§éœ€è¦20ä¸ªæœ¨æå’Œ5ä¸ªç»³å­", "warning");
                playSound('failure');
            }
        }
        
        // å‡çº§å‚¨ç‰©ç®±
        function upgradeStorage() {
            if (gameState.inventory['wood'] >= 15 && gameState.inventory['iron_ore'] >= 5) {
                gameState.inventory['wood'] -= 15;
                gameState.inventory['iron_ore'] -= 5;
                gameState.storageLevel++;
                gameState.inventoryMax += 5;
                
                addToLog(`å‚¨ç‰©ç®±å‡çº§åˆ°${gameState.storageLevel}çº§! åº“å­˜ä¸Šé™å¢åŠ 5`, "success");
                playSound('success');
                
                // æ›´æ–°åº“å­˜å’ŒåŸºåœ°æ˜¾ç¤º
                renderInventory();
                renderBase();
            } else {
                addToLog("å‡çº§éœ€è¦15ä¸ªæœ¨æå’Œ5ä¸ªé“çŸ¿çŸ³", "warning");
                playSound('failure');
            }
        }
        
        // å‡çº§å·¥ä½œå°
        function upgradeWorkbench() {
            if (gameState.inventory['wood'] >= 30 && gameState.inventory['iron_ore'] >= 10) {
                gameState.inventory['wood'] -= 30;
                gameState.inventory['iron_ore'] -= 10;
                gameState.workbenchLevel++;
                
                addToLog(`å·¥ä½œå°å‡çº§åˆ°${gameState.workbenchLevel}çº§! è§£é”æ›´å¤šåˆ¶ä½œé…æ–¹`, "success");
                playSound('success');
                
                // è§£é”æ–°é…æ–¹
                if (gameState.workbenchLevel === 1) {
                    gameState.unlockedRecipes.push('fishing_rod', 'trap');
                    addToLog("è§£é”æ–°é…æ–¹: é±¼ç«¿, é™·é˜±", "info");
                } else if (gameState.workbenchLevel === 2) {
                    gameState.unlockedRecipes.push('bow', 'arrow');
                    addToLog("è§£é”æ–°é…æ–¹: å¼“ç®­, ç®­", "info");
                } else if (gameState.workbenchLevel === 3) {
                    gameState.unlockedRecipes.push('medicine', 'armor');
                    addToLog("è§£é”æ–°é…æ–¹: è¯è†, çš®ç”²", "info");
                }
                
                // æ›´æ–°åº“å­˜å’ŒåŸºåœ°æ˜¾ç¤º
                renderInventory();
                renderBase();
                renderCraftingList();
            } else {
                addToLog("å‡çº§éœ€è¦30ä¸ªæœ¨æå’Œ10ä¸ªé“çŸ¿çŸ³", "warning");
                playSound('failure');
            }
        }
        
        // æ˜¾ç¤ºé€šçŸ¥
        function showNotification(message) {
            elements.notification.textContent = message;
            elements.notification.style.display = 'block';
            
            setTimeout(() => {
                elements.notification.style.display = 'none';
            }, 3000);
        }
        
        // æ›´æ–°UIæ˜¾ç¤º
        function updateUI() {
            elements.healthValue.textContent = Math.floor(gameState.health);
            elements.hungerValue.textContent = Math.floor(gameState.hunger);
            elements.thirstValue.textContent = Math.floor(gameState.thirst);
            elements.energyValue.textContent = Math.floor(gameState.energy);
            elements.tempValue.textContent = gameState.temperature.toFixed(1);
            elements.dayCount.textContent = gameState.day;
            
            // æ›´æ–°å±é™©çŠ¶æ€é¢œè‰²
            if (gameState.health < 30) elements.healthValue.className = 'stat-value danger';
            else if (gameState.health < 60) elements.healthValue.className = 'stat-value warning';
            else elements.healthValue.className = 'stat-value';
            
            if (gameState.hunger < 30) elements.hungerValue.className = 'stat-value danger';
            else if (gameState.hunger < 60) elements.hungerValue.className = 'stat-value warning';
            else elements.hungerValue.className = 'stat-value';
            
            if (gameState.thirst < 30) elements.thirstValue.className = 'stat-value danger';
            else if (gameState.thirst < 60) elements.thirstValue.className = 'stat-value warning';
            else elements.thirstValue.className = 'stat-value';
            
            if (gameState.energy < 30) elements.energyValue.className = 'stat-value danger';
            else if (gameState.energy < 60) elements.energyValue.className = 'stat-value warning';
            else elements.energyValue.className = 'stat-value';
            
            if (gameState.temperature < 35 || gameState.temperature > 39) elements.tempValue.className = 'stat-value danger';
            else if (gameState.temperature < 36 || gameState.temperature > 38) elements.tempValue.className = 'stat-value warning';
            else elements.tempValue.className = 'stat-value';
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            elements.gatherBtn.disabled = gameState.currentAction !== null || gameState.inCombat;
            elements.huntBtn.disabled = gameState.currentAction !== null || gameState.inCombat;
            elements.exploreBtn.disabled = gameState.currentAction !== null || gameState.inCombat;
            elements.restBtn.disabled = gameState.currentAction !== null || gameState.inCombat;
            elements.drinkBtn.disabled = gameState.currentAction !== null || gameState.inCombat || gameState.inventory['water'] <= 0;
            elements.eatBtn.disabled = gameState.currentAction !== null || gameState.inCombat || 
                                      (gameState.inventory['berries'] <= 0 && 
                                       gameState.inventory['meat_cooked'] <= 0 && 
                                       gameState.inventory['meat_raw'] <= 0);
            elements.buildBtn.disabled = gameState.currentAction !== null || gameState.inCombat;
            elements.fireBtn.disabled = gameState.currentAction !== null || gameState.inCombat || gameState.fire;
            elements.mapBtn.disabled = gameState.currentAction !== null || gameState.inCombat;
            elements.skillsBtn.disabled = gameState.currentAction !== null || gameState.inCombat;
            elements.questsBtn.disabled = gameState.currentAction !== null || gameState.inCombat;
            elements.baseBtn.disabled = gameState.currentAction !== null || gameState.inCombat;
            
            // æ›´æ–°åˆ¶ä½œæŒ‰é’®çŠ¶æ€
            elements.craftingBtn.disabled = gameState.currentAction !== null || gameState.inCombat;
        }
        
        // æ›´æ–°æ—¶é—´æ˜¾ç¤º
        function updateTimeDisplay() {
            const hourStr = gameState.hour.toString().padStart(2, '0');
            const minuteStr = gameState.minute.toString().padStart(2, '0');
            elements.hourDisplay.textContent = `${hourStr}:${minuteStr}`;
            
            let timeOfDay = '';
            if (gameState.hour >= 5 && gameState.hour < 8) {
                timeOfDay = 'æ¸…æ™¨';
            } else if (gameState.hour >= 8 && gameState.hour < 12) {
                timeOfDay = 'ä¸Šåˆ';
            } else if (gameState.hour >= 12 && gameState.hour < 14) {
                timeOfDay = 'ä¸­åˆ';
            } else if (gameState.hour >= 14 && gameState.hour < 18) {
                timeOfDay = 'ä¸‹åˆ';
            } else if (gameState.hour >= 18 && gameState.hour < 20) {
                timeOfDay = 'å‚æ™š';
            } else if (gameState.hour >= 20 || gameState.hour < 5) {
                timeOfDay = 'å¤œæ™š';
            }
            
            elements.timeText.textContent = timeOfDay;
            
            // æ›´æ–°èƒŒæ™¯é¢œè‰²
            if (gameState.isDay) {
                document.body.classList.remove('night-mode');
            } else {
                document.body.classList.add('night-mode');
            }
        }
        
        // æ›´æ–°åœ°ç‚¹å›¾ç‰‡
        function updateLocationImage() {
            const location = locations[gameState.location];
            elements.locationImage.style.backgroundImage = `url('${location.image}')`;
            
            // åº”ç”¨å¤©æ°”æ•ˆæœ
            updateWeather();
        }
        
        // æ·»åŠ æ—¥å¿—æ¡ç›®
        function addToLog(text, type = 'info') {
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${getTimeString()}] ${text}`;
            elements.eventLog.appendChild(entry);
            elements.eventLog.scrollTop = elements.eventLog.scrollHeight;
        }
        
        // è·å–æ—¶é—´å­—ç¬¦ä¸²
        function getTimeString() {
            const hourStr = gameState.hour.toString().padStart(2, '0');
            const minuteStr = gameState.minute.toString().padStart(2, '0');
            return `${hourStr}:${minuteStr}`;
        }
        
        // æ’­æ”¾éŸ³æ•ˆ
        function playSound(type) {
            if (!gameState.soundEnabled) return;
            
            try {
                switch (type) {
                    case 'click':
                        elements.clickSound.currentTime = 0;
                        elements.clickSound.play();
                        break;
                    case 'success':
                        elements.successSound.currentTime = 0;
                        elements.successSound.play();
                        break;
                    case 'failure':
                        elements.failureSound.currentTime = 0;
                        elements.failureSound.play();
                        break;
                    case 'danger':
                        elements.dangerSound.currentTime = 0;
                        elements.dangerSound.play();
                        break;
                    case 'combat':
                        elements.combatSound.currentTime = 0;
                        elements.combatSound.play();
                        break;
                }
            } catch (e) {
                console.log("éŸ³æ•ˆæ’­æ”¾é”™è¯¯:", e);
            }
        }
        
        // åˆ‡æ¢éŸ³ä¹
        function toggleMusic() {
            gameState.musicEnabled = !gameState.musicEnabled;
            
            if (gameState.musicEnabled) {
                updateBackgroundMusic();
                elements.musicBtn.textContent = 'ğŸµ';
            } else {
                if (gameState.currentMusic) {
                    fadeOutAudio(gameState.currentMusic);
                }
                elements.musicBtn.textContent = 'ğŸ”‡';
            }
            
            playSound('click');
        }
        
        // åˆ‡æ¢éŸ³æ•ˆ
        function toggleSound() {
            gameState.soundEnabled = !gameState.soundEnabled;
            
            if (gameState.soundEnabled) {
                elements.natureSound.play().catch(e => console.log("è‡ªç„¶éŸ³æ•ˆæ’­æ”¾è¢«é˜»æ­¢:", e));
                elements.soundBtn.textContent = 'ğŸ”Š';
            } else {
                elements.natureSound.pause();
                elements.soundBtn.textContent = 'ğŸ”‡';
            }
            
            playSound('click');
        }
        
        // åˆ‡æ¢å¤œé—´æ¨¡å¼
        function toggleNightMode() {
            gameState.nightMode = !gameState.nightMode;
            
            if (gameState.nightMode) {
                document.body.classList.add('night-mode');
                elements.nightBtn.textContent = 'â˜€ï¸';
            } else {
                document.body.classList.remove('night-mode');
                elements.nightBtn.textContent = 'ğŸŒ™';
            }
            
            playSound('click');
        }
        
        // ä¿å­˜æ¸¸æˆ
        function saveGame() {
            try {
                localStorage.setItem('survivalGameSave', JSON.stringify(gameState));
                return true;
            } catch (e) {
                console.log("ä¿å­˜å¤±è´¥:", e);
                return false;
            }
        }
        
        // åŠ è½½æ¸¸æˆ
        function loadGame() {
            try {
                const saveData = localStorage.getItem('survivalGameSave');
                if (saveData) {
                    const savedState = JSON.parse(saveData);
                    
                    // ä¿ç•™éŸ³é¢‘è®¾ç½®
                    const musicEnabled = gameState.musicEnabled;
                    const soundEnabled = gameState.soundEnabled;
                    const nightMode = gameState.nightMode;
                    
                    // åˆå¹¶çŠ¶æ€
                    Object.assign(gameState, savedState);
                    
                    // æ¢å¤è®¾ç½®
                    gameState.musicEnabled = musicEnabled;
                    gameState.soundEnabled = soundEnabled;
                    gameState.nightMode = nightMode;
                    
                    // æ›´æ–°UI
                    updateUI();
                    renderInventory();
                    updateTimeDisplay();
                    updateLocationImage();
                    updateWeather();
                    renderMap();
                    renderSkills();
                    renderQuests();
                    renderBase();
                    
                    // æ›´æ–°éŸ³ä¹
                    updateBackgroundMusic();
                    
                    return true;
                }
            } catch (e) {
                console.log("åŠ è½½å¤±è´¥:", e);
            }
            
            return false;
        }
        
        // å¯åŠ¨æ¸¸æˆ
        window.onload = initGame;
    </script>
</body>
</html>
